(()=>{"use strict";var e={n:r=>{var t=r&&r.__esModule?()=>r.default:()=>r;return e.d(t,{a:t}),t},d:(r,t)=>{for(var o in t)e.o(t,o)&&!e.o(r,o)&&Object.defineProperty(r,o,{enumerable:!0,get:t[o]})},o:(e,r)=>Object.prototype.hasOwnProperty.call(e,r)};const r=window.wp.hooks,t=window.wp.i18n;class o{static ID="cloudflare-r2-blueprint-bundle";static NAME=(0,t.__)("Cloudflare R2","aether-site-exporter-providers");static TYPE="cloud-storage";static DESCRIPTION=(0,t.__)("Cloudflare R2 object storage for WordPress Playground blueprint bundles with zero egress fees.","aether-site-exporter-providers");static ICON="☁️";static DEPLOYMENT_TYPE="blueprint_bundle";static CONFIG_FIELDS=[{id:"account_id",label:(0,t.__)("Cloudflare Account ID","aether-site-exporter-providers"),type:"text",required:!0,sensitive:!0,validation:{pattern:"^[a-f0-9]{32}$",message:(0,t.__)("Account ID must be a 32-character hexadecimal string","aether-site-exporter-providers")}},{id:"api_token",label:(0,t.__)("Cloudflare API Token","aether-site-exporter-providers"),type:"text",required:!0,sensitive:!0,validation:{minLength:20,message:(0,t.__)("API Token must be at least 20 characters","aether-site-exporter-providers")}},{id:"bucket_name",label:(0,t.__)("Bucket Name","aether-site-exporter-providers"),type:"text",required:!0,sensitive:!1,validation:{pattern:"^[a-z0-9][a-z0-9-]{1,61}[a-z0-9]$",minLength:3,maxLength:63,message:(0,t.__)("Bucket name must be 3-63 characters, start and end with alphanumeric, and contain only lowercase letters, numbers, and hyphens","aether-site-exporter-providers")}},{id:"worker_endpoint",label:(0,t.__)("Worker Endpoint URL","aether-site-exporter-providers"),type:"url",required:!1,sensitive:!1,help:(0,t.__)("URL of the deployed Cloudflare Worker. Use the Deploy Worker button below to create one.","aether-site-exporter-providers")},{id:"access_key_id",label:(0,t.__)("R2 Access Key ID","aether-site-exporter-providers"),type:"text",required:!1,sensitive:!0,help:(0,t.__)("Only required for S3-compatible API access, not for Worker-based uploads.","aether-site-exporter-providers"),validation:{minLength:16,maxLength:128,message:(0,t.__)("Access Key ID must be between 16 and 128 characters","aether-site-exporter-providers")}},{id:"secret_access_key",label:(0,t.__)("R2 Secret Access Key","aether-site-exporter-providers"),type:"text",required:!1,sensitive:!0,help:(0,t.__)("Only required for S3-compatible API access, not for Worker-based uploads.","aether-site-exporter-providers"),validation:{minLength:32,maxLength:128,message:(0,t.__)("Secret Access Key must be between 32 and 128 characters","aether-site-exporter-providers")}},{id:"bundle_path",label:(0,t.__)("Bundle Path","aether-site-exporter-providers"),type:"text",required:!1,sensitive:!1,placeholder:"blueprint-bundle/bundle.zip",help:(0,t.__)("Path within the bucket for the blueprint bundle ZIP file","aether-site-exporter-providers")},{id:"public_url",label:(0,t.__)("Custom Domain (Optional)","aether-site-exporter-providers"),type:"url",required:!1,sensitive:!1,isAdvanced:!0}]}const i=window.wp.element,s=window.wp.components,n=window.wp.apiFetch;var a=e.n(n);const d=new Map;function l(e){return`${e.method||"GET"}:${e.path||""}:${e.data?JSON.stringify(e.data):""}`}const c=(e,r)=>{const t=l(e);if(d.has(t))return d.get(t);const o=r(e);return d.set(t,o),o.finally(()=>{d.delete(t)}),o},p=new Map,u={"/assets":6e5,"/settings":6e4,"/config":18e5,"/check-wporg":36e5};const h=(e,r)=>{if("GET"!==(e.method||"GET"))return r(e);const t=l(e),o=p.get(t);if(function(e,r){if(!e)return!1;const t=function(e){for(const[r,t]of Object.entries(u))if(e&&e.includes(r))return t;return 3e5}(r);return 0!==t&&Date.now()-e.timestamp<t}(o,e.path))return Promise.resolve(o.response);const i=r(e);return i.then(e=>(p.set(t,{response:e,timestamp:Date.now()}),e)).catch(e=>{throw e}),i};!function(){const e="undefined"!=typeof window&&window.aetherData&&window.aetherData.restUrl?window.aetherData.restUrl:"/wp-json/",r="undefined"!=typeof window&&window.aetherData&&window.aetherData.nonce?window.aetherData.nonce:"";a().use(a().createRootURLMiddleware(e)),r&&function(e){a().use(a().createNonceMiddleware(e))}(r),a().use(h),a().use(c)}();const m=a(),y={title:(0,t.__)("Required API Token Permissions","aether-site-exporter-providers"),sections:[{title:(0,t.__)("R2 Storage","aether-site-exporter-providers"),items:[{permission:"R2: Edit",description:(0,t.__)("Read and write files to R2 bucket","aether-site-exporter-providers")}]},{title:(0,t.__)("Workers (for deployment)","aether-site-exporter-providers"),items:[{permission:"Workers Scripts: Edit",description:(0,t.__)("Deploy and update Workers","aether-site-exporter-providers")},{permission:"Workers Routes: Edit",description:(0,t.__)("Attach custom domains to Workers","aether-site-exporter-providers")}]},{title:(0,t.__)("DNS (for custom domains)","aether-site-exporter-providers"),items:[{permission:"Zone: Read",description:(0,t.__)("Look up zone IDs for custom domains","aether-site-exporter-providers")}]}],createTokenUrl:"https://dash.cloudflare.com/profile/api-tokens"},x={title:(0,t.__)("Manual Worker Deployment","aether-site-exporter-providers"),steps:[(0,t.__)("Go to Cloudflare Dashboard > Workers & Pages","aether-site-exporter-providers"),(0,t.__)('Click "Create" and select "Create Worker"',"aether-site-exporter-providers"),(0,t.__)('Name your worker (e.g., "my-r2-static-site")',"aether-site-exporter-providers"),(0,t.__)("Go to Settings > Variables > R2 Bucket Bindings","aether-site-exporter-providers"),(0,t.__)('Add binding: Variable name "R2_BUCKET", select your bucket',"aether-site-exporter-providers"),(0,t.__)("Deploy the worker and copy the URL","aether-site-exporter-providers")],workersUrl:"https://dash.cloudflare.com/?to=/:account/workers-and-pages"},f={title:(0,t.__)("Manual Domain Attachment","aether-site-exporter-providers"),steps:[(0,t.__)("Go to Cloudflare Dashboard > Workers & Pages","aether-site-exporter-providers"),(0,t.__)("Select your worker","aether-site-exporter-providers"),(0,t.__)("Go to Settings > Triggers > Custom Domains","aether-site-exporter-providers"),(0,t.__)('Click "Add Custom Domain"',"aether-site-exporter-providers"),(0,t.__)("Enter your domain and confirm","aether-site-exporter-providers")],note:(0,t.__)("Ensure the domain is on the same Cloudflare account and proxied through Cloudflare (orange cloud).","aether-site-exporter-providers"),docsUrl:"https://developers.cloudflare.com/workers/configuration/routing/custom-domains/"},_="https://developers.cloudflare.com/workers/runtime-apis/bindings/",g=window.ReactJSXRuntime;function w(){const[e,r]=(0,i.useState)(!1),o={margin:"0.5rem 0 0.75rem",paddingLeft:"1.5rem"},n={marginBottom:"0.25rem"};return(0,g.jsxs)("div",{style:{marginBottom:"1rem",padding:"0.75rem 1rem",backgroundColor:"#f0f6fc",borderLeft:"4px solid #2271b1",borderRadius:"2px"},children:[(0,g.jsxs)("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",margin:0},children:[(0,g.jsx)("strong",{children:(0,t.__)("Before you begin","aether-site-exporter-providers")}),(0,g.jsx)(s.Button,{variant:"link",onClick:()=>r(!e),style:{padding:0,height:"auto",minHeight:"auto"},"aria-expanded":e,children:e?(0,t.__)("Hide details","aether-site-exporter-providers"):(0,t.__)("Show details","aether-site-exporter-providers")})]}),!e&&(0,g.jsxs)("p",{style:{margin:"0.5rem 0 0",fontSize:"13px"},children:[(0,t.__)("You need a Cloudflare API token with R2, Workers, and Zone permissions.","aether-site-exporter-providers")," ",(0,g.jsx)(s.ExternalLink,{href:y.createTokenUrl,children:(0,t.__)("Create API Token","aether-site-exporter-providers")})]}),e&&(0,g.jsxs)("div",{style:{marginTop:"0.75rem",fontSize:"13px",lineHeight:"1.6"},children:[(0,g.jsx)("p",{style:{margin:"0 0 0.5rem"},children:(0,t.__)("Create a Cloudflare API token with these permissions:","aether-site-exporter-providers")}),y.sections.map((e,r)=>(0,g.jsxs)("div",{style:{marginBottom:"0.5rem"},children:[(0,g.jsx)("strong",{style:{fontSize:"12px",color:"#50575e"},children:e.title}),(0,g.jsx)("ul",{style:o,children:e.items.map((e,r)=>(0,g.jsxs)("li",{style:n,children:[(0,g.jsx)("code",{children:e.permission})," - ",e.description]},r))})]},r)),(0,g.jsx)("p",{style:{margin:0},children:(0,g.jsx)(s.ExternalLink,{href:y.createTokenUrl,children:(0,t.__)("Create API Token in Cloudflare Dashboard","aether-site-exporter-providers")})})]})]})}function v(){const[e,r]=(0,i.useState)(!1),o={marginBottom:"0.35rem"};return(0,g.jsxs)("div",{style:{marginTop:"0.5rem"},children:[(0,g.jsx)(s.Button,{variant:"link",onClick:()=>r(!e),style:{padding:0,height:"auto",minHeight:"auto",fontSize:"12px"},"aria-expanded":e,children:e?(0,t.__)("Hide token creation steps","aether-site-exporter-providers"):(0,t.__)("How to create an API token","aether-site-exporter-providers")}),e&&(0,g.jsxs)("div",{style:{marginTop:"0.5rem",padding:"0.75rem",backgroundColor:"#f6f7f7",borderRadius:"4px",fontSize:"12px",lineHeight:"1.6"},children:[(0,g.jsxs)("ol",{style:{margin:"0.5rem 0",paddingLeft:"1.25rem"},children:[(0,g.jsx)("li",{style:o,children:(0,t.__)("Go to Cloudflare Dashboard > My Profile > API Tokens","aether-site-exporter-providers")}),(0,g.jsx)("li",{style:o,children:(0,t.__)('Click "Create Token"',"aether-site-exporter-providers")}),(0,g.jsx)("li",{style:o,children:(0,t.__)('Select "Create Custom Token"',"aether-site-exporter-providers")}),(0,g.jsxs)("li",{style:o,children:[(0,t.__)("Add these permissions:","aether-site-exporter-providers"),(0,g.jsxs)("ul",{style:{marginTop:"0.25rem",marginBottom:"0.25rem",paddingLeft:"1.25rem",listStyleType:"disc"},children:[(0,g.jsx)("li",{children:"Account > Workers Scripts > Edit"}),(0,g.jsx)("li",{children:"Account > Workers Routes > Edit"}),(0,g.jsx)("li",{children:"Zone > Zone > Read (select your zones)"})]})]}),(0,g.jsx)("li",{style:o,children:(0,t.__)("Create the token and copy it here","aether-site-exporter-providers")})]}),(0,g.jsx)(s.ExternalLink,{href:"https://developers.cloudflare.com/fundamentals/api/get-started/create-token/",children:(0,t.__)("View Cloudflare Documentation","aether-site-exporter-providers")})]})]})}function k({errorType:e,hostname:r}){const[o,n]=(0,i.useState)(!1),a={marginTop:"0.5rem"},d={padding:0,height:"auto",minHeight:"auto",fontSize:"12px",color:"#2271b1"},l={marginTop:"0.5rem",padding:"0.75rem",backgroundColor:"#fff8e5",borderRadius:"4px",fontSize:"12px",lineHeight:"1.6"},c={margin:"0.5rem 0",paddingLeft:"1.25rem"},p={marginBottom:"0.35rem"};return"worker_deployment"===e?(0,g.jsxs)("div",{style:a,children:[(0,g.jsx)(s.Button,{variant:"link",onClick:()=>n(!o),style:d,"aria-expanded":o,children:o?(0,t.__)("Hide manual instructions","aether-site-exporter-providers"):(0,t.__)("How to deploy manually","aether-site-exporter-providers")}),o&&(0,g.jsxs)("div",{style:l,children:[(0,g.jsx)("p",{style:{margin:"0 0 0.5rem"},children:(0,t.__)("If automatic deployment fails, you can deploy the worker manually:","aether-site-exporter-providers")}),(0,g.jsx)("ol",{style:c,children:x.steps.map((e,r)=>(0,g.jsx)("li",{style:p,children:e},r))}),(0,g.jsx)(s.ExternalLink,{href:x.workersUrl,children:(0,t.__)("Open Workers & Pages","aether-site-exporter-providers")})," | ",(0,g.jsx)(s.ExternalLink,{href:_,children:(0,t.__)("View Bindings Documentation","aether-site-exporter-providers")})]})]}):"domain_attachment"===e?(0,g.jsxs)("div",{style:a,children:[(0,g.jsx)(s.Button,{variant:"link",onClick:()=>n(!o),style:d,"aria-expanded":o,children:o?(0,t.__)("Hide manual instructions","aether-site-exporter-providers"):(0,t.__)("How to attach domain manually","aether-site-exporter-providers")}),o&&(0,g.jsxs)("div",{style:l,children:[(0,g.jsx)("p",{style:{margin:"0 0 0.5rem"},children:(0,t.__)("If custom domain attachment fails, configure it manually:","aether-site-exporter-providers")}),(0,g.jsx)("ol",{style:c,children:f.steps.map((e,t)=>(0,g.jsx)("li",{style:p,children:4===t&&r?`${e}: ${r}`:e},t))}),(0,g.jsx)("p",{style:{marginTop:"0.5rem",fontStyle:"italic",color:"#50575e"},children:f.note}),(0,g.jsx)(s.ExternalLink,{href:f.docsUrl,children:(0,t.__)("View Custom Domains Documentation","aether-site-exporter-providers")})]})]}):null}function b({isOpen:e,onClose:r,bucketName:o}){const[n,a]=(0,i.useState)(!1),[d,l]=(0,i.useState)(""),[c,p]=(0,i.useState)(!1),[u,h]=(0,i.useState)(null);if((0,i.useEffect)(()=>{e&&!d&&(async()=>{p(!0),h(null);try{const e=window.aetherSepPluginUrl||"";if(!e)throw new Error("Plugin URL not available");const r=await fetch(e+"assets/workers/CloudflareR2Worker.js");if(!r.ok)throw new Error(`Failed to fetch worker code: ${r.status}`);const t=await r.text();l(t)}catch(e){h(e.message)}finally{p(!1)}})()},[e,d]),!e)return null;const m={marginBottom:"1.5rem"},y={fontSize:"1rem",fontWeight:"600",marginBottom:"0.5rem",marginTop:0},x={margin:"0.5rem 0",paddingLeft:"1.5rem"},f={marginBottom:"0.5rem",lineHeight:"1.6"};return(0,g.jsx)(s.Modal,{title:(0,t.__)("Manual Worker Setup Instructions","aether-site-exporter-providers"),onRequestClose:r,style:{maxWidth:"800px",width:"90vw"},className:"aether-manual-worker-modal",children:(0,g.jsxs)("div",{className:"aether-manual-worker-modal__content",children:[(0,g.jsxs)("div",{style:m,children:[(0,g.jsx)("h3",{style:y,children:(0,t.__)("Step 1: Create a Worker","aether-site-exporter-providers")}),(0,g.jsxs)("ol",{style:x,children:[(0,g.jsxs)("li",{style:f,children:[(0,t.__)("Go to","aether-site-exporter-providers")," ",(0,g.jsx)("a",{href:"https://dash.cloudflare.com/?to=/:account/workers-and-pages",target:"_blank",rel:"noopener noreferrer",children:"Cloudflare Dashboard > Workers & Pages"})]}),(0,g.jsx)("li",{style:f,children:(0,t.__)('Click "Create" and select "Create Worker"',"aether-site-exporter-providers")}),(0,g.jsx)("li",{style:f,children:(0,t.__)('Name your worker (e.g., "aether-r2-mysite")',"aether-site-exporter-providers")}),(0,g.jsx)("li",{style:f,children:(0,t.__)('Click "Deploy" to create the worker with default code',"aether-site-exporter-providers")})]})]}),(0,g.jsxs)("div",{style:m,children:[(0,g.jsx)("h3",{style:y,children:(0,t.__)("Step 2: Add R2 Bucket Binding","aether-site-exporter-providers")}),(0,g.jsxs)("ol",{style:x,children:[(0,g.jsx)("li",{style:f,children:(0,t.__)("In your worker, go to Settings > Variables","aether-site-exporter-providers")}),(0,g.jsx)("li",{style:f,children:(0,t.__)('Scroll down to "R2 Bucket Bindings"',"aether-site-exporter-providers")}),(0,g.jsx)("li",{style:f,children:(0,t.__)('Click "Add binding"',"aether-site-exporter-providers")}),(0,g.jsxs)("li",{style:f,children:[(0,g.jsx)("strong",{children:(0,t.__)("Variable name:","aether-site-exporter-providers")})," ",(0,g.jsx)("code",{children:"R2_BUCKET"})," ",(0,t.__)("(must be exactly this name)","aether-site-exporter-providers")]}),(0,g.jsxs)("li",{style:f,children:[(0,g.jsx)("strong",{children:(0,t.__)("R2 bucket:","aether-site-exporter-providers")})," ",o?(0,g.jsxs)(g.Fragment,{children:[(0,t.__)("Select","aether-site-exporter-providers")," ",(0,g.jsx)("code",{children:o})]}):(0,t.__)("Select your R2 bucket","aether-site-exporter-providers")]}),(0,g.jsx)("li",{style:f,children:(0,t.__)('Click "Save" to save the binding',"aether-site-exporter-providers")})]})]}),(0,g.jsxs)("div",{style:m,children:[(0,g.jsx)("h3",{style:y,children:(0,t.__)("Step 3: Replace Worker Code","aether-site-exporter-providers")}),(0,g.jsxs)("ol",{style:x,children:[(0,g.jsx)("li",{style:f,children:(0,t.__)('Go to your worker\'s "Code" tab',"aether-site-exporter-providers")}),(0,g.jsx)("li",{style:f,children:(0,t.__)("Delete all existing code","aether-site-exporter-providers")}),(0,g.jsx)("li",{style:f,children:(0,t.__)("Paste the code below:","aether-site-exporter-providers")})]}),(0,g.jsxs)("div",{style:{position:"relative",marginTop:"0.5rem"},children:[c&&(0,g.jsxs)("div",{style:{display:"flex",alignItems:"center",justifyContent:"center",padding:"2rem",gap:"0.5rem"},children:[(0,g.jsx)(s.Spinner,{}),(0,g.jsx)("span",{children:(0,t.__)("Loading worker code...","aether-site-exporter-providers")})]}),u&&(0,g.jsx)(s.Notice,{status:"error",isDismissible:!1,children:u}),!c&&!u&&d&&(0,g.jsxs)(g.Fragment,{children:[(0,g.jsx)("div",{style:{display:"flex",justifyContent:"flex-end",marginBottom:"0.5rem"},children:(0,g.jsx)(s.Button,{variant:"secondary",onClick:async()=>{if(d)try{await navigator.clipboard.writeText(d),a(!0),setTimeout(()=>a(!1),3e3)}catch{const e=document.createElement("textarea");e.value=d,document.body.appendChild(e),e.select(),document.execCommand("copy"),document.body.removeChild(e),a(!0),setTimeout(()=>a(!1),3e3)}},disabled:n,children:n?(0,t.__)("Copied!","aether-site-exporter-providers"):(0,t.__)("Copy Code","aether-site-exporter-providers")})}),(0,g.jsx)(s.TextareaControl,{value:d,readOnly:!0,rows:15,style:{fontFamily:"monospace",fontSize:"12px",backgroundColor:"#1e1e1e",color:"#d4d4d4"}})]})]})]}),(0,g.jsxs)("div",{style:m,children:[(0,g.jsx)("h3",{style:y,children:(0,t.__)("Step 4: Deploy and Copy URL","aether-site-exporter-providers")}),(0,g.jsxs)("ol",{style:x,children:[(0,g.jsx)("li",{style:f,children:(0,t.__)('Click "Save and Deploy" to deploy your worker',"aether-site-exporter-providers")}),(0,g.jsx)("li",{style:f,children:(0,t.__)("Copy the worker URL (e.g., https://aether-r2-mysite.your-subdomain.workers.dev)","aether-site-exporter-providers")}),(0,g.jsx)("li",{style:f,children:(0,t.__)('Paste it in the "Worker Endpoint URL" field in this form',"aether-site-exporter-providers")})]})]}),(0,g.jsxs)(s.Notice,{status:"info",isDismissible:!1,children:[(0,g.jsx)("strong",{children:(0,t.__)("Important:","aether-site-exporter-providers")})," ",(0,t.__)('The R2 bucket binding variable name MUST be exactly "R2_BUCKET" (case-sensitive). The worker will not work without this binding.',"aether-site-exporter-providers")]}),(0,g.jsxs)("div",{style:{backgroundColor:"#f0f6fc",padding:"0.75rem 1rem",borderLeft:"4px solid #2271b1",borderRadius:"2px",marginTop:"1rem",fontSize:"0.875rem"},children:[(0,g.jsx)("strong",{children:(0,t.__)("Need more help?","aether-site-exporter-providers")}),(0,g.jsx)("br",{}),(0,g.jsx)("a",{href:_,target:"_blank",rel:"noopener noreferrer",children:(0,t.__)("R2 Bucket Bindings Documentation","aether-site-exporter-providers")})," | ",(0,g.jsx)("a",{href:"https://developers.cloudflare.com/r2/",target:"_blank",rel:"noopener noreferrer",children:(0,t.__)("R2 Overview","aether-site-exporter-providers")})]}),(0,g.jsx)("div",{style:{marginTop:"1.5rem",display:"flex",justifyContent:"flex-end"},children:(0,g.jsx)(s.Button,{variant:"primary",onClick:r,children:(0,t.__)("Close","aether-site-exporter-providers")})})]})})}function j({providerId:e,config:r,onChange:o}){const[n,a]=(0,i.useState)(!1),[d,l]=(0,i.useState)(null),[c,p]=(0,i.useState)(!1),[u,h]=(0,i.useState)(null),[y,x]=(0,i.useState)(!1);return(0,g.jsxs)("div",{style:{marginTop:"1rem",paddingTop:"1rem",borderTop:"1px solid #ddd"},children:[(0,g.jsxs)("div",{style:{display:"flex",gap:"0.5rem",alignItems:"center"},children:[(0,g.jsx)(s.Button,{variant:"secondary",onClick:async()=>{a(!0),l(null),p(!1),h(null);try{if(!r?.account_id||!r?.api_token||!r?.bucket_name)throw new Error((0,t.__)("Cloudflare Account ID, API Token, and Bucket Name are required to deploy the worker","aether-site-exporter-providers"));const i=(window.aetherData?.restUrl||window.wpApiSettings?.root||"/wp-json").replace(/\/$/,""),s=window.aetherData?.nonce||window.wpApiSettings?.nonce||"",n=`aether-r2-${Math.random().toString(36).substring(2,10)}`,a={};r.bucket_name&&(a.R2_BUCKET={type:"r2_bucket",bucket_name:r.bucket_name});const d=`${i}/aether/site-exporter/providers/cloudflare/deploy-worker`,l=await fetch(d,{method:"POST",headers:{"X-WP-Nonce":s,"Content-Type":"application/json"},body:JSON.stringify({worker_type:"r2",worker_name:n,bindings:a,account_id:r.account_id,api_token:r.api_token})});if(!l.ok){const e=await l.json().catch(()=>({message:`HTTP ${l.status}: ${l.statusText}`}));throw new Error(e.message||e.error||(0,t.__)("Failed to deploy worker","aether-site-exporter-providers"))}const c=await l.json();if(!c.success)throw new Error(c.message||c.error||(0,t.__)("Failed to deploy worker","aether-site-exporter-providers"));if(c.worker_url){o&&"function"==typeof o&&o("worker_endpoint",c.worker_url);try{const r=await m({path:`/aether/site-exporter/providers/${e}/config`,method:"GET"}),t=r?.config||{};await m({path:`/aether/site-exporter/providers/${e}/config`,method:"POST",data:{config:{...t,worker_endpoint:c.worker_url}}})}catch{}}p(!0),h(c.worker_url||null),setTimeout(()=>{p(!1)},1e4)}catch(e){l(e.message||(0,t.__)("Failed to deploy worker","aether-site-exporter-providers"))}finally{a(!1)}},isBusy:n,disabled:n||!r?.account_id||!r?.api_token||!r?.bucket_name,children:n?(0,t.__)("Deploying…","aether-site-exporter-providers"):(0,t.__)("Deploy Worker","aether-site-exporter-providers")}),(0,g.jsx)(s.Button,{variant:"tertiary",onClick:()=>x(!0),children:(0,t.__)("Manual Setup","aether-site-exporter-providers")})]}),d&&(0,g.jsxs)(g.Fragment,{children:[(0,g.jsx)(s.Notice,{status:"error",isDismissible:!1,style:{marginTop:"0.5rem"},children:d}),(0,g.jsx)(k,{errorType:"worker_deployment"})]}),c&&(0,g.jsxs)(s.Notice,{status:"success",isDismissible:!1,style:{marginTop:"0.5rem"},children:[(0,t.__)("Worker deployed successfully!","aether-site-exporter-providers"),u&&(0,g.jsxs)("div",{style:{marginTop:"0.5rem"},children:[(0,g.jsx)("strong",{children:(0,t.__)("Worker URL:","aether-site-exporter-providers")})," ",(0,g.jsx)("a",{href:u,target:"_blank",rel:"noopener noreferrer",children:u})]})]}),(0,g.jsx)(b,{isOpen:y,onClose:()=>x(!1),bucketName:r?.bucket_name})]})}const C=new Map,T=new class{register(e,t){if(!e||"string"!=typeof e)throw new Error("ProviderRegistry.register() requires a valid provider ID string");if(!t||"function"!=typeof t)throw new Error("ProviderRegistry.register() requires a provider class");if(!t.ID)throw new Error(`Provider ${e} must have static ID property`);if(!t.NAME)throw new Error(`Provider ${e} must have static NAME property`);C.set(e,t),(0,r.doAction)("aether.providers.registered",e,t)}get(e){return C.get(e)||null}getAll(){return Array.from(C.values())}getAllIds(){return Array.from(C.keys())}getByDeploymentType(e){return this.getAll().filter(r=>r.DEPLOYMENT_TYPE===e)}getDefault(){const e=this.getByDeploymentType("static_site");if(e.length>0)return e[0];const r=this.getAll();return r.length>0?r[0]:null}getForDeploymentType(e){const r=this.getByDeploymentType(e);return r.length>0?r[0]:null}has(e){return C.has(e)}count(){return C.size}parseInstanceId(e){if(!e||"string"!=typeof e)return null;const r=e.split(":",2);return 2===r.length&&r[0]&&r[1]?{provider_type:r[0],uuid:r[1]}:null}getProviderForInstance(e){const r=this.parseInstanceId(e);return r?this.get(r.provider_type):null}createInstanceId(e){return`${e}:${"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{const r=16*Math.random()|0;return("x"===e?r:3&r|8).toString(16)})}`}clear(){C.clear()}};(0,r.addAction)("aether.providers.register","aether/provider-registry",e=>{if(!e||"function"!=typeof e)return;const r=e.ID;r&&T.register(r,e)});let S=T;if("undefined"!=typeof window)if(window.aether=window.aether||{},window.aether.ProviderRegistry){const e=window.aether.ProviderRegistry;Array.from(C.values()).forEach(r=>{const t=r.ID;e.get(t)||e.register(t,r)}),S=e}else window.aether.ProviderRegistry=T;const R=S;function P(e,r){if(!e)return r;try{const t=JSON.parse(e);return t.errors&&Array.isArray(t.errors)&&t.errors.length>0&&t.errors[0].message?t.errors[0].message:t.error?"string"==typeof t.error?t.error:JSON.stringify(t.error):t.message?t.message:r}catch(t){return e||r}}function E(e=null,r=null){const t={success:!0,data:e};return r&&"object"==typeof e&&null!==e?t.data={...e,message:r}:r&&(t.data={message:r}),t}function I(e,r=null){const t={success:!1,error:"string"==typeof e?e:e?.message||"Unknown error"};return r&&Array.isArray(r)&&r.length>0&&(t.errors=r),t}const D=5242880;async function A(e,r,t,o,i){const s=await fetch(e,{method:"POST",headers:{"Content-Type":"application/octet-stream","X-R2-Key":encodeURIComponent(r),"X-R2-Upload-Id":t,"X-R2-Part-Number":String(o)},body:i});return s.ok&&(await s.json()).etag||null}async function B(e,r,t){return(await fetch(e,{method:"POST",headers:{"Content-Type":"application/json","X-R2-Action":"abort-multipart"},body:JSON.stringify({key:r,uploadId:t})})).ok}async function O(e,r="",t=1e3){const o=await fetch(e,{method:"POST",headers:{"Content-Type":"application/json","X-R2-Action":"list"},body:JSON.stringify({prefix:r,limit:t})});return o.ok?E({objects:(await o.json()).objects||[]}):I(P(await o.text(),`List failed: ${o.status}`))}class ${constructor(e,r,t={}){this.workerEndpoint=e,this.bucketName=r,this.config=t,this.providerId=t.provider_id||""}async upload(e,r,t={}){if(!(r instanceof File||r instanceof Blob))return{success:!1,error:"File must be a File or Blob object"};const o={contentType:t.contentType||r.type,cacheControl:t.cacheControl||"",onProgress:t.onProgress||null},i=await async function(e,r,t,o={}){return t.size>20971520?async function(e,r,t,o={}){const i=t.size,s=o.contentType||t.type||"application/octet-stream",n=o.cacheControl||"",a=await async function(e,r,t,o){const i=await fetch(e,{method:"POST",headers:{"Content-Type":"application/json","X-R2-Action":"initiate-multipart"},body:JSON.stringify({key:r,contentType:t,cacheControl:o})});return i.ok&&(await i.json()).uploadId||null}(e,r,s,n);if(!a)return I("Failed to initiate multipart upload");const d=[],l=Math.ceil(i/D),c=o.onProgress||null;for(let o=1;o<=l;o++){const s=(o-1)*D,n=Math.min(s+D,i),l=t.slice(s,n),p=await l.arrayBuffer(),u=await A(e,r,a,o,p);if(!u)return await B(e,r,a),I(`Failed to upload part ${o}`);if(d.push({partNumber:o,etag:u}),c){const e=o*D;c(Math.min(e,i),i,null)}}const p=await async function(e,r,t,o){return(await fetch(e,{method:"POST",headers:{"Content-Type":"application/json","X-R2-Action":"complete-multipart"},body:JSON.stringify({key:r,uploadId:t,parts:o})})).ok}(e,r,a,d);return p?E():(await B(e,r,a),I("Failed to complete multipart upload"))}(e,r,t,o):async function(e,r,t,o={}){const i=o.contentType||t.type||"application/octet-stream",s=o.cacheControl||"",n=o.onProgress||null;return new Promise((o,a)=>{const d=new XMLHttpRequest;d.timeout=3e5,n&&d.upload.addEventListener("progress",e=>{if(e.lengthComputable){const r=Math.round(e.loaded/e.total*100);n(e.loaded,e.total,r)}}),d.addEventListener("timeout",()=>{a(new Error("Upload timed out after 300000ms"))}),d.addEventListener("load",()=>{if(d.status>=200&&d.status<300)return void o(E());let e=`Upload failed: ${d.status}`;e=P(d.responseText,e),o(I(e))}),d.addEventListener("error",()=>{a(new Error("Upload failed: network error"))}),d.addEventListener("abort",()=>{a(new Error("Upload aborted"))}),d.open("POST",e),d.setRequestHeader("Content-Type","application/octet-stream"),d.setRequestHeader("X-R2-Key",encodeURIComponent(r)),d.setRequestHeader("X-R2-Content-Type",i),s&&d.setRequestHeader("X-R2-Cache-Control",s),d.send(t)})}(e,r,t,o)}(this.workerEndpoint,e,r,o);return i.success?{success:!0,url:this.getUrl(e)}:i}async delete(e){return async function(e,r){const t=await fetch(e,{method:"POST",headers:{"Content-Type":"application/json","X-R2-Action":"delete"},body:JSON.stringify({key:r})});return t.ok?E():I(P(await t.text(),`Delete failed: ${t.status}`))}(this.workerEndpoint,e)}async copy(e,r){return async function(e,r,t){const o=await fetch(e,{method:"POST",headers:{"Content-Type":"application/json","X-R2-Action":"copy"},body:JSON.stringify({sourceKey:r,destKey:t})});return o.ok?E():I(P(await o.text(),`Copy failed: ${o.status}`))}(this.workerEndpoint,e,r)}async exists(e){const r=await O(this.workerEndpoint,e,1);return!!r.success&&(r.objects||[]).some(r=>r.key===e)}async listObjects(e="",r=1e3){return O(this.workerEndpoint,e,r)}getUrl(e){return this.config.public_url?`${this.config.public_url.replace(/\/$/,"")}/${e}`:function(e,r,t){return`${e.replace(/\/$/,"")}/${r}/${t}`}(this.workerEndpoint,this.bucketName,e)}async batchCopy(e){return async function(e,r){const t=await fetch(e,{method:"POST",headers:{"Content-Type":"application/json","X-R2-Action":"batch-copy"},body:JSON.stringify({operations:r})});if(!t.ok)return I(P(await t.text(),`Batch copy failed: ${t.status}`));const o=await t.json();return E({copied:o.copied||0,errors:o.errors||0,results:o.results||[]})}(this.workerEndpoint,e)}async batchDelete(e){return async function(e,r){const t=await fetch(e,{method:"POST",headers:{"Content-Type":"application/json","X-R2-Action":"batch-delete"},body:JSON.stringify({keys:r})});return t.ok?E():I(P(await t.text(),`Batch delete failed: ${t.status}`))}(this.workerEndpoint,e)}async downloadManifest(){const e=this.providerId?`file-manifest-${this.providerId}.json`:"file-manifest.json";try{return await async function(e,r){const t=await fetch(e,{method:"POST",headers:{"Content-Type":"application/json","X-R2-Action":"download"},body:JSON.stringify({key:r})});if(!t.ok){if(404===t.status)return null;const e=await t.text();throw new Error(`Download failed: ${t.status} - ${e}`)}return t.blob()}(this.workerEndpoint,e)}catch(e){return null}}async uploadManifest(e){const r=this.providerId?`file-manifest-${this.providerId}.json`:"file-manifest.json";return await this.upload(r,e,{contentType:"application/json"})}async testConnection(){const e=await this.listObjects("",1);return e.success?{success:!0,message:"Successfully connected to Cloudflare R2."}:{success:!1,error:e.error||"Failed to list objects"}}}async function L(e){try{return(await m({path:`/aether/site-exporter/providers/${e}/config`,method:"GET"})).config||{}}catch(e){if("restProviderNotConfigured"===e.code||404===e.status)return{};throw e}}R.register(o.ID,o),(0,r.doAction)("aether.providers.register",o);const N=new Map;async function W(e){const r=await L(e);return r?.worker_endpoint&&r?.bucket_name?new $(r.worker_endpoint,r.bucket_name,{public_url:r.public_url||null,provider_id:e}):null}var U;(0,r.addAction)("aether.file.upload","aether/cloudflare-r2-blueprint-bundle",e=>{e._uploadPromises||(e._uploadPromises=[]),e._uploadPromises.push(async function(e){const{fileType:r,providerId:t,filePath:o,storageKey:i}=e;if(!t||!t.startsWith("cloudflare-r2-blueprint-bundle"))return;if("blueprint-bundle"!==r)return;const s=`${t}:${i||o}`,n=N.get(s);if(!0===n)return;if(n instanceof Promise){try{await n}catch{N.get(s)===n&&N.delete(s)}if(!0===N.get(s))return}const a=(async()=>{try{const r=await W(t);if(!r)throw new Error("Storage service not available. Please configure worker_endpoint and bucket_name.");if(!o)throw new Error("Blueprint bundle file path is required");if(!o.startsWith("http://")&&!o.startsWith("https://"))throw new Error("Blueprint bundle must be provided as a URL for R2 uploads");const s=await fetch(o,{method:"GET",credentials:"omit"});if(!s.ok)throw new Error(`Failed to fetch blueprint bundle: HTTP ${s.status}`);const n=await L(t),a=i||n?.bundle_path||"blueprint-bundle/bundle.zip",d=await r.upload(a,await s.blob(),{contentType:"application/zip"});if(!d.success)throw new Error(d.error||"Blueprint bundle upload failed");e.result={success:!0,url:d.url}}catch(r){throw e.result={success:!1,error:r.message||"Unknown error"},r}N.set(s,!0)})().catch(e=>{throw N.get(s)===a&&N.delete(s),e});N.set(s,a),await a}(e))},10),(0,r.addFilter)("aether.provider.test","aether/cloudflare-r2-blueprint-bundle",(e,r)=>r?.startsWith("cloudflare-r2-blueprint-bundle")?async()=>{const e=await W(r);return e?e.testConnection():{success:!1,error:"Storage service not configured. Please set worker_endpoint and bucket_name."}}:e,10),(0,r.addFilter)("aether.provider.upload_strategy","aether/cloudflare-r2-blueprint-bundle",(e,r)=>r?.startsWith("cloudflare-r2-blueprint-bundle")?"worker":e,10),U="cloudflare-r2-blueprint-bundle",(0,r.addFilter)("aether.admin.provider.modal.header",`aether/${U}/setup-guide`,(e,r)=>r.providerId?.startsWith(U)?(0,g.jsx)(w,{}):e),(0,r.addFilter)("aether.admin.provider.field.after",`aether/${U}/api-token-help`,(e,r)=>"api_token"===r.fieldId&&r.providerId?.startsWith(U)?(0,g.jsxs)(g.Fragment,{children:[e,(0,g.jsx)(v,{})]}):e,5),(0,r.addFilter)("aether.admin.provider.field.after",`aether/${U}/deploy-button`,(e,r)=>"worker_endpoint"===r.fieldId&&r.providerId?.startsWith(U)?(0,g.jsxs)(g.Fragment,{children:[e,(0,g.jsx)(j,{providerId:r.providerId,config:r.formValues||{},onChange:r.onFormChange})]}):e,10)})();