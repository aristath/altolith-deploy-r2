(()=>{"use strict";var e={n:t=>{var r=t&&t.__esModule?()=>t.default:()=>t;return e.d(r,{a:r}),r},d:(t,r)=>{for(var n in r)e.o(r,n)&&!e.o(t,n)&&Object.defineProperty(t,n,{enumerable:!0,get:r[n]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)};const t=window.wp.hooks,r=window.wp.i18n;class n{static ID="cloudflare-r2-blueprint-bundle";static NAME=(0,r.__)("Cloudflare R2","aether-site-exporter-providers");static TYPE="cloud-storage";static DESCRIPTION=(0,r.__)("Cloudflare R2 object storage for WordPress Playground blueprint bundles with zero egress fees.","aether-site-exporter-providers");static ICON="☁️";static DEPLOYMENT_TYPE="blueprint_bundle";static CONFIG_FIELDS=[{id:"account_id",label:(0,r.__)("Cloudflare Account ID","aether-site-exporter-providers"),type:"text",required:!0,sensitive:!0,validation:{pattern:"^[a-f0-9]{32}$",message:(0,r.__)("Account ID must be a 32-character hexadecimal string","aether-site-exporter-providers")}},{id:"api_token",label:(0,r.__)("Cloudflare API Token","aether-site-exporter-providers"),type:"password",required:!0,sensitive:!0,validation:{minLength:20,message:(0,r.__)("API Token must be at least 20 characters","aether-site-exporter-providers")}},{id:"access_key_id",label:(0,r.__)("R2 Access Key ID","aether-site-exporter-providers"),type:"text",required:!0,sensitive:!0,validation:{minLength:16,maxLength:128,message:(0,r.__)("Access Key ID must be between 16 and 128 characters","aether-site-exporter-providers")}},{id:"secret_access_key",label:(0,r.__)("R2 Secret Access Key","aether-site-exporter-providers"),type:"text",required:!0,sensitive:!0,validation:{minLength:32,maxLength:128,message:(0,r.__)("Secret Access Key must be between 32 and 128 characters","aether-site-exporter-providers")}},{id:"bucket_name",label:(0,r.__)("Bucket Name","aether-site-exporter-providers"),type:"text",required:!0,sensitive:!1,validation:{pattern:"^[a-z0-9][a-z0-9-]{1,61}[a-z0-9]$",minLength:3,maxLength:63,message:(0,r.__)("Bucket name must be 3-63 characters, start and end with alphanumeric, and contain only lowercase letters, numbers, and hyphens","aether-site-exporter-providers")}},{id:"worker_endpoint",label:(0,r.__)("Worker Endpoint URL","aether-site-exporter-providers"),type:"url",required:!1,sensitive:!1,help:(0,r.__)("URL of the deployed Cloudflare Worker. Use the Deploy Worker button below to create one.","aether-site-exporter-providers")},{id:"bundle_path",label:(0,r.__)("Bundle Path","aether-site-exporter-providers"),type:"text",required:!1,sensitive:!1,placeholder:"blueprint-bundle/bundle.zip",help:(0,r.__)("Path within the bucket for the blueprint bundle ZIP file","aether-site-exporter-providers")},{id:"custom_domain",label:(0,r.__)("Custom Domain (Optional)","aether-site-exporter-providers"),type:"url",required:!1,sensitive:!1,isAdvanced:!0}]}const o=window.wp.element,s=window.wp.components,i=window.wp.apiFetch;var a=e.n(i);const c=new Map;function d(e){return`${e.method||"GET"}:${e.path||""}:${e.data?JSON.stringify(e.data):""}`}const l=(e,t)=>{const r=d(e);if(c.has(r))return c.get(r);const n=t(e);return c.set(r,n),n.finally(()=>{c.delete(r)}),n},u=new Map,p={"/assets":6e5,"/settings":6e4,"/config":18e5,"/check-wporg":36e5};const h=(e,t)=>{if("GET"!==(e.method||"GET"))return t(e);const r=d(e),n=u.get(r);if(function(e,t){if(!e)return!1;const r=function(e){for(const[t,r]of Object.entries(p))if(e&&e.includes(t))return r;return 3e5}(t);return 0!==r&&Date.now()-e.timestamp<r}(n,e.path))return Promise.resolve(n.response);const o=t(e);return o.then(e=>(u.set(r,{response:e,timestamp:Date.now()}),e)).catch(e=>{throw e}),o};!function(){const e="undefined"!=typeof window&&window.aetherData&&window.aetherData.restUrl?window.aetherData.restUrl:"/wp-json/",t="undefined"!=typeof window&&window.aetherData&&window.aetherData.nonce?window.aetherData.nonce:"";a().use(a().createRootURLMiddleware(e)),t&&function(e){a().use(a().createNonceMiddleware(e))}(t),a().use(h),a().use(l)}();const f=a(),y=window.ReactJSXRuntime;function w({providerId:e,config:t,onChange:n}){const[i,a]=(0,o.useState)(!1),[c,d]=(0,o.useState)(null),[l,u]=(0,o.useState)(!1),[p,h]=(0,o.useState)(null);return(0,y.jsxs)("div",{style:{marginTop:"1rem",paddingTop:"1rem",borderTop:"1px solid #ddd"},children:[(0,y.jsx)(s.Button,{variant:"secondary",onClick:async()=>{a(!0),d(null),u(!1),h(null);try{if(!t?.account_id||!t?.api_token)throw new Error((0,r.__)("Cloudflare Account ID and API Token are required","aether-site-exporter-providers"));if(!t?.access_key_id||!t?.secret_access_key||!t?.bucket_name)throw new Error((0,r.__)("R2 Access Key ID, Secret Access Key, and Bucket Name are required","aether-site-exporter-providers"));const o=window.wpApiSettings?.root||"/wp-json",s=document.querySelector('meta[name="aether-rest-nonce"]')?.getAttribute("content")||window.wpApiSettings?.nonce||"",i=`aether-r2-${Math.random().toString(36).substring(2,10)}`,a={};t.bucket_name&&(a.R2_BUCKET={type:"r2_bucket",bucket_name:t.bucket_name});const c=`${o}/aether/site-exporter/providers/cloudflare/deploy-worker`,d=await fetch(c,{method:"POST",headers:{"X-WP-Nonce":s,"Content-Type":"application/json"},body:JSON.stringify({worker_type:"r2",worker_name:i,bindings:a,account_id:t.account_id,api_token:t.api_token})});if(!d.ok){const e=await d.json().catch(()=>({message:`HTTP ${d.status}: ${d.statusText}`}));throw new Error(e.message||e.error||(0,r.__)("Failed to deploy worker","aether-site-exporter-providers"))}const l=await d.json();if(!l.success)throw new Error(l.message||l.error||(0,r.__)("Failed to deploy worker","aether-site-exporter-providers"));if(l.worker_url){n&&"function"==typeof n&&n("worker_endpoint",l.worker_url);try{await f({path:`/aether/site-exporter/providers/${e}/config`,method:"PUT",data:{worker_endpoint:l.worker_url}})}catch{}}u(!0),h(l.worker_url||null),setTimeout(()=>{u(!1)},1e4)}catch(e){d(e.message||(0,r.__)("Failed to deploy worker","aether-site-exporter-providers"))}finally{a(!1)}},isBusy:i,disabled:i||!t?.account_id||!t?.api_token||!t?.access_key_id||!t?.secret_access_key||!t?.bucket_name,children:i?(0,r.__)("Deploying…","aether-site-exporter-providers"):(0,r.__)("Deploy Worker","aether-site-exporter-providers")}),c&&(0,y.jsx)(s.Notice,{status:"error",isDismissible:!1,style:{marginTop:"0.5rem"},children:c}),l&&(0,y.jsxs)(s.Notice,{status:"success",isDismissible:!1,style:{marginTop:"0.5rem"},children:[(0,r.__)("Worker deployed successfully!","aether-site-exporter-providers"),p&&(0,y.jsxs)("div",{style:{marginTop:"0.5rem"},children:[(0,y.jsx)("strong",{children:(0,r.__)("Worker URL:","aether-site-exporter-providers")})," ",(0,y.jsx)("a",{href:p,target:"_blank",rel:"noopener noreferrer",children:p})]})]})]})}const m=new Map,g=new Map,b=new Map,_=new class{register(e,r){if(!e||"string"!=typeof e)throw new Error("ProviderRegistry.register() requires a valid provider ID string");if(!r||"function"!=typeof r)throw new Error("ProviderRegistry.register() requires a provider class");if(!r.ID)throw new Error(`Provider ${e} must have static ID property`);if(!r.NAME)throw new Error(`Provider ${e} must have static NAME property`);b.set(e,r),(0,t.doAction)("aether.providers.registered",e,r)}get(e){return b.get(e)||null}getAll(){return Array.from(b.values())}getAllIds(){return Array.from(b.keys())}getByDeploymentType(e){return this.getAll().filter(t=>t.DEPLOYMENT_TYPE===e)}getDefault(){const e=this.getByDeploymentType("static_site");if(e.length>0)return e[0];const t=this.getAll();return t.length>0?t[0]:null}getForDeploymentType(e){const t=this.getByDeploymentType(e);return t.length>0?t[0]:null}has(e){return b.has(e)}count(){return b.size}parseInstanceId(e){if(!e||"string"!=typeof e)return null;const t=e.split(":",2);return 2===t.length&&t[0]&&t[1]?{provider_type:t[0],uuid:t[1]}:null}getProviderForInstance(e){const t=this.parseInstanceId(e);return t?this.get(t.provider_type):null}createInstanceId(e){return`${e}:${"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{const t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)})}`}clear(){b.clear()}};(0,t.addAction)("aether.providers.register","aether/provider-registry",e=>{if(!e||"function"!=typeof e)return;const t=e.ID;t&&_.register(t,e)});let v=_;if("undefined"!=typeof window)if(window.aether=window.aether||{},window.aether.ProviderRegistry){const e=window.aether.ProviderRegistry;Array.from(b.values()).forEach(t=>{const r=t.ID;e.get(r)||e.register(r,t)}),v=e}else window.aether.ProviderRegistry=_;const k=v;function x(e,t){if(!e)return t;try{const r=JSON.parse(e);return r.errors&&Array.isArray(r.errors)&&r.errors.length>0&&r.errors[0].message?r.errors[0].message:r.error?"string"==typeof r.error?r.error:JSON.stringify(r.error):r.message?r.message:t}catch(r){return e||t}}function T(e=null,t=null){const r={success:!0,data:e};return t&&"object"==typeof e&&null!==e?r.data={...e,message:t}:t&&(r.data={message:t}),r}function P(e,t=null){const r={success:!1,error:"string"==typeof e?e:e?.message||"Unknown error"};return t&&Array.isArray(t)&&t.length>0&&(r.errors=t),r}const E=5242880;async function I(e,t,r,n,o){const s=await fetch(e,{method:"POST",headers:{"Content-Type":"application/octet-stream","X-R2-Key":t,"X-R2-Upload-Id":r,"X-R2-Part-Number":String(n)},body:o});return s.ok&&(await s.json()).etag||null}async function S(e,t,r){return(await fetch(e,{method:"POST",headers:{"Content-Type":"application/json","X-R2-Action":"abort-multipart"},body:JSON.stringify({key:t,uploadId:r})})).ok}async function A(e,t="",r=1e3){const n=await fetch(e,{method:"POST",headers:{"Content-Type":"application/json","X-R2-Action":"list"},body:JSON.stringify({prefix:t,limit:r})});return n.ok?T({objects:(await n.json()).objects||[]}):P(x(await n.text(),`List failed: ${n.status}`))}class C{constructor(e,t,r={}){this.workerEndpoint=e,this.bucketName=t,this.config=r}async upload(e,t,r={}){if(!(t instanceof File||t instanceof Blob))return{success:!1,error:"File must be a File or Blob object"};const n={contentType:r.contentType||t.type,cacheControl:r.cacheControl||"",onProgress:r.onProgress||null},o=await async function(e,t,r,n={}){return r.size>20971520?async function(e,t,r,n={}){const o=r.size,s=n.contentType||r.type||"application/octet-stream",i=n.cacheControl||"",a=await async function(e,t,r,n){const o=await fetch(e,{method:"POST",headers:{"Content-Type":"application/json","X-R2-Action":"initiate-multipart"},body:JSON.stringify({key:t,contentType:r,cacheControl:n})});return o.ok&&(await o.json()).uploadId||null}(e,t,s,i);if(!a)return P("Failed to initiate multipart upload");const c=[],d=Math.ceil(o/E),l=n.onProgress||null;for(let n=1;n<=d;n++){const s=(n-1)*E,i=Math.min(s+E,o),d=r.slice(s,i),u=await d.arrayBuffer(),p=await I(e,t,a,n,u);if(!p)return await S(e,t,a),P(`Failed to upload part ${n}`);if(c.push({partNumber:n,etag:p}),l){const e=n*E;l(Math.min(e,o),o,null)}}const u=await async function(e,t,r,n){return(await fetch(e,{method:"POST",headers:{"Content-Type":"application/json","X-R2-Action":"complete-multipart"},body:JSON.stringify({key:t,uploadId:r,parts:n})})).ok}(e,t,a,c);return u?T():(await S(e,t,a),P("Failed to complete multipart upload"))}(e,t,r,n):async function(e,t,r,n={}){const o=n.contentType||r.type||"application/octet-stream",s=n.cacheControl||"",i=n.onProgress||null;return new Promise((n,a)=>{const c=new XMLHttpRequest;c.timeout=3e5,i&&c.upload.addEventListener("progress",e=>{if(e.lengthComputable){const t=Math.round(e.loaded/e.total*100);i(e.loaded,e.total,t)}}),c.addEventListener("timeout",()=>{a(new Error("Upload timed out after 300000ms"))}),c.addEventListener("load",()=>{if(c.status>=200&&c.status<300)return void n(T());let e=`Upload failed: ${c.status}`;e=x(c.responseText,e),n(P(e))}),c.addEventListener("error",()=>{a(new Error("Upload failed: network error"))}),c.addEventListener("abort",()=>{a(new Error("Upload aborted"))}),c.open("POST",e),c.setRequestHeader("Content-Type","application/octet-stream"),c.setRequestHeader("X-R2-Key",t),c.setRequestHeader("X-R2-Content-Type",o),s&&c.setRequestHeader("X-R2-Cache-Control",s),c.send(r)})}(e,t,r,n)}(this.workerEndpoint,e,t,n);return o.success?{success:!0,url:this.getUrl(e)}:o}async delete(e){return async function(e,t){const r=await fetch(e,{method:"POST",headers:{"Content-Type":"application/json","X-R2-Action":"delete"},body:JSON.stringify({key:t})});return r.ok?T():P(x(await r.text(),`Delete failed: ${r.status}`))}(this.workerEndpoint,e)}async copy(e,t){return async function(e,t,r){const n=await fetch(e,{method:"POST",headers:{"Content-Type":"application/json","X-R2-Action":"copy"},body:JSON.stringify({sourceKey:t,destKey:r})});return n.ok?T():P(x(await n.text(),`Copy failed: ${n.status}`))}(this.workerEndpoint,e,t)}async exists(e){const t=await A(this.workerEndpoint,e,1);return!!t.success&&(t.objects||[]).some(t=>t.key===e)}async listObjects(e="",t=1e3){return A(this.workerEndpoint,e,t)}getUrl(e){return this.config.public_url?`${this.config.public_url.replace(/\/$/,"")}/${e}`:function(e,t,r){return`${e.replace(/\/$/,"")}/${t}/${r}`}(this.workerEndpoint,this.bucketName,e)}async batchCopy(e){return async function(e,t){const r=await fetch(e,{method:"POST",headers:{"Content-Type":"application/json","X-R2-Action":"batch-copy"},body:JSON.stringify({operations:t})});if(!r.ok)return P(x(await r.text(),`Batch copy failed: ${r.status}`));const n=await r.json();return T({copied:n.copied||0,errors:n.errors||0,results:n.results||[]})}(this.workerEndpoint,e)}async batchDelete(e){return async function(e,t){const r=await fetch(e,{method:"POST",headers:{"Content-Type":"application/json","X-R2-Action":"batch-delete"},body:JSON.stringify({keys:t})});return r.ok?T():P(x(await r.text(),`Batch delete failed: ${r.status}`))}(this.workerEndpoint,e)}async downloadManifest(e){const t=`${e}/file-manifest.json`;try{return await async function(e,t){const r=await fetch(e,{method:"POST",headers:{"Content-Type":"application/json","X-R2-Action":"download"},body:JSON.stringify({key:t})});if(!r.ok){if(404===r.status)return null;const e=await r.text();throw new Error(`Download failed: ${r.status} - ${e}`)}return r.blob()}(this.workerEndpoint,t)}catch(e){return null}}async uploadManifest(e,t){const r=`${e}/file-manifest.json`;return await this.upload(r,t,{contentType:"application/json"})}async testConnection(){const e=await this.listObjects("",1);return e.success?{success:!0,message:"Successfully connected to Cloudflare R2."}:{success:!1,error:e.error||"Failed to list objects"}}}async function R(e){try{return(await f({path:`/aether/site-exporter/providers/${e}/config`,method:"GET"})).config||{}}catch(e){if("restProviderNotConfigured"===e.code||404===e.status)return{};throw e}}k.register(n.ID,n),(0,t.doAction)("aether.providers.register",n);const j=new Map;async function D(e){const t=await R(e);return t?.worker_endpoint&&t?.bucket_name?new C(t.worker_endpoint,t.bucket_name,{public_url:t.custom_domain||null}):null}var $;(0,t.addAction)("aether.file.upload","aether/cloudflare-r2-blueprint-bundle",e=>{e._uploadPromises||(e._uploadPromises=[]),e._uploadPromises.push(async function(e){const{fileType:t,providerId:r,filePath:n,storageKey:o}=e;if(!r||!r.startsWith("cloudflare-r2-blueprint-bundle"))return;if("blueprint-bundle"!==t)return;const s=`${r}:${o||n}`,i=j.get(s);if(!0===i)return;if(i instanceof Promise){try{await i}catch{j.get(s)===i&&j.delete(s)}if(!0===j.get(s))return}const a=(async()=>{try{const t=await D(r);if(!t)throw new Error("Storage service not available. Please configure worker_endpoint and bucket_name.");if(!n)throw new Error("Blueprint bundle file path is required");if(!n.startsWith("http://")&&!n.startsWith("https://"))throw new Error("Blueprint bundle must be provided as a URL for R2 uploads");const s=await fetch(n,{method:"GET",credentials:"omit"});if(!s.ok)throw new Error(`Failed to fetch blueprint bundle: HTTP ${s.status}`);const i=await R(r),a=o||i?.bundle_path||"blueprint-bundle/bundle.zip",c=await t.upload(a,await s.blob(),{contentType:"application/zip"});if(!c.success)throw new Error(c.error||"Blueprint bundle upload failed");e.result={success:!0,url:c.url}}catch(t){throw e.result={success:!1,error:t.message||"Unknown error"},t}j.set(s,!0)})().catch(e=>{throw j.get(s)===a&&j.delete(s),e});j.set(s,a),await a}(e))},10),(0,t.addFilter)("aether.provider.test","aether/cloudflare-r2-blueprint-bundle",(e,t)=>t?.startsWith("cloudflare-r2-blueprint-bundle")?async()=>{const e=await D(t);return e?e.testConnection():{success:!1,error:"Storage service not configured. Please set worker_endpoint and bucket_name."}}:e,10),(0,t.addFilter)("aether.provider.upload_strategy","aether/cloudflare-r2-blueprint-bundle",(e,t)=>t?.startsWith("cloudflare-r2-blueprint-bundle")?"worker":e,10),$="cloudflare-r2-blueprint-bundle",(0,t.addAction)("aether.provider.form.after_fields",`aether/${$}/deploy-button`,e=>{if(!e.providerId?.startsWith($))return;const t=document.querySelector(`.aether-provider-form__after-fields[data-provider-id="${e.providerId}"]`);if(!t)return;const r=m.get(e.providerId),n=g.get(e.providerId);if(r){try{r.unmount()}catch{n&&n.parentNode&&n.parentNode.removeChild(n)}m.delete(e.providerId),g.delete(e.providerId)}const s=document.createElement("div");t.appendChild(s);const i=(0,o.createRoot)(s);m.set(e.providerId,i),g.set(e.providerId,s),i.render((0,y.jsx)(w,{providerId:e.providerId,config:e.values,onChange:e.onChange}))})})();