(()=>{"use strict";var e={231:(e,t,r)=>{r.d(t,{ConfigStorage:()=>q});var n=r(455),o=r.n(n);const s=new Map;function a(e){return`${e.method||"GET"}:${e.path||""}:${e.data?JSON.stringify(e.data):""}`}const i=(e,t)=>{const r=a(e);if(s.has(r))return s.get(r);const n=t(e);return s.set(r,n),n.finally(()=>{s.delete(r)}),n},c=new Map,d={"/assets":6e5,"/settings":6e4,"/config":18e5,"/check-wporg":36e5};const u=(e,t)=>{if("GET"!==(e.method||"GET"))return t(e);const r=a(e),n=c.get(r);if(function(e,t){if(!e)return!1;const r=function(e){for(const[t,r]of Object.entries(d))if(e&&e.includes(t))return r;return 3e5}(t);return 0!==r&&Date.now()-e.timestamp<r}(n,e.path))return Promise.resolve(n.response);const o=t(e);return o.then(e=>(c.set(r,{response:e,timestamp:Date.now()}),e)).catch(e=>{throw e}),o};!function(){const e=function(){const e=document.querySelector('meta[name="aether-rest-url"]');return e&&e.getAttribute("content")||"/wp-json/aether/site-exporter/"}(),t=function(){const e=document.querySelector('meta[name="aether-rest-nonce"]');return e&&e.getAttribute("content")||""}();o().use(o().createRootURLMiddleware(e)),t&&function(e){o().use(o().createNonceMiddleware(e))}(t),o().use(u),o().use(i)}();const l=o();var h=r(619);const g=(e,t)=>t.some(t=>e instanceof t);let p,m;const f=new WeakMap,w=new WeakMap,y=new WeakMap;let v={get(e,t,r){if(e instanceof IDBTransaction){if("done"===t)return f.get(e);if("store"===t)return r.objectStoreNames[1]?void 0:r.objectStore(r.objectStoreNames[0])}return _(e[t])},set:(e,t,r)=>(e[t]=r,!0),has:(e,t)=>e instanceof IDBTransaction&&("done"===t||"store"===t)||t in e};function b(e){v=e(v)}function k(e){return"function"==typeof e?(t=e,(m||(m=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])).includes(t)?function(...e){return t.apply(I(this),e),_(this.request)}:function(...e){return _(t.apply(I(this),e))}):(e instanceof IDBTransaction&&function(e){if(f.has(e))return;const t=new Promise((t,r)=>{const n=()=>{e.removeEventListener("complete",o),e.removeEventListener("error",s),e.removeEventListener("abort",s)},o=()=>{t(),n()},s=()=>{r(e.error||new DOMException("AbortError","AbortError")),n()};e.addEventListener("complete",o),e.addEventListener("error",s),e.addEventListener("abort",s)});f.set(e,t)}(e),g(e,p||(p=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction]))?new Proxy(e,v):e);var t}function _(e){if(e instanceof IDBRequest)return function(e){const t=new Promise((t,r)=>{const n=()=>{e.removeEventListener("success",o),e.removeEventListener("error",s)},o=()=>{t(_(e.result)),n()},s=()=>{r(e.error),n()};e.addEventListener("success",o),e.addEventListener("error",s)});return y.set(t,e),t}(e);if(w.has(e))return w.get(e);const t=k(e);return t!==e&&(w.set(e,t),y.set(t,e)),t}const I=e=>y.get(e),C=["get","getKey","getAll","getAllKeys","count"],D=["put","add","delete","clear"],E=new Map;function $(e,t){if(!(e instanceof IDBDatabase)||t in e||"string"!=typeof t)return;if(E.get(t))return E.get(t);const r=t.replace(/FromIndex$/,""),n=t!==r,o=D.includes(r);if(!(r in(n?IDBIndex:IDBObjectStore).prototype)||!o&&!C.includes(r))return;const s=async function(e,...t){const s=this.transaction(e,o?"readwrite":"readonly");let a=s.store;return n&&(a=a.index(t.shift())),(await Promise.all([a[r](...t),o&&s.done]))[0]};return E.set(t,s),s}b(e=>({...e,get:(t,r,n)=>$(t,r)||e.get(t,r,n),has:(t,r)=>!!$(t,r)||e.has(t,r)}));const S=["continue","continuePrimaryKey","advance"],x={},A=new WeakMap,T=new WeakMap,P={get(e,t){if(!S.includes(t))return e[t];let r=x[t];return r||(r=x[t]=function(...e){A.set(this,T.get(this)[t](...e))}),r}};async function*F(...e){let t=this;if(t instanceof IDBCursor||(t=await t.openCursor(...e)),!t)return;const r=new Proxy(t,P);for(T.set(r,t),y.set(r,I(t));t;)yield r,t=await(A.get(r)||t.continue()),A.delete(r)}function B(e,t){return t===Symbol.asyncIterator&&g(e,[IDBIndex,IDBObjectStore,IDBCursor])||"iterate"===t&&g(e,[IDBIndex,IDBObjectStore])}b(e=>({...e,get:(t,r,n)=>B(t,r)?F:e.get(t,r,n),has:(t,r)=>B(t,r)||e.has(t,r)}));const N=new Map,j={dbName:"aether-site-exporter",version:1,stores:{cache:{keyPath:"key",indexes:[{name:"timestamp",keyPath:"timestamp",unique:!1},{name:"type",keyPath:"type",unique:!1}]}}};const U=class{constructor(e,t=j){this.storeName=e,this.config=t,this.db=null,this.keyPath=t.stores?.[e]?.keyPath||j.stores.cache.keyPath}async ensureDatabase(){return this.db||(this.db=await async function(e=j){const t=`${e.dbName}_v${e.version}`;if(N.has(t))return N.get(t);try{const r=await function(e,t,{blocked:r,upgrade:n,blocking:o,terminated:s}={}){const a=indexedDB.open(e,t),i=_(a);return n&&a.addEventListener("upgradeneeded",e=>{n(_(a.result),e.oldVersion,e.newVersion,_(a.transaction),e)}),r&&a.addEventListener("blocked",e=>r(e.oldVersion,e.newVersion,e)),i.then(e=>{s&&e.addEventListener("close",()=>s()),o&&e.addEventListener("versionchange",e=>o(e.oldVersion,e.newVersion,e))}).catch(()=>{}),i}(e.dbName,e.version,{upgrade(t){Object.entries(e.stores).forEach(([e,r])=>{t.objectStoreNames.contains(e)&&t.deleteObjectStore(e);const n=t.createObjectStore(e,{keyPath:r.keyPath,autoIncrement:r.autoIncrement||!1});r.indexes&&r.indexes.forEach(e=>{n.createIndex(e.name,e.keyPath,{unique:e.unique||!1})})})}});return N.set(t,r),r}catch(e){throw new Error(`Failed to open IndexedDB: ${e.message||"Unknown error"}`)}}(this.config)),this.db}async get(e){try{const t=await this.ensureDatabase();return await t.get(this.storeName,e)||null}catch(t){return console.error(`[IndexedDB] Error getting key "${e}":`,t),null}}async getAll(e=void 0){try{const t=await this.ensureDatabase();return await t.getAll(this.storeName,void 0,e)||[]}catch(e){return console.error("[IndexedDB] Error getting all values:",e),[]}}async getAllKeys(){try{const e=await this.ensureDatabase();return await e.getAllKeys(this.storeName)||[]}catch(e){return console.error("[IndexedDB] Error getting all keys:",e),[]}}async set(e,t,r={}){try{const n=await this.ensureDatabase(),o="object"==typeof t&&null!==t?{...t}:{value:t},s={[this.keyPath]:e,...o,timestamp:Date.now(),...r};return await n.put(this.storeName,s),!0}catch(t){return("QuotaExceededError"===t.name||t.message?.includes("quota"))&&console.warn("[IndexedDB] Storage quota exceeded. Consider cleaning up old data."),console.error(`[IndexedDB] Error setting key "${e}":`,t),!1}}async delete(e){try{const t=await this.ensureDatabase();return await t.delete(this.storeName,e),!0}catch(t){return console.error(`[IndexedDB] Error deleting key "${e}":`,t),!1}}async clear(){try{const e=await this.ensureDatabase();return await e.clear(this.storeName),!0}catch(e){return console.error("[IndexedDB] Error clearing store:",e),!1}}async count(){try{const e=await this.ensureDatabase();return await e.count(this.storeName)||0}catch(e){return console.error("[IndexedDB] Error counting items:",e),0}}async getByIndex(e,t){try{const r=await this.ensureDatabase();return await r.getAllFromIndex(this.storeName,e,t)||[]}catch(t){return console.error(`[IndexedDB] Error getting by index "${e}":`,t),[]}}async deleteOlderThan(e){try{const t=await this.ensureDatabase(),r=Date.now()-e,n=t.transaction(this.storeName,"readwrite"),o=n.objectStore(this.storeName).index("timestamp");let s=0,a=await o.openCursor(IDBKeyRange.upperBound(r));for(;a;)await a.delete(),s++,a=await a.continue();return await n.done,s}catch(e){return console.error("[IndexedDB] Error deleting old items:",e),0}}async getStorageEstimate(){if(navigator.storage&&navigator.storage.estimate)try{const e=await navigator.storage.estimate();return{quota:e.quota,usage:e.usage,percentUsed:e.quota>0?e.usage/e.quota*100:0}}catch(e){console.error("[IndexedDB] Error getting storage estimate:",e)}return{quota:null,usage:null,percentUsed:null}}},O={dbName:"aether-provider-configs",version:1,stores:{configs:{keyPath:"cacheKey",indexes:[{name:"timestamp",keyPath:"timestamp",unique:!1},{name:"providerId",keyPath:"providerId",unique:!1}]}}};let W=null;function L(){return W||(W=new U("configs",O)),W}class q{providerId;cacheKey;store;constructor(e){if(!e||"string"!=typeof e)throw new Error("ConfigStorage requires a valid provider ID");this.providerId=e,this.cacheKey=`provider:${e}`,this.store=L()}async load(){const e=await this.getFromCache();if(null!==e)return e;try{let e=(await l({path:`/aether/site-exporter/providers/${this.providerId}/config`,method:"GET"})).config||{};return e=(0,h.applyFilters)("aether.storage.config.load",e,this.providerId),this.saveToCache(e),(0,h.doAction)("aether.storage.config.loaded",e,this.providerId),e}catch(e){if("restProviderNotConfigured"===e.code||404===e.status)return{};throw e}}async save(e){e=(0,h.applyFilters)("aether.storage.config.before_save",e,this.providerId);try{return await l({path:`/aether/site-exporter/providers/${this.providerId}/config`,method:"POST",data:{config:e}}),this.saveToCache(e),(0,h.doAction)("aether.storage.config.saved",e,this.providerId),!0}catch(e){throw e}}async delete(){(0,h.doAction)("aether.storage.config.before_delete",this.providerId);try{return await l({path:`/aether/site-exporter/providers/${this.providerId}/config`,method:"DELETE"}),this.clearCache(),(0,h.doAction)("aether.storage.config.deleted",this.providerId),!0}catch(e){throw e}}async getFromCache(){try{const e=await this.store.get(this.cacheKey);return e?Date.now()-e.timestamp>3e5?(await this.clearCache(),null):e.config:null}catch(e){return await this.clearCache(),null}}async saveToCache(e){try{await this.store.set(this.cacheKey,{config:e},{providerId:this.providerId})}catch(e){console.error(`[ConfigStorage] Failed to cache config for ${this.providerId}:`,e)}}async clearCache(){try{await this.store.delete(this.cacheKey)}catch(e){console.error(`[ConfigStorage] Failed to clear cache for ${this.providerId}:`,e)}}static async invalidateCache(e){const t=new q(e);await t.clearCache()}static async clearAllCaches(){try{const e=L();await e.clear()}catch(e){console.error("[ConfigStorage] Failed to clear all caches:",e)}}}},455:e=>{e.exports=window.wp.apiFetch},619:e=>{e.exports=window.wp.hooks}},t={};function r(n){var o=t[n];if(void 0!==o)return o.exports;var s=t[n]={exports:{}};return e[n](s,s.exports,r),s.exports}r.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return r.d(t,{a:t}),t},r.d=(e,t)=>{for(var n in t)r.o(t,n)&&!r.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},r.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t);var n=r(619);const o=window.wp.i18n;function s(){return"undefined"!=typeof window&&!0===window.aetherDebug}function a(...e){s()&&window.console&&window.console.log&&window.console.log("[Aether]",...e)}function i(...e){s()&&window.console&&window.console.error&&window.console.error("[Aether Error]",...e)}function c(...e){s()&&window.console&&window.console.warn&&window.console.warn("[Aether Warning]",...e)}const d={debug:a,error:i,warn:c,info:function(...e){s()&&window.console&&window.console.info&&window.console.info("[Aether Info]",...e)},table:function(e){s()&&window.console&&window.console.table&&window.console.table(e)},time:function(e){s()&&window.console&&window.console.time&&window.console.time(`[Aether] ${e}`)},timeEnd:function(e){s()&&window.console&&window.console.timeEnd&&window.console.timeEnd(`[Aether] ${e}`)},group:function(e){s()&&window.console&&window.console.group&&window.console.group(`[Aether] ${e}`)},groupEnd:function(){s()&&window.console&&window.console.groupEnd&&window.console.groupEnd()},enable:function(){"undefined"!=typeof window&&(window.aetherDebug=!0,a("Debug mode enabled"))},disable:function(){"undefined"!=typeof window&&(window.aetherDebug=!1)},isEnabled:s};"undefined"!=typeof window&&(window.aetherDebug=window.aetherDebug||!1,window.aetherDebugUtil=d);var u=r(455),l=r.n(u);function h(e,t="Bearer"){return{Authorization:`${t} ${e}`,"Content-Type":"application/json"}}const g=new Map;function p(e){return`${e.method||"GET"}:${e.path||""}:${e.data?JSON.stringify(e.data):""}`}const m=(e,t)=>{const r=p(e);if(g.has(r))return g.get(r);const n=t(e);return g.set(r,n),n.finally(()=>{g.delete(r)}),n},f=new Map,w={"/assets":6e5,"/settings":6e4,"/config":18e5,"/check-wporg":36e5};const y=(e,t)=>{if("GET"!==(e.method||"GET"))return t(e);const r=p(e),n=f.get(r);if(function(e,t){if(!e)return!1;const r=function(e){for(const[t,r]of Object.entries(w))if(e&&e.includes(t))return r;return 3e5}(t);return 0!==r&&Date.now()-e.timestamp<r}(n,e.path))return Promise.resolve(n.response);const o=t(e);return o.then(e=>(f.set(r,{response:e,timestamp:Date.now()}),e)).catch(e=>{throw e}),o};!function(){const e=function(){const e=document.querySelector('meta[name="aether-rest-url"]');return e&&e.getAttribute("content")||"/wp-json/aether/site-exporter/"}(),t=function(){const e=document.querySelector('meta[name="aether-rest-nonce"]');return e&&e.getAttribute("content")||""}();l().use(l().createRootURLMiddleware(e)),t&&function(e){l().use(l().createNonceMiddleware(e))}(t),l().use(y),l().use(m)}();const v=l();function b(e,t,r){const n=function(e,t){if(!e)return t;try{const r=JSON.parse(e);return r.errors&&Array.isArray(r.errors)&&r.errors.length>0&&r.errors[0].message?r.errors[0].message:r.error?"string"==typeof r.error?r.error:JSON.stringify(r.error):r.message?r.message:t}catch(r){return e||t}}(e,`${r} failed`);return t&&!n.includes(t.toString())?`${n} (HTTP ${t})`:n}function k(e=null,t=null){const r={success:!0,data:e};return t&&"object"==typeof e&&null!==e?r.data={...e,message:t}:t&&(r.data={message:t}),r}function _(e,t=null){const r={success:!1,error:"string"==typeof e?e:e?.message||"Unknown error"};return t&&Array.isArray(t)&&t.length>0&&(r.errors=t),r}const I="https://api.cloudflare.com/client/v4";async function C(e,t,r,n,o){const s=`${I}/accounts/${e}/workers/domains`,a=n.replace(/^https?:\/\//,"").replace(/\/.*$/,""),i=JSON.stringify({environment:"production",hostname:a,service:r,zone_id:o}),c=await fetch(s,{method:"PUT",headers:h(t),body:i});if(!c.ok)return _(b(await c.text(),c.status,"Attach custom domain"));const d=await c.json();return k({domain:d.result||d})}const D="static_site",E="blueprint_bundle",$="edge_functions",S={[D]:(0,o.__)("Static Site","aether-site-exporter"),[E]:(0,o.__)("Blueprint Bundle","aether-site-exporter"),[$]:(0,o.__)("Edge Functions","aether-site-exporter")},x={[D]:(0,o.__)("Deploy static HTML/CSS/JS files for web hosting","aether-site-exporter"),[E]:(0,o.__)("Deploy WordPress Playground blueprint bundle (ZIP file)","aether-site-exporter"),[$]:(0,o.__)("Deploy serverless functions to edge computing platforms","aether-site-exporter")};class A{config={};registeredId=null;configStorage=null;constructor(e={},t=null){this.config=e,this.registeredId=t,this.initialize()}initialize(){}getId(){throw new Error("AbstractProvider.getId() must be implemented by subclass")}getName(){throw new Error("AbstractProvider.getName() must be implemented by subclass")}getType(){throw new Error("AbstractProvider.getType() must be implemented by subclass")}getDescription(){throw new Error("AbstractProvider.getDescription() must be implemented by subclass")}getIcon(){return"ðŸ“¦"}getSupportedDeploymentTypes(){return[]}getDeploymentTypesWithFilter(){const e=this.getSupportedDeploymentTypes();return(0,n.applyFilters)("aether.provider.supported_deployment_types",e,this.getId(),this)}supportsDeploymentType(e){return this.getDeploymentTypesWithFilter().includes(e)}getEnabledDeploymentTypes(){const e=this.config||{};return e.deployment_types&&Array.isArray(e.deployment_types)&&e.deployment_types.length>0?e.deployment_types:this.getSupportedDeploymentTypes()}isDeploymentTypeEnabled(e){return this.getEnabledDeploymentTypes().includes(e)}async getConfig(){return 0===Object.keys(this.config).length&&(this.config=await this.loadConfig()),(0,n.applyFilters)("aether.provider.config.get",this.config,this.getId())}async saveConfig(e){e=(0,n.applyFilters)("aether.provider.config.before_save",e,this.getId());const t=await this.validateConfig(e);if(Object.keys(t).length>0)throw new Error("Configuration validation failed: "+JSON.stringify(t));const r=await this.sanitizeConfig(e),o=await this.getConfigStorage(),s=await o.save(r);return s&&(this.config=r,(0,n.doAction)("aether.provider.config.saved",r,this.getId())),s}async deleteConfig(){(0,n.doAction)("aether.provider.config.before_delete",this.getId());const e=await this.getConfigStorage(),t=await e.delete();return t&&(this.config={},(0,n.doAction)("aether.provider.config.deleted",this.getId())),t}async isConfigured(){const e=await this.getConfig();if(0===Object.keys(e).length)return!1;const t=this.getConfigFields();for(const r of t)if(r.required&&!e[r.id])return!1;return!0}async validateConfig(e){const t={},r=this.getConfigFields();for(const n of r){const r=n.id,o=e[r];if(!n.required||o){if(o&&n.validation){const s=n.validation;if(s.pattern&&(new RegExp(s.pattern).test(o)||(t[r]=s.message||`${n.label} format is invalid.`)),void 0!==s.minLength&&o.length<s.minLength&&(t[r]=`${n.label} must be at least ${s.minLength} characters.`),void 0!==s.maxLength&&o.length>s.maxLength&&(t[r]=`${n.label} must be no more than ${s.maxLength} characters.`),s.callback&&"function"==typeof s.callback){const n=await s.callback(o,e);"string"==typeof n&&(t[r]=n)}}}else t[r]=`${n.label} is required.`}return(0,n.applyFilters)("aether.provider.config.validate",t,e,this.getId())}async sanitizeConfig(e){const t={},r=this.getConfigFields();for(const n of r){const r=n.id;if(!(r in e))continue;let o=e[r];switch(n.type||"text"){case"password":case"text":case"textarea":default:o=String(o).trim();break;case"email":o=String(o).trim().toLowerCase();break;case"url":o=String(o).trim(),o=o.replace(/\/$/,"");break;case"checkbox":o=Boolean(o);break;case"number":o=Number(o)||0;break;case"select":(n.options||[]).map(e=>e.value).includes(o)&&(t[r]=o);continue;case"checkbox-group":if(Array.isArray(o)){const e=(n.options||[]).map(e=>e.value);e.length>0&&(o=o.filter(t=>e.includes(t)))}else o=[];t[r]=o;continue}t[r]=o}return(0,n.applyFilters)("aether.provider.config.sanitize",t,e,this.getId())}getConfigFields(){const e=[],t=function(e){const t=e.getSupportedDeploymentTypes();return t&&0!==t.length?{id:"deployment_types",type:"checkbox-group",label:(0,o.__)("Deployment Types","aether-site-exporter"),help:(0,o.__)("Select which types of deployments to use this provider for","aether-site-exporter"),required:!1,options:t.map(e=>({value:e,label:S[e]||e,description:x[e]||""})),defaultValue:t}:null}(this);t&&e.push(t);const r=this.getProviderSpecificConfigFields?.()||[];return e.push(...r),(0,n.applyFilters)("aether.provider.config_fields",e,this.getId(),this)}getProviderSpecificConfigFields(){return[]}async deploy(){return{success:!0,message:"No deployment needed for this provider."}}async getStatus(){const e=await this.isConfigured();return{configured:e,healthy:e}}getSettingsUrl(){return`admin.php?page=aether#/settings/provider/${this.getId()}`}getDocumentationUrl(){return`https://docs.aether.dev/providers/${this.getId()}`}getMetadata(){const e={id:this.getId(),name:this.getName(),type:this.getType(),description:this.getDescription(),icon:this.getIcon(),supportedDeploymentTypes:this.getDeploymentTypesWithFilter(),configFields:this.getConfigFields(),settingsUrl:this.getSettingsUrl(),documentationUrl:this.getDocumentationUrl()};return(0,n.applyFilters)("aether.provider.metadata",e,this.getId())}async getDeploymentUrl(){const e=await this.getConfig();let t="";return e.pages_url?t=e.pages_url:e.worker_endpoint?t=e.worker_endpoint:e.public_url&&(t=e.public_url),(0,n.applyFilters)("aether.provider.deployment_url",t,e,this.getId())}getUploadStrategy(){return"storage"}async uploadFile(e,t,r={}){throw new Error("AbstractProvider.uploadFile() must be implemented by subclass")}async loadConfig(){return(await this.getConfigStorage()).load()}async getConfigStorage(){if(!this.configStorage){const{ConfigStorage:e}=await Promise.resolve().then(r.bind(r,231));this.configStorage=new e(this.getId())}return this.configStorage}async getConfigValue(e,t=null){const r=await this.getConfig();return void 0!==r[e]?r[e]:t}async hasConfigValue(e){const t=await this.getConfig();return Boolean(t[e])}getFieldsById(e){const t=this.getConfigFields(),r={};return t.forEach(e=>{const t=e.id||e.name||"";t&&(r[t]=e)}),e.filter(e=>r[e]).map(e=>r[e])}renderSettings(e,t){return null}hasCustomSettings(){return this.renderSettings!==A.prototype.renderSettings}}class T extends A{static ID="cloudflare";getSupportedDeploymentTypes(){return[$]}workerScripts={r2:"assets/workers/CloudflareR2Worker.js",git:"includes/Providers/GitHubPages/assets/worker/index-git.js",spaces:"includes/Providers/DigitalOceanSpaces/assets/worker/index-spaces.js"};deploymentInfo={};getId(){return this.registeredId||T.ID}getName(){return(0,o.__)("Cloudflare Workers","aether")}getType(){return"edge-computing"}getDescription(){return(0,o.__)("Deploy edge functions to 200+ global locations with Cloudflare Workers","aether")}getIcon(){return"âš¡"}getProviderSpecificConfigFields(){return[]}async deployWorker(e,t,r={},n=!1,s=null){if(!this.isValidWorkerType(e))return{success:!1,error:`Invalid worker type: ${e}`};const i=await this.validateCredentials();if(!i.valid)return{success:!1,error:i.error||(0,o.__)("Invalid credentials","aether")};if(!n){const e=await this.testTokenPermissions();if(!e.success)return{success:!1,error:e.error||(0,o.__)("Token permission test failed","aether")}}const d=this.generateWorkerName(e);if(n){const t=`${d}-dry-run`;return{success:!0,workerName:t,workerUrl:this.getWorkerUrlFromName(t),workerType:e,message:(0,o.__)("Dry run successful","aether")}}try{const n=await this.getConfig(),i=await async function(e,t,r,n,o={}){const s=`${I}/accounts/${e}/workers/scripts/${r}`,a=`----WebKitFormBoundary${Math.random().toString(36).substring(2,15)}`,i=function(e,t,r){let n="";n+=`--${r}\r\n`,n+='Content-Disposition: form-data; name="worker.js"; filename="worker.js"\r\n',n+="Content-Type: application/javascript+module\r\n\r\n",n+=e+"\r\n";const o={main_module:"worker.js"};return Object.keys(t).length>0&&(o.bindings=t),n+=`--${r}\r\n`,n+='Content-Disposition: form-data; name="metadata"\r\n',n+="Content-Type: application/json\r\n\r\n",n+=JSON.stringify(o)+"\r\n",n+=`--${r}--\r\n`,n}(n,o,a),c=h(t),d=await fetch(s,{method:"PUT",headers:{...c,"Content-Type":`multipart/form-data; boundary=${a}`},body:i});return d.ok?k({workerName:r,workerUrl:`https://${r}.workers.dev`}):_(b(await d.text(),d.status,"Worker deployment"))}(n.account_id,n.api_token,d,t,r);if(!i.success)return i;await this.saveDeploymentInfo(e,{worker_type:e,workerName:d,workerUrl:i.workerUrl,deployed_at:Date.now()});const u={success:!0,workerName:d,workerUrl:i.workerUrl,workerType:e,message:(0,o.__)("Worker deployed successfully","aether")};if(s){a(`[Aether] Attaching custom domain ${s} to worker ${d}...`);const e=await this.ensureCustomDomainAttached(d,s);e.success?(u.custom_domain=s,u.domainAttached=!0,u.message+=" (custom domain attached)",a("[Aether] Custom domain attached successfully")):(u.domainAttached=!1,u.domainError=e.error,c(`[Aether] Failed to attach custom domain: ${e.error}`))}return u}catch(e){return{success:!1,error:e.message||(0,o.__)("Worker deployment failed","aether")}}}async testConnection(){const e=await this.validateCredentials();if(!e.valid)return{success:!1,error:e.error||(0,o.__)("Invalid credentials","aether")};try{const e=await this.getConfig(),t=await v({path:`/aether/v1/providers/${this.getId()}/test`,method:"POST",data:{config:e}});return t.code&&t.message?{success:!1,error:t.message}:t.success?{success:!0,message:t.message||(0,o.__)("Connection successful","aether")}:{success:!1,error:t.error||t.message||(0,o.__)("Connection test failed","aether")}}catch(e){return{success:!1,error:e?.message||e?.data?.message||e?.error||(0,o.__)("Connection test failed","aether")}}}async deleteWorker(e,t=!1){const r=await this.validateCredentials();if(!r.valid)return{success:!1,error:r.error||(0,o.__)("Invalid credentials","aether")};if(t)return{success:!0,message:`Dry run: Would delete worker ${e}`};try{const t=await this.getConfig(),r=await async function(e,t,r){const n=`${I}/accounts/${e}/workers/scripts/${r}`,o=await fetch(n,{method:"DELETE",headers:h(t)});return 200===o.status||404===o.status?{success:!0,message:`Worker ${r} deleted successfully`}:_(b(await o.text(),o.status,"Worker deletion"))}(t.account_id,t.api_token,e);return r}catch(e){return{success:!1,error:e.message||(0,o.__)("Worker deletion failed","aether")}}}getWorkerUrl(e){const t=this.getDeploymentInfo();return t[e]&&t[e].workerUrl?t[e].workerUrl:""}generateWorkerName(e){return`aether-${e}-${Math.random().toString(36).substring(2,10)}`}getWorkerUrlFromName(e){return`https://${e}.workers.dev`}getSupportedOperations(){return["upload","delete","copy","cors-proxy","images","stream"]}async validateCredentials(){const e=await this.getConfig();return e.account_id?e.api_token?{valid:!0}:{valid:!1,error:(0,o.__)("API token is required","aether")}:{valid:!1,error:(0,o.__)("Account ID is required","aether")}}async testTokenPermissions(){const e=await this.getConfig();try{return await async function(e,t){return e&&t?/^[a-f0-9]{32}$/i.test(e)?t.length<20?_("API token appears too short (expected at least 20 characters)"):k(null,"Credentials validated. Connection will be tested during deployment."):_("Invalid account ID format (expected 32 character hex string)"):_("Account ID and API token are required")}(e.account_id,e.api_token)}catch(e){return{success:!1,error:e.message||(0,o.__)("Token permission test failed","aether")}}}isValidWorkerType(e){return["r2","git","spaces"].includes(e)}getDeploymentInfo(){return this.deploymentInfo}async saveDeploymentInfo(e,t){this.deploymentInfo[e]=t}prepareWorkerEnvironment(e,t){const r={};return"r2"===e&&(t.bucket_name&&(r.R2_BUCKET=t.bucket_name),t.account_id&&(r.CF_ACCOUNT_ID=t.account_id)),"media"===e&&(t.bucket_name&&(r.R2_BUCKET=t.bucket_name),t.images_account_hash&&(r.CF_IMAGES_ACCOUNT_HASH=t.images_account_hash),t.images_api_token&&(r.CF_IMAGES_TOKEN=t.images_api_token)),"spaces"===e&&(t.bucket_name&&(r.SPACES_BUCKET=t.bucket_name),t.region&&(r.SPACES_REGION=t.region)),r}async getZoneIdForHostname(e){const t=e.replace(/^https?:\/\//,"").replace(/\/.*$/,"");try{const e=await this.getConfig(),r=`https://api.cloudflare.com/client/v4/zones?name=${encodeURIComponent(t)}`,n=await fetch(r,{method:"GET",headers:{Authorization:`Bearer ${e.api_token}`,"Content-Type":"application/json"}});if(!n.ok)return i(`[Aether] Failed to get zone ID for ${t}: HTTP ${n.status}`),null;const o=await n.json();return o.result&&o.result.length>0?o.result[0].id:(c(`[Aether] Zone not found for hostname: ${t}`),null)}catch(e){return i("Error getting zone ID:",e.message),null}}async ensureCustomDomainAttached(e,t){try{const r=await this.getConfig(),n=await this.getZoneIdForHostname(t);if(!n)return{success:!1,error:(0,o.__)("Zone not found for hostname. Ensure the domain is added to your Cloudflare account.","aether")};const s=await C(r.account_id,r.api_token,e,t,n);if(s.success)return a(`[Aether] Custom domain ${t} attached to worker ${e}`),{success:!0,message:"Custom domain attached successfully"};if(!(409===s.statusCode||s.error&&s.error.toLowerCase().includes("already")))return s;a(`[Aether] Domain ${t} is already attached, attempting to resolve conflict...`);const i=await async function(e,t){const r=`${I}/accounts/${e}/workers/domains`,n=await fetch(r,{method:"GET",headers:h(t)});return n.ok?k({domains:(await n.json()).result||[]}):_(b(await n.text(),n.status,"List custom domains"))}(r.account_id,r.api_token);if(!i.success)return{success:!1,error:`Failed to list custom domains: ${i.error}`};const c=t.replace(/^https?:\/\//,"").replace(/\/.*$/,""),d=i.domains.find(e=>e.hostname===c);if(!d)return{success:!1,error:(0,o.__)("Domain conflict detected but could not find existing assignment","aether")};a(`[Aether] Removing domain from old worker: ${d.service}`);const u=await async function(e,t,r){const n=`${I}/accounts/${e}/workers/domains/${r}`,o=await fetch(n,{method:"DELETE",headers:h(t)});return 200===o.status||404===o.status?{success:!0,message:`Custom domain ${r} removed successfully`}:_(b(await o.text(),o.status,"Custom domain removal"))}(r.account_id,r.api_token,d.id);if(!u.success)return{success:!1,error:`Failed to remove old domain assignment: ${u.error}`};a("[Aether] Domain removed from old worker, retrying attachment...");const l=await C(r.account_id,r.api_token,e,t,n);return l.success?(a(`[Aether] Custom domain ${t} successfully attached to worker ${e} after conflict resolution`),{success:!0,message:"Custom domain attached successfully (replaced old assignment)"}):l}catch(e){return i("[Aether] Error ensuring custom domain:",e.message),{success:!1,error:e.message||(0,o.__)("Failed to attach custom domain","aether")}}}}const P=new T;(0,n.addFilter)("aether.provider.test","aether/cloudflare",(e,t,r)=>"cloudflare"!==t?e:async e=>await P.testConnection(e||r),10)})();