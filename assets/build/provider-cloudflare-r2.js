(()=>{"use strict";var e={n:t=>{var r=t&&t.__esModule?()=>t.default:()=>t;return e.d(r,{a:r}),r},d:(t,r)=>{for(var o in r)e.o(r,o)&&!e.o(t,o)&&Object.defineProperty(t,o,{enumerable:!0,get:r[o]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)};const t=window.wp.hooks,r=window.wp.i18n,o=[{id:"static_site",label:(0,r.__)("Static Site","altolith-deploy"),description:(0,r.__)("Export your WordPress site as static HTML files.","altolith-deploy"),fields:[]},{id:"blueprint",label:(0,r.__)("Blueprint","altolith-deploy"),description:(0,r.__)("Export WordPress Playground blueprint files.","altolith-deploy"),fields:[{id:"blueprint_subfolder",type:"text",label:(0,r.__)("Blueprint Subfolder","altolith-deploy"),default:"playground",placeholder:"playground",help:(0,r.__)('Subfolder where blueprint files will be stored (e.g., "playground" creates /playground/blueprint.json).',"altolith-deploy"),validation:{pattern:/^[a-zA-Z0-9_-]+$/,message:(0,r.__)("Subfolder must contain only letters, numbers, hyphens, and underscores.","altolith-deploy")}}]}];class l{static ID="cloudflare-r2";static FAMILY="cloudflare-r2";static NAME=(0,r.__)("Cloudflare R2","altolith-deploy-r2");static TYPE="cloud-storage";static DESCRIPTION=(0,r.__)("Cloudflare R2 object storage with zero egress fees. Supports static site exports and WordPress Playground blueprints.","altolith-deploy-r2");static ICON="☁️";static SUPPORTS_PARALLEL_EXECUTION=!0;static CONFIG_FIELDS=[{id:"credential_profile",label:(0,r.__)("Cloudflare Credentials","altolith-deploy-r2"),type:"profile",profile_category:"credentials",profile_type:"cloudflare",required:!0,help:(0,r.__)("Select or create a Cloudflare credentials profile with your Account ID and API Token.","altolith-deploy-r2")},{id:"bucket_name",label:(0,r.__)("Bucket Name","altolith-deploy-r2"),type:"text",required:!0,sensitive:!1,validation:{pattern:"^[a-z0-9][a-z0-9-]{1,61}[a-z0-9]$",minLength:3,maxLength:63,message:(0,r.__)("Bucket name must be 3-63 characters, start and end with alphanumeric, and contain only lowercase letters, numbers, and hyphens","altolith-deploy-r2")}},{id:"path",label:(0,r.__)("Path Prefix","altolith-deploy-r2"),type:"text",required:!1,sensitive:!1,placeholder:"my-site/",help:(0,r.__)('Optional path prefix for all uploaded files (e.g., "my-site/" will upload files as "my-site/index.html")',"altolith-deploy-r2"),validation:{pattern:"^[a-zA-Z0-9._/-]*$",message:(0,r.__)("Path can only contain letters, numbers, dots, underscores, hyphens, and forward slashes","altolith-deploy-r2")}},{id:"public_url",label:(0,r.__)("Custom Domain (Optional)","altolith-deploy-r2"),type:"url",required:!1,sensitive:!1,help:(0,r.__)("The custom domain for your site (e.g., https://example.com). If provided, the Deploy Worker button will automatically attach it to the worker. Also used for blueprint URL references.","altolith-deploy-r2")},{id:"worker_endpoint",label:(0,r.__)("Worker Endpoint URL","altolith-deploy-r2"),type:"url",required:!1,sensitive:!1,help:(0,r.__)("URL of the deployed Cloudflare Worker. Use the Deploy Worker button below to create one.","altolith-deploy-r2")},{id:"access_key_id",label:(0,r.__)("R2 Access Key ID","altolith-deploy-r2"),type:"text",required:!1,sensitive:!0,help:(0,r.__)("Only required for S3-compatible API access, not for Worker-based uploads.","altolith-deploy-r2"),validation:{minLength:16,maxLength:128,message:(0,r.__)("Access Key ID must be between 16 and 128 characters","altolith-deploy-r2")}},{id:"secret_access_key",label:(0,r.__)("R2 Secret Access Key","altolith-deploy-r2"),type:"text",required:!1,sensitive:!0,help:(0,r.__)("Only required for S3-compatible API access, not for Worker-based uploads.","altolith-deploy-r2"),validation:{minLength:32,maxLength:128,message:(0,r.__)("Secret Access Key must be between 32 and 128 characters","altolith-deploy-r2")}}];static getConfigFields(){return[...l.CONFIG_FIELDS,...(0,t.applyFilters)("altolith.outputTypes",o).flatMap(e=>e.fields||[])]}}class a{static ID="cloudflare";static CATEGORY="credentials";static NAME=(0,r.__)("Cloudflare Account","altolith-deploy-r2");static DESCRIPTION=(0,r.__)("Cloudflare API credentials for R2, Workers, and other Cloudflare services.","altolith-deploy-r2");static ICON="cloud";static FIELDS=[{id:"account_id",label:(0,r.__)("Cloudflare Account ID","altolith-deploy-r2"),type:"text",sensitive:!0,required:!0,help:(0,r.__)("Your Cloudflare Account ID (32-character hex string). Find it in your Cloudflare dashboard.","altolith-deploy-r2"),pattern:"^[a-f0-9]{32}$",patternError:(0,r.__)("Account ID must be a 32-character hexadecimal string","altolith-deploy-r2")},{id:"api_token",label:(0,r.__)("Cloudflare API Token","altolith-deploy-r2"),type:"text",sensitive:!0,required:!0,help:(0,r.__)("Cloudflare API Token with appropriate permissions. Create one in your Cloudflare dashboard under API Tokens.","altolith-deploy-r2")}];static TEST_ENDPOINT="/altolith/deploy-r2/profiles/cloudflare/test"}let i=null;function s(){"undefined"!=typeof window&&window.altolith?.ProfileTypeRegistry&&(i=window.altolith.ProfileTypeRegistry,i.register(a),(0,t.doAction)("altolith.profiles.types.register",a))}if((0,t.addFilter)("altolith.profiles.categories","altolith-deploy-r2/credentials-category",e=>e.some(e=>"credentials"===e.id)?e:[...e,{id:"credentials",name:(0,r.__)("Credentials","altolith-deploy-r2"),description:(0,r.__)("Authentication credentials for cloud services","altolith-deploy-r2"),icon:"admin-network"}]),"undefined"!=typeof window&&window.altolith?.ProfileTypeRegistry)s();else if("undefined"!=typeof window){const e=()=>{window.altolith?.ProfileTypeRegistry?s():setTimeout(e,100)};"loading"===document.readyState?document.addEventListener("DOMContentLoaded",e):e()}const n=window.wp.element,d=window.wp.components,c=window.wp.apiFetch;var p=e.n(c);const h=new Map;function u(e){return`${e.method||"GET"}:${e.path||""}:${e.data?JSON.stringify(e.data):""}`}const m=(e,t)=>{const r=u(e);if(h.has(r))return h.get(r);const o=t(e);return h.set(r,o),o.finally(()=>{h.delete(r)}),o},y=new Map,f={"/assets":6e5,"/settings":6e4,"/config":18e5,"/check-wporg":36e5};const _=(e,t)=>{if("GET"!==(e.method||"GET"))return t(e);const r=u(e),o=y.get(r);if(function(e,t){if(!e)return!1;const r=function(e){for(const[t,r]of Object.entries(f))if(e&&e.includes(t))return r;return 3e5}(t);return 0!==r&&Date.now()-e.timestamp<r}(o,e.path))return Promise.resolve(o.response);const l=t(e);return l.then(e=>(y.set(r,{response:e,timestamp:Date.now()}),e)).catch(e=>{throw e}),l};!function(){const e="undefined"!=typeof window&&window.altolithData&&window.altolithData.restUrl?window.altolithData.restUrl:"/wp-json/",t="undefined"!=typeof window&&window.altolithData&&window.altolithData.nonce?window.altolithData.nonce:"";p().use(p().createRootURLMiddleware(e)),t&&function(e){p().use(p().createNonceMiddleware(e))}(t),p().use(_),p().use(m)}();const w=p();function g(e,t){if(!e)return t;try{const r=JSON.parse(e);return r.errors&&Array.isArray(r.errors)&&r.errors.length>0&&r.errors[0].message?r.errors[0].message:r.error?"string"==typeof r.error?r.error:JSON.stringify(r.error):r.message?r.message:t}catch(r){return e||t}}function k(e=null,t=null){const r={success:!0,data:e};return t&&"object"==typeof e&&null!==e?r.data={...e,message:t}:t&&(r.data={message:t}),r}function b(e,t=null){const r={success:!1,error:"string"==typeof e?e:e?.message||"Unknown error"};return t&&Array.isArray(t)&&t.length>0&&(r.errors=t),r}const x=Object.prototype.toString,N=new Set(["network error","Failed to fetch","NetworkError when attempting to fetch resource.","The Internet connection appears to be offline.","Network request failed","fetch failed","terminated"," A network error occurred.","Network connection lost"]);function T(e,t,{min:r=0,allowInfinity:o=!1}={}){if(void 0!==t){if("number"!=typeof t||Number.isNaN(t))throw new TypeError(`Expected \`${e}\` to be a number${o?" or Infinity":""}.`);if(!o&&!Number.isFinite(t))throw new TypeError(`Expected \`${e}\` to be a finite number.`);if(t<r)throw new TypeError(`Expected \`${e}\` to be ≥ ${r}.`)}}class j extends Error{constructor(e){super(),e instanceof Error?(this.originalError=e,({message:e}=e)):(this.originalError=new Error(e),this.originalError.stack=this.stack),this.name="AbortError",this.message=e}}function v(e,t){return Number.isFinite(t)?t-(performance.now()-e):t}async function C({error:e,attemptNumber:t,retriesConsumed:r,startTime:o,options:l}){const a=e instanceof Error?e:new TypeError(`Non-error was thrown: "${e}". You should only throw errors.`);if(a instanceof j)throw a.originalError;const i=Number.isFinite(l.retries)?Math.max(0,l.retries-r):l.retries,s=l.maxRetryTime??Number.POSITIVE_INFINITY,n=Object.freeze({error:a,attemptNumber:t,retriesLeft:i,retriesConsumed:r});if(await l.onFailedAttempt(n),v(o,s)<=0)throw a;const d=await l.shouldConsumeRetry(n),c=v(o,s);if(c<=0||i<=0)throw a;if(a instanceof TypeError&&!function(e){var t;if(!e||(t=e,"[object Error]"!==x.call(t))||"TypeError"!==e.name||"string"!=typeof e.message)return!1;const{message:r,stack:o}=e;return"Load failed"===r?void 0===o||"__sentry_captured__"in e:!!r.startsWith("error sending request for url")||N.has(r)}(a)){if(d)throw a;return l.signal?.throwIfAborted(),!1}if(!await l.shouldRetry(n))throw a;if(!d)return l.signal?.throwIfAborted(),!1;const p=function(e,t){const r=Math.max(1,e+1),o=t.randomize?Math.random()+1:1;let l=Math.round(o*t.minTimeout*t.factor**(r-1));return l=Math.min(l,t.maxTimeout),l}(r,l),h=Math.min(p,c);return h>0&&await new Promise((e,t)=>{const r=()=>{clearTimeout(o),l.signal?.removeEventListener("abort",r),t(l.signal.reason)},o=setTimeout(()=>{l.signal?.removeEventListener("abort",r),e()},h);l.unref&&o.unref?.(),l.signal?.addEventListener("abort",r,{once:!0})}),l.signal?.throwIfAborted(),!0}class E{constructor(e,t,r={},o="cloudflare"){this.accountId=e,this.apiToken=t,this.config=r,this.providerId=o,this.cloudflareApiBase="https://api.cloudflare.com/client/v4"}async cloudflareApiRequest(e,t={}){const r=`${this.cloudflareApiBase}${e}`,o={...function(e,t="Bearer"){return{Authorization:`${t} ${e}`,"Content-Type":"application/json"}}(this.apiToken),...t.headers||{}};try{const e=await async function(e,t={}){if(function(e){if("number"==typeof e){if(e<0)throw new TypeError("Expected `retries` to be a non-negative number.");if(Number.isNaN(e))throw new TypeError("Expected `retries` to be a valid number or Infinity, got NaN.")}else if(void 0!==e)throw new TypeError("Expected `retries` to be a number or Infinity.")}((t={...t}).retries),Object.hasOwn(t,"forever"))throw new Error("The `forever` option is no longer supported. For many use-cases, you can set `retries: Infinity` instead.");t.retries??=10,t.factor??=2,t.minTimeout??=1e3,t.maxTimeout??=Number.POSITIVE_INFINITY,t.maxRetryTime??=Number.POSITIVE_INFINITY,t.randomize??=!1,t.onFailedAttempt??=()=>{},t.shouldRetry??=()=>!0,t.shouldConsumeRetry??=()=>!0,T("factor",t.factor,{min:0,allowInfinity:!1}),T("minTimeout",t.minTimeout,{min:0,allowInfinity:!1}),T("maxTimeout",t.maxTimeout,{min:0,allowInfinity:!0}),T("maxRetryTime",t.maxRetryTime,{min:0,allowInfinity:!0}),t.factor>0||(t.factor=1),t.signal?.throwIfAborted();let r=0,o=0;const l=performance.now();for(;!Number.isFinite(t.retries)||o<=t.retries;){r++;try{t.signal?.throwIfAborted();const o=await e(r);return t.signal?.throwIfAborted(),o}catch(e){await C({error:e,attemptNumber:r,retriesConsumed:o,startTime:l,options:t})&&o++}}throw new Error("Retry attempts exhausted without throwing an error.")}(async()=>await fetch(r,{...t,headers:o}),{retries:3,minTimeout:1e3,maxTimeout:3e4,shouldRetry:e=>"TypeError"===e.name&&e.message.includes("fetch")}),l=await e.json();if(!e.ok||!l.success){return b(g(JSON.stringify(l),"Cloudflare API request failed"),l.errors||[])}return k({result:l.result})}catch(e){return b(e.message||"Network request failed")}}async deploy(e,t,r={},o=!1){if(o){const t=this.generateWorkerName(e);return k({workerName:t+"-dry-run",workerUrl:this.getWorkerUrlFromName(t+"-dry-run")},"Dry run successful")}const l=this.generateWorkerName(e);if("r2"===e)try{const e=await w({path:"/altolith/v1/providers/cloudflare-r2/deploy-worker",method:"POST",data:{worker_name:l,script:t,bindings:r}});return e.success?k({workerName:e.worker_name,workerUrl:e.worker_url}):b(e.error||"Worker deployment failed")}catch(e){return b(e.message||"Worker deployment failed")}try{const e=new FormData,o=new Blob([t],{type:"application/javascript+module"});e.append("worker.js",o,"worker.js");const a={main_module:"worker.js",bindings:[]};for(const[e,t]of Object.entries(r))"r2_bucket"===t.type&&a.bindings.push({type:"r2_bucket",name:e,bucket_name:t.bucket_name});e.append("metadata",new Blob([JSON.stringify(a)],{type:"application/json"}),"metadata.json");const i=`/accounts/${this.accountId}/workers/scripts/${l}`,s=await this.cloudflareApiRequest(i,{method:"PUT",body:e});if(!s.success)return b(s.error||"Worker deployment failed");const n=this.getWorkerUrlFromName(l);return await this.enableWorkersDevSubdomain(l),k({workerName:l,workerUrl:n})}catch(e){return b(e.message||"Worker deployment failed")}}async enableWorkersDevSubdomain(e){try{const t=`/accounts/${this.accountId}/workers/subdomain`,r=await this.cloudflareApiRequest(t,{method:"GET"});if(!r.success)return b(r.error);const o=r.data?.result?.subdomain;if(!o)return b("No subdomain configured");const l=`/accounts/${this.accountId}/workers/scripts/${e}/subdomain`,a=await this.cloudflareApiRequest(l,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({enabled:!0})});return a.success?k():b(a.error)}catch(e){return b(e.message)}}async testDeployment(e,t=""){if(!t)return k({deployed:!1},"Worker not deployed");try{const e=await this.listWorkers();if(!e.success)return b(e.error||"Failed to verify API token permissions")}catch(e){return b(e.message||"Token permission test failed")}const r=this.extractWorkerNameFromUrl(t);if(r)try{if((await this.getWorker(r)).success)return k({deployed:!0,workerUrl:t},"Worker is deployed and accessible")}catch{}return k({deployed:!0,workerUrl:t},"Worker URL provided but verification failed")}async listWorkers(){const e=`/accounts/${this.accountId}/workers/scripts`,t=await this.cloudflareApiRequest(e,{method:"GET"});return t.success?k({workers:t.data?.result||[]}):b(t.error||"Failed to list workers")}async getWorker(e){const t=`/accounts/${this.accountId}/workers/scripts/${e}`,r=await this.cloudflareApiRequest(t,{method:"GET"});return r.success?k({worker:r.data?.result}):b(r.error||"Failed to get worker info")}async getZoneIdForHostname(e){const t=`/zones?name=${encodeURIComponent(e)}`,r=await this.cloudflareApiRequest(t,{method:"GET"});if(!r.success)return b(r.error||"Failed to get zone ID");const o=r.data?.result||[];return 0===o.length?b(`No zone found for hostname: ${e}`):k({zoneId:o[0].id,zoneName:o[0].name})}async attachWorkerToCustomDomain(e,t,r){const o=t.replace(/^https?:\/\//,"").replace(/\/.*$/,""),l=`/accounts/${this.accountId}/workers/domains`,a=await this.cloudflareApiRequest(l,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({environment:"production",hostname:o,service:e,zone_id:r,override_existing_dns_record:!0})});return a.success?k(null,`Worker attached to ${o}`):b(a.error||"Failed to attach worker to custom domain")}async testConnection(e=""){const t={success:!0,workersApi:!1,r2Access:!1,errors:[]};try{const e=await this.listWorkers();e.success?t.workersApi=!0:(t.errors.push(`Workers API: ${e.error}`),t.success=!1)}catch(e){t.errors.push(`Workers API: ${e.message}`),t.success=!1}if(e)try{const r="connection-test-"+Date.now(),o=`${e.replace(/\/+$/,"")}/${r}/test.html`,l=await fetch(o,{method:"GET"});404===l.status||l.ok?t.r2Access=!0:(t.errors.push(`R2 Worker: HTTP ${l.status}`),t.success=!1)}catch(e){t.errors.push(`R2 Worker: ${e.message}`),t.success=!1}return t}getWorkerUrl(){return this.config.worker_endpoint||""}isDeployed(e){return!!this.getWorkerUrl(e)}async getWorkerScript(e=null,t=""){if(!t&&e&&(t=e,e=null),!t)return"";const r=e||this.providerId;try{const e=await w({path:`/altolith/v1/providers/${r}/edge/worker-script/${t}`,method:"GET"});return"string"==typeof e?e:""}catch{return""}}getWorkerBindings(e,t){if("r2"===e){const e=t.bucket_name||"";return e?{R2_BUCKET:{type:"r2_bucket",bucket_name:e}}:{}}return{}}generateWorkerName(e){return`altolith-${e}-${Math.random().toString(36).substring(2,10)}`}getWorkerUrlFromName(e){return`https://${e}.workers.dev`}extractWorkerNameFromUrl(e){const t=e.match(/https?:\/\/([^.]+)\.workers\.dev/);return t?t[1]:null}}const I={title:(0,r.__)("Required API Token Permissions","altolith-deploy-r2"),sections:[{title:(0,r.__)("R2 Storage","altolith-deploy-r2"),items:[{permission:"R2: Edit",description:(0,r.__)("Read and write files to R2 bucket","altolith-deploy-r2")}]},{title:(0,r.__)("Workers (for deployment)","altolith-deploy-r2"),items:[{permission:"Workers Scripts: Edit",description:(0,r.__)("Deploy and update Workers","altolith-deploy-r2")},{permission:"Workers Routes: Edit",description:(0,r.__)("Attach custom domains to Workers","altolith-deploy-r2")}]},{title:(0,r.__)("DNS (for custom domains)","altolith-deploy-r2"),items:[{permission:"Zone: Read",description:(0,r.__)("Look up zone IDs for custom domains","altolith-deploy-r2")}]}],createTokenUrl:"https://dash.cloudflare.com/profile/api-tokens"},S={title:(0,r.__)("Manual Worker Deployment","altolith-deploy-r2"),steps:[(0,r.__)("Go to Cloudflare Dashboard > Workers & Pages","altolith-deploy-r2"),(0,r.__)('Click "Create" and select "Create Worker"',"altolith-deploy-r2"),(0,r.__)('Name your worker (e.g., "my-r2-static-site")',"altolith-deploy-r2"),(0,r.__)("Go to Settings > Variables > R2 Bucket Bindings","altolith-deploy-r2"),(0,r.__)('Add binding: Variable name "R2_BUCKET", select your bucket',"altolith-deploy-r2"),(0,r.__)("Deploy the worker and copy the URL","altolith-deploy-r2")],workersUrl:"https://dash.cloudflare.com/?to=/:account/workers-and-pages"},A={title:(0,r.__)("Manual Domain Attachment","altolith-deploy-r2"),steps:[(0,r.__)("Go to Cloudflare Dashboard > Workers & Pages","altolith-deploy-r2"),(0,r.__)("Select your worker","altolith-deploy-r2"),(0,r.__)("Go to Settings > Triggers > Custom Domains","altolith-deploy-r2"),(0,r.__)('Click "Add Custom Domain"',"altolith-deploy-r2"),(0,r.__)("Enter your domain and confirm","altolith-deploy-r2")],note:(0,r.__)("Ensure the domain is on the same Cloudflare account and proxied through Cloudflare (orange cloud).","altolith-deploy-r2"),docsUrl:"https://developers.cloudflare.com/workers/configuration/routing/custom-domains/"},R="https://developers.cloudflare.com/workers/runtime-apis/bindings/",P=window.ReactJSXRuntime;function $(){const[e,t]=(0,n.useState)(!1),o={margin:"0.5rem 0 0.75rem",paddingLeft:"1.5rem"},l={marginBottom:"0.25rem"};return(0,P.jsxs)("div",{className:"altolith-r2-setup-guide"+(e?" altolith-r2-setup-guide--expanded":""),style:{marginBottom:"1rem",padding:"0.75rem 1rem",backgroundColor:"#f0f6fc",borderLeft:"4px solid #2271b1",borderRadius:"2px"},children:[(0,P.jsxs)("div",{className:"altolith-r2-setup-guide__header",style:{display:"flex",alignItems:"center",justifyContent:"space-between",margin:0},children:[(0,P.jsx)("strong",{className:"altolith-r2-setup-guide__title",children:(0,r.__)("Before you begin","altolith-deploy-r2")}),(0,P.jsx)(d.Button,{className:"altolith-r2-setup-guide__toggle",variant:"link",onClick:()=>t(!e),style:{padding:0,height:"auto",minHeight:"auto"},"aria-expanded":e,children:e?(0,r.__)("Hide details","altolith-deploy-r2"):(0,r.__)("Show details","altolith-deploy-r2")})]}),!e&&(0,P.jsxs)("p",{className:"altolith-r2-setup-guide__summary",style:{margin:"0.5rem 0 0",fontSize:"13px"},children:[(0,r.__)("You need a Cloudflare API token with R2, Workers, and Zone permissions.","altolith-deploy-r2")," ",(0,P.jsx)(d.ExternalLink,{className:"altolith-r2-setup-guide__link",href:I.createTokenUrl,children:(0,r.__)("Create API Token","altolith-deploy-r2")})]}),e&&(0,P.jsxs)("div",{className:"altolith-r2-setup-guide__content",style:{marginTop:"0.75rem",fontSize:"13px",lineHeight:"1.6"},children:[(0,P.jsx)("p",{className:"altolith-r2-setup-guide__intro",style:{margin:"0 0 0.5rem"},children:(0,r.__)("Create a Cloudflare API token with these permissions:","altolith-deploy-r2")}),I.sections.map((e,t)=>(0,P.jsxs)("div",{className:"altolith-r2-setup-guide__section",style:{marginBottom:"0.5rem"},children:[(0,P.jsx)("strong",{className:"altolith-r2-setup-guide__section-title",style:{fontSize:"12px",color:"#50575e"},children:e.title}),(0,P.jsx)("ul",{className:"altolith-r2-setup-guide__list",style:o,children:e.items.map((e,t)=>(0,P.jsxs)("li",{className:"altolith-r2-setup-guide__list-item",style:l,children:[(0,P.jsx)("code",{className:"altolith-r2-setup-guide__permission",children:e.permission})," - ",e.description]},t))})]},t)),(0,P.jsx)("p",{className:"altolith-r2-setup-guide__footer",style:{margin:0},children:(0,P.jsx)(d.ExternalLink,{className:"altolith-r2-setup-guide__link",href:I.createTokenUrl,children:(0,r.__)("Create API Token in Cloudflare Dashboard","altolith-deploy-r2")})})]})]})}function F(){const[e,t]=(0,n.useState)(!1),o={marginBottom:"0.35rem"};return(0,P.jsxs)("div",{className:"altolith-api-token-help"+(e?" altolith-api-token-help--expanded":""),style:{marginTop:"0.5rem"},children:[(0,P.jsx)(d.Button,{className:"altolith-api-token-help__toggle",variant:"link",onClick:()=>t(!e),style:{padding:0,height:"auto",minHeight:"auto",fontSize:"12px"},"aria-expanded":e,children:e?(0,r.__)("Hide token creation steps","altolith-deploy-r2"):(0,r.__)("How to create an API token","altolith-deploy-r2")}),e&&(0,P.jsxs)("div",{className:"altolith-api-token-help__content",style:{marginTop:"0.5rem",padding:"0.75rem",backgroundColor:"#f6f7f7",borderRadius:"4px",fontSize:"12px",lineHeight:"1.6"},children:[(0,P.jsxs)("ol",{className:"altolith-api-token-help__steps",style:{margin:"0.5rem 0",paddingLeft:"1.25rem"},children:[(0,P.jsx)("li",{className:"altolith-api-token-help__step-item",style:o,children:(0,r.__)("Go to Cloudflare Dashboard > My Profile > API Tokens","altolith-deploy-r2")}),(0,P.jsx)("li",{className:"altolith-api-token-help__step-item",style:o,children:(0,r.__)('Click "Create Token"',"altolith-deploy-r2")}),(0,P.jsx)("li",{className:"altolith-api-token-help__step-item",style:o,children:(0,r.__)('Select "Create Custom Token"',"altolith-deploy-r2")}),(0,P.jsxs)("li",{className:"altolith-api-token-help__step-item",style:o,children:[(0,r.__)("Add these permissions:","altolith-deploy-r2"),(0,P.jsxs)("ul",{className:"altolith-api-token-help__permissions",style:{marginTop:"0.25rem",marginBottom:"0.25rem",paddingLeft:"1.25rem",listStyleType:"disc"},children:[(0,P.jsx)("li",{className:"altolith-api-token-help__permission-item",children:"Account > Workers Scripts > Edit"}),(0,P.jsx)("li",{className:"altolith-api-token-help__permission-item",children:"Account > Workers Routes > Edit"}),(0,P.jsx)("li",{className:"altolith-api-token-help__permission-item",children:"Zone > Zone > Read (select your zones)"})]})]}),(0,P.jsx)("li",{className:"altolith-api-token-help__step-item",style:o,children:(0,r.__)("Create the token and copy it here","altolith-deploy-r2")})]}),(0,P.jsx)(d.ExternalLink,{className:"altolith-api-token-help__link",href:"https://developers.cloudflare.com/fundamentals/api/get-started/create-token/",children:(0,r.__)("View Cloudflare Documentation","altolith-deploy-r2")})]})]})}function W({errorType:e,hostname:t}){const[o,l]=(0,n.useState)(!1),a={marginTop:"0.5rem"},i={padding:0,height:"auto",minHeight:"auto",fontSize:"12px",color:"#2271b1"},s={marginTop:"0.5rem",padding:"0.75rem",backgroundColor:"#fff8e5",borderRadius:"4px",fontSize:"12px",lineHeight:"1.6"},c={margin:"0.5rem 0",paddingLeft:"1.25rem"},p={marginBottom:"0.35rem"};return"worker_deployment"===e?(0,P.jsxs)("div",{className:"altolith-deployment-error-help altolith-deployment-error-help--worker"+(o?" altolith-deployment-error-help--expanded":""),style:a,children:[(0,P.jsx)(d.Button,{className:"altolith-deployment-error-help__toggle",variant:"link",onClick:()=>l(!o),style:i,"aria-expanded":o,children:o?(0,r.__)("Hide manual instructions","altolith-deploy-r2"):(0,r.__)("How to deploy manually","altolith-deploy-r2")}),o&&(0,P.jsxs)("div",{className:"altolith-deployment-error-help__content",style:s,children:[(0,P.jsx)("p",{className:"altolith-deployment-error-help__text",style:{margin:"0 0 0.5rem"},children:(0,r.__)("If automatic deployment fails, you can deploy the worker manually:","altolith-deploy-r2")}),(0,P.jsx)("ol",{className:"altolith-deployment-error-help__steps",style:c,children:S.steps.map((e,t)=>(0,P.jsx)("li",{className:"altolith-deployment-error-help__step-item",style:p,children:e},t))}),(0,P.jsx)(d.ExternalLink,{className:"altolith-deployment-error-help__link",href:S.workersUrl,children:(0,r.__)("Open Workers & Pages","altolith-deploy-r2")})," | ",(0,P.jsx)(d.ExternalLink,{className:"altolith-deployment-error-help__link",href:R,children:(0,r.__)("View Bindings Documentation","altolith-deploy-r2")})]})]}):"domain_attachment"===e?(0,P.jsxs)("div",{className:"altolith-deployment-error-help altolith-deployment-error-help--domain"+(o?" altolith-deployment-error-help--expanded":""),style:a,children:[(0,P.jsx)(d.Button,{className:"altolith-deployment-error-help__toggle",variant:"link",onClick:()=>l(!o),style:i,"aria-expanded":o,children:o?(0,r.__)("Hide manual instructions","altolith-deploy-r2"):(0,r.__)("How to attach domain manually","altolith-deploy-r2")}),o&&(0,P.jsxs)("div",{className:"altolith-deployment-error-help__content",style:s,children:[(0,P.jsx)("p",{className:"altolith-deployment-error-help__text",style:{margin:"0 0 0.5rem"},children:(0,r.__)("If custom domain attachment fails, configure it manually:","altolith-deploy-r2")}),(0,P.jsx)("ol",{className:"altolith-deployment-error-help__steps",style:c,children:A.steps.map((e,r)=>(0,P.jsx)("li",{className:"altolith-deployment-error-help__step-item",style:p,children:4===r&&t?`${e}: ${t}`:e},r))}),(0,P.jsx)("p",{className:"altolith-deployment-error-help__note",style:{marginTop:"0.5rem",fontStyle:"italic",color:"#50575e"},children:A.note}),(0,P.jsx)(d.ExternalLink,{className:"altolith-deployment-error-help__link",href:A.docsUrl,children:(0,r.__)("View Custom Domains Documentation","altolith-deploy-r2")})]})]}):null}function D({isOpen:e,onClose:t,bucketName:o}){const[l,a]=(0,n.useState)(!1),[i,s]=(0,n.useState)(""),[c,p]=(0,n.useState)(!1),[h,u]=(0,n.useState)(null);if((0,n.useEffect)(()=>{e&&!i&&(async()=>{p(!0),u(null);try{const e=window.altolithSepPluginUrl||"";if(!e)throw new Error("Plugin URL not available");const t=await fetch(e+"assets/workers/CloudflareR2Worker.js");if(!t.ok)throw new Error(`Failed to fetch worker code: ${t.status}`);const r=await t.text();s(r)}catch(e){u(e.message)}finally{p(!1)}})()},[e,i]),!e)return null;const m={marginBottom:"1.5rem"},y={fontSize:"1rem",fontWeight:"600",marginBottom:"0.5rem",marginTop:0},f={margin:"0.5rem 0",paddingLeft:"1.5rem"},_={marginBottom:"0.5rem",lineHeight:"1.6"};return(0,P.jsx)(d.Modal,{title:(0,r.__)("Manual Worker Setup Instructions","altolith-deploy-r2"),onRequestClose:t,style:{maxWidth:"800px",width:"90vw"},className:"altolith-manual-worker-modal",children:(0,P.jsxs)("div",{className:"altolith-manual-worker-modal__content",children:[(0,P.jsxs)("div",{className:"altolith-manual-worker-modal__section",style:m,children:[(0,P.jsx)("h3",{className:"altolith-manual-worker-modal__heading",style:y,children:(0,r.__)("Step 1: Create a Worker","altolith-deploy-r2")}),(0,P.jsxs)("ol",{className:"altolith-manual-worker-modal__steps",style:f,children:[(0,P.jsxs)("li",{className:"altolith-manual-worker-modal__step-item",style:_,children:[(0,r.__)("Go to","altolith-deploy-r2")," ",(0,P.jsx)("a",{className:"altolith-manual-worker-modal__link",href:"https://dash.cloudflare.com/?to=/:account/workers-and-pages",target:"_blank",rel:"noopener noreferrer",children:"Cloudflare Dashboard > Workers & Pages"})]}),(0,P.jsx)("li",{className:"altolith-manual-worker-modal__step-item",style:_,children:(0,r.__)('Click "Create" and select "Create Worker"',"altolith-deploy-r2")}),(0,P.jsx)("li",{className:"altolith-manual-worker-modal__step-item",style:_,children:(0,r.__)('Name your worker (e.g., "altolith-r2-mysite")',"altolith-deploy-r2")}),(0,P.jsx)("li",{className:"altolith-manual-worker-modal__step-item",style:_,children:(0,r.__)('Click "Deploy" to create the worker with default code',"altolith-deploy-r2")})]})]}),(0,P.jsxs)("div",{className:"altolith-manual-worker-modal__section",style:m,children:[(0,P.jsx)("h3",{className:"altolith-manual-worker-modal__heading",style:y,children:(0,r.__)("Step 2: Add R2 Bucket Binding","altolith-deploy-r2")}),(0,P.jsxs)("ol",{className:"altolith-manual-worker-modal__steps",style:f,children:[(0,P.jsx)("li",{className:"altolith-manual-worker-modal__step-item",style:_,children:(0,r.__)("In your worker, go to Settings > Variables","altolith-deploy-r2")}),(0,P.jsx)("li",{className:"altolith-manual-worker-modal__step-item",style:_,children:(0,r.__)('Scroll down to "R2 Bucket Bindings"',"altolith-deploy-r2")}),(0,P.jsx)("li",{className:"altolith-manual-worker-modal__step-item",style:_,children:(0,r.__)('Click "Add binding"',"altolith-deploy-r2")}),(0,P.jsxs)("li",{className:"altolith-manual-worker-modal__step-item",style:_,children:[(0,P.jsx)("strong",{children:(0,r.__)("Variable name:","altolith-deploy-r2")})," ",(0,P.jsx)("code",{className:"altolith-manual-worker-modal__code",children:"R2_BUCKET"})," ",(0,r.__)("(must be exactly this name)","altolith-deploy-r2")]}),(0,P.jsxs)("li",{className:"altolith-manual-worker-modal__step-item",style:_,children:[(0,P.jsx)("strong",{children:(0,r.__)("R2 bucket:","altolith-deploy-r2")})," ",o?(0,P.jsxs)(P.Fragment,{children:[(0,r.__)("Select","altolith-deploy-r2")," ",(0,P.jsx)("code",{className:"altolith-manual-worker-modal__code",children:o})]}):(0,r.__)("Select your R2 bucket","altolith-deploy-r2")]}),(0,P.jsx)("li",{className:"altolith-manual-worker-modal__step-item",style:_,children:(0,r.__)('Click "Save" to save the binding',"altolith-deploy-r2")})]})]}),(0,P.jsxs)("div",{className:"altolith-manual-worker-modal__section",style:m,children:[(0,P.jsx)("h3",{className:"altolith-manual-worker-modal__heading",style:y,children:(0,r.__)("Step 3: Replace Worker Code","altolith-deploy-r2")}),(0,P.jsxs)("ol",{className:"altolith-manual-worker-modal__steps",style:f,children:[(0,P.jsx)("li",{className:"altolith-manual-worker-modal__step-item",style:_,children:(0,r.__)('Go to your worker\'s "Code" tab',"altolith-deploy-r2")}),(0,P.jsx)("li",{className:"altolith-manual-worker-modal__step-item",style:_,children:(0,r.__)("Delete all existing code","altolith-deploy-r2")}),(0,P.jsx)("li",{className:"altolith-manual-worker-modal__step-item",style:_,children:(0,r.__)("Paste the code below:","altolith-deploy-r2")})]}),(0,P.jsxs)("div",{className:"altolith-manual-worker-modal__code-block",style:{position:"relative",marginTop:"0.5rem"},children:[c&&(0,P.jsxs)("div",{className:"altolith-manual-worker-modal__loading",style:{display:"flex",alignItems:"center",justifyContent:"center",padding:"2rem",gap:"0.5rem"},children:[(0,P.jsx)(d.Spinner,{}),(0,P.jsx)("span",{className:"altolith-manual-worker-modal__loading-text",children:(0,r.__)("Loading worker code…","altolith-deploy-r2")})]}),h&&(0,P.jsx)(d.Notice,{className:"altolith-manual-worker-modal__error",status:"error",isDismissible:!1,children:h}),!c&&!h&&i&&(0,P.jsxs)(P.Fragment,{children:[(0,P.jsx)("div",{className:"altolith-manual-worker-modal__copy-button-container",style:{display:"flex",justifyContent:"flex-end",marginBottom:"0.5rem"},children:(0,P.jsx)(d.Button,{className:"altolith-manual-worker-modal__copy-button",variant:"secondary",onClick:async()=>{if(i)try{await navigator.clipboard.writeText(i),a(!0),setTimeout(()=>a(!1),3e3)}catch{const e=document.createElement("textarea");e.value=i,document.body.appendChild(e),e.select(),document.execCommand("copy"),document.body.removeChild(e),a(!0),setTimeout(()=>a(!1),3e3)}},disabled:l,children:l?(0,r.__)("Copied!","altolith-deploy-r2"):(0,r.__)("Copy Code","altolith-deploy-r2")})}),(0,P.jsx)(d.TextareaControl,{className:"altolith-manual-worker-modal__code-textarea",value:i,readOnly:!0,rows:15,style:{fontFamily:"monospace",fontSize:"12px",backgroundColor:"#1e1e1e",color:"#d4d4d4"}})]})]})]}),(0,P.jsxs)("div",{className:"altolith-manual-worker-modal__section",style:m,children:[(0,P.jsx)("h3",{className:"altolith-manual-worker-modal__heading",style:y,children:(0,r.__)("Step 4: Deploy and Copy URL","altolith-deploy-r2")}),(0,P.jsxs)("ol",{className:"altolith-manual-worker-modal__steps",style:f,children:[(0,P.jsx)("li",{className:"altolith-manual-worker-modal__step-item",style:_,children:(0,r.__)('Click "Save and Deploy" to deploy your worker',"altolith-deploy-r2")}),(0,P.jsx)("li",{className:"altolith-manual-worker-modal__step-item",style:_,children:(0,r.__)("Copy the worker URL (e.g., https://altolith-r2-mysite.your-subdomain.workers.dev)","altolith-deploy-r2")}),(0,P.jsx)("li",{className:"altolith-manual-worker-modal__step-item",style:_,children:(0,r.__)('Paste it in the "Worker Endpoint URL" field in this form',"altolith-deploy-r2")})]})]}),(0,P.jsxs)(d.Notice,{className:"altolith-manual-worker-modal__important-notice",status:"info",isDismissible:!1,children:[(0,P.jsx)("strong",{children:(0,r.__)("Important:","altolith-deploy-r2")})," ",(0,r.__)('The R2 bucket binding variable name MUST be exactly "R2_BUCKET" (case-sensitive). The worker will not work without this binding.',"altolith-deploy-r2")]}),(0,P.jsxs)("div",{className:"altolith-manual-worker-modal__help-note",style:{backgroundColor:"#f0f6fc",padding:"0.75rem 1rem",borderLeft:"4px solid #2271b1",borderRadius:"2px",marginTop:"1rem",fontSize:"0.875rem"},children:[(0,P.jsx)("strong",{children:(0,r.__)("Need more help?","altolith-deploy-r2")}),(0,P.jsx)("br",{}),(0,P.jsx)("a",{className:"altolith-manual-worker-modal__link",href:R,target:"_blank",rel:"noopener noreferrer",children:(0,r.__)("R2 Bucket Bindings Documentation","altolith-deploy-r2")})," | ",(0,P.jsx)("a",{className:"altolith-manual-worker-modal__link",href:"https://developers.cloudflare.com/r2/",target:"_blank",rel:"noopener noreferrer",children:(0,r.__)("R2 Overview","altolith-deploy-r2")})]}),(0,P.jsx)("div",{className:"altolith-manual-worker-modal__actions",style:{marginTop:"1.5rem",display:"flex",justifyContent:"flex-end"},children:(0,P.jsx)(d.Button,{className:"altolith-manual-worker-modal__close-button",variant:"primary",onClick:t,children:(0,r.__)("Close","altolith-deploy-r2")})})]})})}const O=new Map;let U=!1,L=null;const B=new class{async loadAll(e=!1){if(U&&!e)return this.getAll();if(L)return L;L=this._fetchProfiles();try{return await L}finally{L=null}}async _fetchProfiles(){try{const e=await p()({path:"/altolith/deploy/profiles",method:"GET"});return O.clear(),e.profiles&&Array.isArray(e.profiles)&&e.profiles.forEach(e=>{O.set(e.id,e)}),U=!0,(0,t.doAction)("altolith.profiles.loaded",this.getAll()),this.getAll()}catch(e){throw console.error("Failed to load profiles:",e),e}}get(e){return O.get(e)||null}getAll(){return Array.from(O.values())}getByCategory(e){return this.getAll().filter(t=>t.category===e)}getByType(e,t){return this.getAll().filter(r=>r.category===e&&r.type===t)}async create(e){try{const r=await p()({path:"/altolith/deploy/profiles",method:"POST",data:e});if(r.profile)return O.set(r.profile.id,r.profile),(0,t.doAction)("altolith.profiles.created",r.profile),r.profile;throw new Error(r.message||"Failed to create profile")}catch(e){throw console.error("Failed to create profile:",e),e}}async update(e,r){try{const o=await p()({path:`/altolith/deploy/profiles/${e}`,method:"PUT",data:r});if(o.profile)return O.set(e,o.profile),(0,t.doAction)("altolith.profiles.updated",o.profile),o.profile;throw new Error(o.message||"Failed to update profile")}catch(e){throw console.error("Failed to update profile:",e),e}}async delete(e){try{const r=await p()({path:`/altolith/deploy/profiles/${e}`,method:"DELETE"});if(r.success){const r=O.get(e);return O.delete(e),(0,t.doAction)("altolith.profiles.deleted",e,r),!0}throw new Error(r.message||"Failed to delete profile")}catch(e){throw console.error("Failed to delete profile:",e),e}}async getReferences(e){try{return(await p()({path:`/altolith/deploy/profiles/${e}/references`,method:"GET"})).references||[]}catch(e){throw console.error("Failed to get profile references:",e),e}}async test(e){try{return await p()({path:`/altolith/deploy/profiles/${e}/test`,method:"POST"})}catch(e){throw console.error("Failed to test profile:",e),e}}isLoaded(){return U}count(){return O.size}clearCache(){O.clear(),U=!1,L=null}_cacheProfile(e){e&&e.id&&O.set(e.id,e)}};let M=B;"undefined"!=typeof window&&(window.altolith=window.altolith||{},window.altolith.ProfileRegistry?M=window.altolith.ProfileRegistry:window.altolith.ProfileRegistry=B);const z=M;function q({providerId:e,config:t,onChange:o}){const[l,a]=(0,n.useState)(!1),[i,s]=(0,n.useState)(null),[c,p]=(0,n.useState)(!1),[h,u]=(0,n.useState)(null),[m,y]=(0,n.useState)(!1),[f,_]=(0,n.useState)(null),[g,k]=(0,n.useState)(!1);return(0,P.jsxs)("div",{style:{marginTop:"1rem",paddingTop:"1rem",borderTop:"1px solid #ddd"},children:[(0,P.jsxs)("div",{style:{display:"flex",gap:"0.5rem",alignItems:"center"},children:[(0,P.jsx)(d.Button,{variant:"secondary",onClick:async()=>{a(!0),s(null),p(!1),u(null),y(!1),_(null);try{if(!t?.credential_profile||!t?.bucket_name)throw new Error((0,r.__)("Credential profile and Bucket Name are required to deploy the worker","altolith-deploy-r2"));const l=z.get(t.credential_profile);if(!l||!l.fields)throw new Error((0,r.__)("Could not load credential profile. Please select a valid profile.","altolith-deploy-r2"));const{account_id:a,api_token:i}=l.fields;if(!a||!i)throw new Error((0,r.__)("Credential profile is missing Account ID or API Token","altolith-deploy-r2"));const s=(window.altolithData?.restUrl||window.wpApiSettings?.root||"/wp-json").replace(/\/$/,""),n=window.altolithData?.nonce||window.wpApiSettings?.nonce||"",d=`altolith-r2-${Math.random().toString(36).substring(2,10)}`,c={};t.bucket_name&&(c.R2_BUCKET={type:"r2_bucket",bucket_name:t.bucket_name});const h=`${s}/altolith/deploy/providers/cloudflare/deploy-worker`,m=await fetch(h,{method:"POST",headers:{"X-WP-Nonce":n,"Content-Type":"application/json"},body:JSON.stringify({worker_type:"r2",worker_name:d,bindings:c,account_id:a,api_token:i})});if(!m.ok){const e=await m.json().catch(()=>({message:`HTTP ${m.status}: ${m.statusText}`}));throw new Error(e.message||e.error||(0,r.__)("Failed to deploy worker","altolith-deploy-r2"))}const f=await m.json();if(!f.success)throw new Error(f.message||f.error||(0,r.__)("Failed to deploy worker","altolith-deploy-r2"));if(f.worker_url){o&&"function"==typeof o&&o("worker_endpoint",f.worker_url);try{const t=await w({path:`/altolith/deploy/providers/${e}/config`,method:"GET"}),r=t?.config||{};await w({path:`/altolith/deploy/providers/${e}/config`,method:"POST",data:{config:{...r,worker_endpoint:f.worker_url}}})}catch{}}if(f.worker_url&&t.public_url)try{const e=new E(a,i,t,"cloudflare-r2"),o=t.public_url.replace(/^https?:\/\//,"").split("/")[0],l=o.split(".").slice(-2).join("."),s=await e.getZoneIdForHostname(l);if(s.success&&s.data?.zoneId){const t=f.worker_url.match(/https?:\/\/([^.]+)/)?.[1];if(t){const r=await e.attachWorkerToCustomDomain(t,o,s.data.zoneId);r.success?y(!0):_(r.error)}}else _(s.error||(0,r.__)("Could not find zone for domain","altolith-deploy-r2"))}catch(e){_(e.message)}p(!0),u(f.worker_url||null),setTimeout(()=>{p(!1)},1e4)}catch(e){s(e.message||(0,r.__)("Failed to deploy worker","altolith-deploy-r2"))}finally{a(!1)}},isBusy:l,disabled:l||!t?.credential_profile||!t?.bucket_name,children:l?(0,r.__)("Deploying…","altolith-deploy-r2"):(0,r.__)("Deploy Worker","altolith-deploy-r2")}),(0,P.jsx)(d.Button,{variant:"tertiary",onClick:()=>k(!0),children:(0,r.__)("Manual Setup","altolith-deploy-r2")})]}),i&&(0,P.jsxs)(P.Fragment,{children:[(0,P.jsx)(d.Notice,{status:"error",isDismissible:!1,style:{marginTop:"0.5rem"},children:i}),(0,P.jsx)(W,{errorType:"worker_deployment"})]}),c&&(0,P.jsxs)(d.Notice,{status:"success",isDismissible:!1,style:{marginTop:"0.5rem"},children:[(0,r.__)("Worker deployed successfully!","altolith-deploy-r2"),h&&(0,P.jsxs)("div",{style:{marginTop:"0.5rem"},children:[(0,P.jsx)("strong",{children:(0,r.__)("Worker URL:","altolith-deploy-r2")})," ",(0,P.jsx)("a",{href:h,target:"_blank",rel:"noopener noreferrer",children:h})]}),m&&t.public_url&&(0,P.jsxs)("div",{style:{marginTop:"0.5rem"},children:[(0,P.jsx)("strong",{children:(0,r.__)("Custom domain attached:","altolith-deploy-r2")})," ",(0,P.jsx)("a",{href:t.public_url,target:"_blank",rel:"noopener noreferrer",children:t.public_url.replace(/^https?:\/\//,"").split("/")[0]})]}),f&&(0,P.jsxs)(P.Fragment,{children:[(0,P.jsxs)("div",{style:{marginTop:"0.5rem",color:"#d63638"},children:[(0,P.jsx)("strong",{children:(0,r.__)("Custom domain warning:","altolith-deploy-r2")})," ",f]}),(0,P.jsx)(W,{errorType:"domain_attachment",hostname:t.public_url?.replace(/^https?:\/\//,"").split("/")[0]})]})]}),(0,P.jsx)(D,{isOpen:g,onClose:()=>k(!1),bucketName:t?.bucket_name})]})}const K=new Map,H=new class{register(e,r){if(!e||"string"!=typeof e)throw new Error("ProviderRegistry.register() requires a valid provider ID string");if(!r||"function"!=typeof r)throw new Error("ProviderRegistry.register() requires a provider class");if(!r.ID)throw new Error(`Provider ${e} must have static ID property`);if(!r.NAME)throw new Error(`Provider ${e} must have static NAME property`);K.set(e,r),(0,t.doAction)("altolith.providers.registered",e,r)}get(e){return K.get(e)||null}getAll(){return Array.from(K.values())}getAllIds(){return Array.from(K.keys())}has(e){return K.has(e)}count(){return K.size}parseInstanceId(e){if(!e||"string"!=typeof e)return null;const t=e.split(":",2);return 2===t.length&&t[0]&&t[1]?{provider_type:t[0],uuid:t[1]}:null}getProviderForInstance(e){const t=this.parseInstanceId(e);return t?this.get(t.provider_type):null}createInstanceId(e){return`${e}:${"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{const t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)})}`}clear(){K.clear()}};(0,t.addAction)("altolith.providers.register","altolith/provider-registry",e=>{if(!e||"function"!=typeof e)return;const t=e.ID;t&&H.register(t,e)});let G=H;if("undefined"!=typeof window)if(window.altolith=window.altolith||{},window.altolith.ProviderRegistry){const e=window.altolith.ProviderRegistry;Array.from(K.values()).forEach(t=>{const r=t.ID;e.get(r)||e.register(r,t)}),G=e}else window.altolith.ProviderRegistry=H;const X=G,J=5242880;async function V(e,t,r,o={}){return r.size>20971520?async function(e,t,r,o={}){const l=r.size,a=o.contentType||r.type||"application/octet-stream",i=o.cacheControl||"",s=await async function(e,t,r,o){const l=await fetch(e,{method:"POST",headers:{"Content-Type":"application/json","X-R2-Action":"initiate-multipart"},body:JSON.stringify({key:t,contentType:r,cacheControl:o})});return l.ok&&(await l.json()).uploadId||null}(e,t,a,i);if(!s)return b("Failed to initiate multipart upload");const n=[],d=Math.ceil(l/J),c=o.onProgress||null;for(let o=1;o<=d;o++){const a=(o-1)*J,i=Math.min(a+J,l),d=r.slice(a,i),p=await d.arrayBuffer(),h=await Y(e,t,s,o,p);if(!h)return await Z(e,t,s),b(`Failed to upload part ${o}`);if(n.push({partNumber:o,etag:h}),c){const e=o*J;c(Math.min(e,l),l,null)}}const p=await async function(e,t,r,o){return(await fetch(e,{method:"POST",headers:{"Content-Type":"application/json","X-R2-Action":"complete-multipart"},body:JSON.stringify({key:t,uploadId:r,parts:o})})).ok}(e,t,s,n);return p?k():(await Z(e,t,s),b("Failed to complete multipart upload"))}(e,t,r,o):async function(e,t,r,o={}){const l=o.contentType||r.type||"application/octet-stream",a=o.cacheControl||"",i=o.onProgress||null;return new Promise((o,s)=>{const n=new XMLHttpRequest;n.timeout=3e5,i&&n.upload.addEventListener("progress",e=>{if(e.lengthComputable){const t=Math.round(e.loaded/e.total*100);i(e.loaded,e.total,t)}}),n.addEventListener("timeout",()=>{s(new Error("Upload timed out after 300000ms"))}),n.addEventListener("load",()=>{if(n.status>=200&&n.status<300)return void o(k());let e=`Upload failed: ${n.status}`;e=g(n.responseText,e),o(b(e))}),n.addEventListener("error",()=>{s(new Error("Upload failed: network error"))}),n.addEventListener("abort",()=>{s(new Error("Upload aborted"))}),n.open("POST",e),n.setRequestHeader("Content-Type","application/octet-stream"),n.setRequestHeader("X-R2-Key",encodeURIComponent(t)),n.setRequestHeader("X-R2-Content-Type",l),a&&n.setRequestHeader("X-R2-Cache-Control",a),n.send(r)})}(e,t,r,o)}async function Y(e,t,r,o,l){const a=await fetch(e,{method:"POST",headers:{"Content-Type":"application/octet-stream","X-R2-Key":encodeURIComponent(t),"X-R2-Upload-Id":r,"X-R2-Part-Number":String(o)},body:l});return a.ok&&(await a.json()).etag||null}async function Z(e,t,r){return(await fetch(e,{method:"POST",headers:{"Content-Type":"application/json","X-R2-Action":"abort-multipart"},body:JSON.stringify({key:t,uploadId:r})})).ok}async function Q(e,t="",r=1e3){const o=await fetch(e,{method:"POST",headers:{"Content-Type":"application/json","X-R2-Action":"list"},body:JSON.stringify({prefix:t,limit:r})});return o.ok?k({objects:(await o.json()).objects||[]}):b(g(await o.text(),`List failed: ${o.status}`))}class ee{constructor(e,t,r={},o=null){this.workerEndpoint=e,this.bucketName=t,this.config=r,this.providerId=r.provider_id||"",this.pathPrefix=r.path||"",this.uploadAdapter=o}getFullKey(e){return this.pathPrefix?this.pathPrefix.replace(/\/$/,"")+"/"+e.replace(/^\//,""):e}async upload(e,t,r={}){if(!(t instanceof File||t instanceof Blob))return{success:!1,error:"File must be a File or Blob object"};const o=r.contentType||t.type;try{let l;if(this.uploadAdapter&&"function"==typeof this.uploadAdapter.upload)l=await this.uploadAdapter.upload(e,t,{...r,contentType:o});else{const a=this.getFullKey(e),i={contentType:o,cacheControl:r.cacheControl||"",onProgress:r.onProgress||null};l=await V(this.workerEndpoint,a,t,i)}return l.success?{success:!0,url:this.getUrl(e)}:l}catch(e){return{success:!1,error:e.message||"Upload failed"}}}async delete(e){const t=this.getFullKey(e);return async function(e,t){const r=await fetch(e,{method:"POST",headers:{"Content-Type":"application/json","X-R2-Action":"delete"},body:JSON.stringify({key:t})});return r.ok?k():b(g(await r.text(),`Delete failed: ${r.status}`))}(this.workerEndpoint,t)}async copy(e,t){const r=this.getFullKey(e),o=this.getFullKey(t);return async function(e,t,r){const o=await fetch(e,{method:"POST",headers:{"Content-Type":"application/json","X-R2-Action":"copy"},body:JSON.stringify({sourceKey:t,destKey:r})});return o.ok?k():b(g(await o.text(),`Copy failed: ${o.status}`))}(this.workerEndpoint,r,o)}async exists(e){const t=this.getFullKey(e),r=await Q(this.workerEndpoint,t,1);return!!r.success&&(r.objects||[]).some(e=>e.key===t)}async listObjects(e="",t=1e3){const r=this.getFullKey(e);return Q(this.workerEndpoint,r,t)}getUrl(e){const t=this.getFullKey(e);return this.config.public_url?`${this.config.public_url.replace(/\/$/,"")}/${t}`:function(e,t,r){return`${e.replace(/\/$/,"")}/${t}/${r}`}(this.workerEndpoint,this.bucketName,t)}async batchCopy(e){const t=e.map(e=>({source:this.getFullKey(e.source),dest:this.getFullKey(e.dest)}));return async function(e,t){const r=await fetch(e,{method:"POST",headers:{"Content-Type":"application/json","X-R2-Action":"batch-copy"},body:JSON.stringify({operations:t})});if(!r.ok)return b(g(await r.text(),`Batch copy failed: ${r.status}`));const o=await r.json();return k({copied:o.copied||0,errors:o.errors||0,results:o.results||[]})}(this.workerEndpoint,t)}async batchDelete(e){const t=e.map(e=>this.getFullKey(e));return async function(e,t){const r=await fetch(e,{method:"POST",headers:{"Content-Type":"application/json","X-R2-Action":"batch-delete"},body:JSON.stringify({keys:t})});return r.ok?k():b(g(await r.text(),`Batch delete failed: ${r.status}`))}(this.workerEndpoint,t)}async downloadManifest(){const e=this.providerId?`file-manifest-${this.providerId}.json`:"file-manifest.json",t=this.getFullKey(e);try{return await async function(e,t){const r=await fetch(e,{method:"POST",headers:{"Content-Type":"application/json","X-R2-Action":"download"},body:JSON.stringify({key:t})});if(!r.ok){if(404===r.status)return null;const e=await r.text();throw new Error(`Download failed: ${r.status} - ${e}`)}return r.blob()}(this.workerEndpoint,t)}catch(e){return null}}async uploadManifest(e){const t=this.providerId?`file-manifest-${this.providerId}.json`:"file-manifest.json";return await this.upload(t,e,{contentType:"application/json"})}async testConnection(){const e=await Q(this.workerEndpoint,"",1);return e.success?{success:!0,message:"Successfully connected to Cloudflare R2."}:{success:!1,error:e.error||"Failed to list objects"}}}async function te(e){try{return(await w({path:`/altolith/deploy/providers/${e}/config`,method:"GET"})).config||{}}catch(e){if("restProviderNotConfigured"===e.code||404===e.status)return{};throw e}}X.register(l.ID,l),(0,t.doAction)("altolith.providers.register",l);const re=new Map;function oe(e,t){return{async upload(r,o,l={}){let a=o;if(0===o.size&&(l.sourceUrl||l.sourcePath)){let e=l.sourceUrl;if(!e&&l.sourcePath&&(e=`${l.metadata?.siteUrl||window.location.origin}/wp-json/altolith/deploy/export-file?path=${encodeURIComponent(l.sourcePath)}`),e)try{const t="undefined"!=typeof window&&window.altolithData?.nonce?window.altolithData.nonce:"",r={"Content-Type":"application/octet-stream"};t&&(r["X-WP-Nonce"]=t);const o=await fetch(e,{credentials:"same-origin",headers:r});if(!o.ok)return{success:!1,error:`Failed to fetch server-side file for R2 upload: ${o.statusText}`};a=await o.blob()}catch(e){return{success:!1,error:`Failed to fetch server-side file: ${e.message}`}}}const i=t.path||"",s=i?i.replace(/\/$/,"")+"/"+r.replace(/^\//,""):r;return V(e,s,a,{contentType:l.contentType||a.type})}}}async function le(e){const t=await te(e);if(!t?.worker_endpoint||!t?.bucket_name)return null;const r={public_url:t.public_url||null,provider_id:e,path:t.path||""},o=oe(t.worker_endpoint,r);return new ee(t.worker_endpoint,t.bucket_name,r,o)}var ae;(0,t.addFilter)("altolith.storage.service.create","altolith/cloudflare-r2",(e,t,r,o,l)=>{if(!o?.startsWith("cloudflare-r2:"))return e;const a=l||r;if(!a?.worker_endpoint||!a?.bucket_name)return null;const i={...r,public_url:a.public_url||null,provider_id:o,path:a.path||""},s=oe(a.worker_endpoint,i);return new ee(a.worker_endpoint,a.bucket_name,i,s)},10),(0,t.addAction)("altolith.file.upload","altolith/cloudflare-r2",e=>{e._uploadPromises||(e._uploadPromises=[]),e._uploadPromises.push(async function(e){const{fileType:t,providerId:r,filePath:o,storageKey:l}=e;if(!r||!r.startsWith("cloudflare-r2:"))return;const a=`${r}:${l||o}`,i=re.get(a);if(!0===i)return;if(i instanceof Promise){try{await i}catch{re.get(a)===i&&re.delete(a)}if(!0===re.get(a))return}const s=(async()=>{try{const a=await le(r);if(!a)throw new Error("Storage service not available. Please configure worker_endpoint and bucket_name.");if(!o)throw new Error("File path is required");if("blueprint-bundle"===t){if(!o.startsWith("http://")&&!o.startsWith("https://"))throw new Error("Blueprint bundle must be provided as a URL for R2 uploads");const t=await fetch(o,{method:"GET",credentials:"omit"});if(!t.ok)throw new Error(`Failed to fetch blueprint bundle: HTTP ${t.status}`);const i=await te(r),s=l||`${i?.blueprint_subfolder||"playground"}/bundle.zip`,n=await a.upload(s,await t.blob(),{contentType:"application/zip"});if(!n.success)throw new Error(n.error||"Blueprint bundle upload failed");e.result={success:!0,url:n.url}}}catch(t){throw e.result={success:!1,error:t.message||"Unknown error"},t}re.set(a,!0)})().catch(e=>{throw re.get(a)===s&&re.delete(a),e});re.set(a,s),await s}(e))},10),(0,t.addFilter)("altolith.provider.test","altolith/cloudflare-r2",(e,t)=>t?.startsWith("cloudflare-r2:")?async()=>{const e=await le(t);return e?e.testConnection():{success:!1,error:"Storage service not configured. Please set worker_endpoint and bucket_name."}}:e,10),(0,t.addFilter)("altolith.provider.upload_strategy","altolith/cloudflare-r2",(e,t)=>t?.startsWith("cloudflare-r2:")?"worker":e,10),(0,t.addFilter)("altolith.blueprint.path","altolith/cloudflare-r2",(e,t,r)=>r?.startsWith("cloudflare-r2:")&&t?.blueprint_subfolder?t.blueprint_subfolder:e,10),(0,t.addFilter)("altolith.url.rewrite","altolith/cloudflare-r2/path-prefix",(e,t)=>{const{providerId:r,providerConfig:o}=t;if(!r?.startsWith("cloudflare-r2:"))return e;const l=o?.path;if(!l)return e;const a="/"+l.replace(/^\/|\/$/g,"");try{const t=new URL(e);return t.pathname=a+t.pathname,t.toString()}catch{return e.startsWith("/")?a+e:e}},10),ae="cloudflare-r2",(0,t.addFilter)("altolith.admin.provider.modal.header",`altolith/${ae}/setup-guide`,(e,t)=>t.providerId?.startsWith(ae)?(0,P.jsx)($,{}):e),(0,t.addFilter)("altolith.admin.provider.field.after",`altolith/${ae}/api-token-help`,(e,t)=>"api_token"===t.fieldId&&t.providerId?.startsWith(ae)?(0,P.jsxs)(P.Fragment,{children:[e,(0,P.jsx)(F,{})]}):e,5),(0,t.addFilter)("altolith.admin.provider.field.after",`altolith/${ae}/deploy-button`,(e,t)=>"worker_endpoint"===t.fieldId&&t.providerId?.startsWith(ae)?(0,P.jsxs)(P.Fragment,{children:[e,(0,P.jsx)(q,{providerId:t.providerId,config:t.formValues||{},onChange:t.onFormChange})]}):e,10)})();