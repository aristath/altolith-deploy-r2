(()=>{"use strict";var e={231:(e,t,r)=>{r.d(t,{ConfigStorage:()=>U});var o=r(455),n=r.n(o);const s=new Map;function i(e){return`${e.method||"GET"}:${e.path||""}:${e.data?JSON.stringify(e.data):""}`}const a=(e,t)=>{const r=i(e);if(s.has(r))return s.get(r);const o=t(e);return s.set(r,o),o.finally(()=>{s.delete(r)}),o},c=new Map,d={"/assets":6e5,"/settings":6e4,"/config":18e5,"/check-wporg":36e5};const l=(e,t)=>{if("GET"!==(e.method||"GET"))return t(e);const r=i(e),o=c.get(r);if(function(e,t){if(!e)return!1;const r=function(e){for(const[t,r]of Object.entries(d))if(e&&e.includes(t))return r;return 3e5}(t);return 0!==r&&Date.now()-e.timestamp<r}(o,e.path))return Promise.resolve(o.response);const n=t(e);return n.then(e=>(c.set(r,{response:e,timestamp:Date.now()}),e)).catch(e=>{throw e}),n};!function(){const e=function(){const e=document.querySelector('meta[name="aether-rest-url"]');return e&&e.getAttribute("content")||"/wp-json/aether/site-exporter/"}(),t=function(){const e=document.querySelector('meta[name="aether-rest-nonce"]');return e&&e.getAttribute("content")||""}();n().use(n().createRootURLMiddleware(e)),t&&function(e){n().use(n().createNonceMiddleware(e))}(t),n().use(l),n().use(a)}();const u=n();var p=r(619);const h=(e,t)=>t.some(t=>e instanceof t);let g,f;const m=new WeakMap,y=new WeakMap,w=new WeakMap;let b={get(e,t,r){if(e instanceof IDBTransaction){if("done"===t)return m.get(e);if("store"===t)return r.objectStoreNames[1]?void 0:r.objectStore(r.objectStoreNames[0])}return _(e[t])},set:(e,t,r)=>(e[t]=r,!0),has:(e,t)=>e instanceof IDBTransaction&&("done"===t||"store"===t)||t in e};function v(e){b=e(b)}function k(e){return"function"==typeof e?(t=e,(f||(f=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])).includes(t)?function(...e){return t.apply(I(this),e),_(this.request)}:function(...e){return _(t.apply(I(this),e))}):(e instanceof IDBTransaction&&function(e){if(m.has(e))return;const t=new Promise((t,r)=>{const o=()=>{e.removeEventListener("complete",n),e.removeEventListener("error",s),e.removeEventListener("abort",s)},n=()=>{t(),o()},s=()=>{r(e.error||new DOMException("AbortError","AbortError")),o()};e.addEventListener("complete",n),e.addEventListener("error",s),e.addEventListener("abort",s)});m.set(e,t)}(e),h(e,g||(g=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction]))?new Proxy(e,b):e);var t}function _(e){if(e instanceof IDBRequest)return function(e){const t=new Promise((t,r)=>{const o=()=>{e.removeEventListener("success",n),e.removeEventListener("error",s)},n=()=>{t(_(e.result)),o()},s=()=>{r(e.error),o()};e.addEventListener("success",n),e.addEventListener("error",s)});return w.set(t,e),t}(e);if(y.has(e))return y.get(e);const t=k(e);return t!==e&&(y.set(e,t),w.set(t,e)),t}const I=e=>w.get(e),x=["get","getKey","getAll","getAllKeys","count"],S=["put","add","delete","clear"],E=new Map;function T(e,t){if(!(e instanceof IDBDatabase)||t in e||"string"!=typeof t)return;if(E.get(t))return E.get(t);const r=t.replace(/FromIndex$/,""),o=t!==r,n=S.includes(r);if(!(r in(o?IDBIndex:IDBObjectStore).prototype)||!n&&!x.includes(r))return;const s=async function(e,...t){const s=this.transaction(e,n?"readwrite":"readonly");let i=s.store;return o&&(i=i.index(t.shift())),(await Promise.all([i[r](...t),n&&s.done]))[0]};return E.set(t,s),s}v(e=>({...e,get:(t,r,o)=>T(t,r)||e.get(t,r,o),has:(t,r)=>!!T(t,r)||e.has(t,r)}));const C=["continue","continuePrimaryKey","advance"],A={},D=new WeakMap,P=new WeakMap,$={get(e,t){if(!C.includes(t))return e[t];let r=A[t];return r||(r=A[t]=function(...e){D.set(this,P.get(this)[t](...e))}),r}};async function*N(...e){let t=this;if(t instanceof IDBCursor||(t=await t.openCursor(...e)),!t)return;const r=new Proxy(t,$);for(P.set(r,t),w.set(r,I(t));t;)yield r,t=await(D.get(r)||t.continue()),D.delete(r)}function F(e,t){return t===Symbol.asyncIterator&&h(e,[IDBIndex,IDBObjectStore,IDBCursor])||"iterate"===t&&h(e,[IDBIndex,IDBObjectStore])}v(e=>({...e,get:(t,r,o)=>F(t,r)?N:e.get(t,r,o),has:(t,r)=>F(t,r)||e.has(t,r)}));const R=new Map,j={dbName:"aether-site-exporter",version:1,stores:{cache:{keyPath:"key",indexes:[{name:"timestamp",keyPath:"timestamp",unique:!1},{name:"type",keyPath:"type",unique:!1}]}}};const B=class{constructor(e,t=j){this.storeName=e,this.config=t,this.db=null,this.keyPath=t.stores?.[e]?.keyPath||j.stores.cache.keyPath}async ensureDatabase(){return this.db||(this.db=await async function(e=j){const t=`${e.dbName}_v${e.version}`;if(R.has(t))return R.get(t);try{const r=await function(e,t,{blocked:r,upgrade:o,blocking:n,terminated:s}={}){const i=indexedDB.open(e,t),a=_(i);return o&&i.addEventListener("upgradeneeded",e=>{o(_(i.result),e.oldVersion,e.newVersion,_(i.transaction),e)}),r&&i.addEventListener("blocked",e=>r(e.oldVersion,e.newVersion,e)),a.then(e=>{s&&e.addEventListener("close",()=>s()),n&&e.addEventListener("versionchange",e=>n(e.oldVersion,e.newVersion,e))}).catch(()=>{}),a}(e.dbName,e.version,{upgrade(t){Object.entries(e.stores).forEach(([e,r])=>{t.objectStoreNames.contains(e)&&t.deleteObjectStore(e);const o=t.createObjectStore(e,{keyPath:r.keyPath,autoIncrement:r.autoIncrement||!1});r.indexes&&r.indexes.forEach(e=>{o.createIndex(e.name,e.keyPath,{unique:e.unique||!1})})})}});return R.set(t,r),r}catch(e){throw new Error(`Failed to open IndexedDB: ${e.message||"Unknown error"}`)}}(this.config)),this.db}async get(e){try{const t=await this.ensureDatabase();return await t.get(this.storeName,e)||null}catch(t){return console.error(`[IndexedDB] Error getting key "${e}":`,t),null}}async getAll(e=void 0){try{const t=await this.ensureDatabase();return await t.getAll(this.storeName,void 0,e)||[]}catch(e){return console.error("[IndexedDB] Error getting all values:",e),[]}}async getAllKeys(){try{const e=await this.ensureDatabase();return await e.getAllKeys(this.storeName)||[]}catch(e){return console.error("[IndexedDB] Error getting all keys:",e),[]}}async set(e,t,r={}){try{const o=await this.ensureDatabase(),n="object"==typeof t&&null!==t?{...t}:{value:t},s={[this.keyPath]:e,...n,timestamp:Date.now(),...r};return await o.put(this.storeName,s),!0}catch(t){return("QuotaExceededError"===t.name||t.message?.includes("quota"))&&console.warn("[IndexedDB] Storage quota exceeded. Consider cleaning up old data."),console.error(`[IndexedDB] Error setting key "${e}":`,t),!1}}async delete(e){try{const t=await this.ensureDatabase();return await t.delete(this.storeName,e),!0}catch(t){return console.error(`[IndexedDB] Error deleting key "${e}":`,t),!1}}async clear(){try{const e=await this.ensureDatabase();return await e.clear(this.storeName),!0}catch(e){return console.error("[IndexedDB] Error clearing store:",e),!1}}async count(){try{const e=await this.ensureDatabase();return await e.count(this.storeName)||0}catch(e){return console.error("[IndexedDB] Error counting items:",e),0}}async getByIndex(e,t){try{const r=await this.ensureDatabase();return await r.getAllFromIndex(this.storeName,e,t)||[]}catch(t){return console.error(`[IndexedDB] Error getting by index "${e}":`,t),[]}}async deleteOlderThan(e){try{const t=await this.ensureDatabase(),r=Date.now()-e,o=t.transaction(this.storeName,"readwrite"),n=o.objectStore(this.storeName).index("timestamp");let s=0,i=await n.openCursor(IDBKeyRange.upperBound(r));for(;i;)await i.delete(),s++,i=await i.continue();return await o.done,s}catch(e){return console.error("[IndexedDB] Error deleting old items:",e),0}}async getStorageEstimate(){if(navigator.storage&&navigator.storage.estimate)try{const e=await navigator.storage.estimate();return{quota:e.quota,usage:e.usage,percentUsed:e.quota>0?e.usage/e.quota*100:0}}catch(e){console.error("[IndexedDB] Error getting storage estimate:",e)}return{quota:null,usage:null,percentUsed:null}}},W={dbName:"aether-provider-configs",version:1,stores:{configs:{keyPath:"cacheKey",indexes:[{name:"timestamp",keyPath:"timestamp",unique:!1},{name:"providerId",keyPath:"providerId",unique:!1}]}}};let O=null;function q(){return O||(O=new B("configs",W)),O}class U{providerId;cacheKey;store;constructor(e){if(!e||"string"!=typeof e)throw new Error("ConfigStorage requires a valid provider ID");this.providerId=e,this.cacheKey=`provider:${e}`,this.store=q()}async load(){const e=await this.getFromCache();if(null!==e)return e;try{let e=(await u({path:`/aether/site-exporter/providers/${this.providerId}/config`,method:"GET"})).config||{};return e=(0,p.applyFilters)("aether.storage.config.load",e,this.providerId),this.saveToCache(e),(0,p.doAction)("aether.storage.config.loaded",e,this.providerId),e}catch(e){if("restProviderNotConfigured"===e.code||404===e.status)return{};throw e}}async save(e){e=(0,p.applyFilters)("aether.storage.config.before_save",e,this.providerId);try{return await u({path:`/aether/site-exporter/providers/${this.providerId}/config`,method:"POST",data:{config:e}}),this.saveToCache(e),(0,p.doAction)("aether.storage.config.saved",e,this.providerId),!0}catch(e){throw e}}async delete(){(0,p.doAction)("aether.storage.config.before_delete",this.providerId);try{return await u({path:`/aether/site-exporter/providers/${this.providerId}/config`,method:"DELETE"}),this.clearCache(),(0,p.doAction)("aether.storage.config.deleted",this.providerId),!0}catch(e){throw e}}async getFromCache(){try{const e=await this.store.get(this.cacheKey);return e?Date.now()-e.timestamp>3e5?(await this.clearCache(),null):e.config:null}catch(e){return await this.clearCache(),null}}async saveToCache(e){try{await this.store.set(this.cacheKey,{config:e},{providerId:this.providerId})}catch(e){console.error(`[ConfigStorage] Failed to cache config for ${this.providerId}:`,e)}}async clearCache(){try{await this.store.delete(this.cacheKey)}catch(e){console.error(`[ConfigStorage] Failed to clear cache for ${this.providerId}:`,e)}}static async invalidateCache(e){const t=new U(e);await t.clearCache()}static async clearAllCaches(){try{const e=q();await e.clear()}catch(e){console.error("[ConfigStorage] Failed to clear all caches:",e)}}}},455:e=>{e.exports=window.wp.apiFetch},619:e=>{e.exports=window.wp.hooks}},t={};function r(o){var n=t[o];if(void 0!==n)return n.exports;var s=t[o]={exports:{}};return e[o](s,s.exports,r),s.exports}r.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return r.d(t,{a:t}),t},r.d=(e,t)=>{for(var o in t)r.o(t,o)&&!r.o(e,o)&&Object.defineProperty(e,o,{enumerable:!0,get:t[o]})},r.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t);var o=r(619);const n=window.wp.i18n;function s(){return"undefined"!=typeof window&&!0===window.aetherDebug}function i(...e){s()&&window.console&&window.console.log&&window.console.log("[Aether]",...e)}function a(...e){s()&&window.console&&window.console.error&&window.console.error("[Aether Error]",...e)}function c(...e){s()&&window.console&&window.console.warn&&window.console.warn("[Aether Warning]",...e)}const d={debug:i,error:a,warn:c,info:function(...e){s()&&window.console&&window.console.info&&window.console.info("[Aether Info]",...e)},table:function(e){s()&&window.console&&window.console.table&&window.console.table(e)},time:function(e){s()&&window.console&&window.console.time&&window.console.time(`[Aether] ${e}`)},timeEnd:function(e){s()&&window.console&&window.console.timeEnd&&window.console.timeEnd(`[Aether] ${e}`)},group:function(e){s()&&window.console&&window.console.group&&window.console.group(`[Aether] ${e}`)},groupEnd:function(){s()&&window.console&&window.console.groupEnd&&window.console.groupEnd()},enable:function(){"undefined"!=typeof window&&(window.aetherDebug=!0,i("Debug mode enabled"))},disable:function(){"undefined"!=typeof window&&(window.aetherDebug=!1)},isEnabled:s};function l(e,t){if(!e)return t;try{const r=JSON.parse(e);return r.errors&&Array.isArray(r.errors)&&r.errors.length>0&&r.errors[0].message?r.errors[0].message:r.error?"string"==typeof r.error?r.error:JSON.stringify(r.error):r.message?r.message:t}catch(r){return e||t}}function u(e=null,t=null){const r={success:!0,data:e};return t&&"object"==typeof e&&null!==e?r.data={...e,message:t}:t&&(r.data={message:t}),r}function p(e,t=null){const r={success:!1,error:"string"==typeof e?e:e?.message||"Unknown error"};return t&&Array.isArray(t)&&t.length>0&&(r.errors=t),r}"undefined"!=typeof window&&(window.aetherDebug=window.aetherDebug||!1,window.aetherDebugUtil=d);const h=20971520,g=5242880;async function f(e,t,r,o,n){const s=await fetch(e,{method:"POST",headers:{"Content-Type":"application/octet-stream","X-R2-Key":t,"X-R2-Upload-Id":r,"X-R2-Part-Number":String(o)},body:n});return s.ok&&(await s.json()).etag||null}async function m(e,t,r){return(await fetch(e,{method:"POST",headers:{"Content-Type":"application/json","X-R2-Action":"abort-multipart"},body:JSON.stringify({key:t,uploadId:r})})).ok}async function y(e,t="",r=1e3){const o=await fetch(e,{method:"POST",headers:{"Content-Type":"application/json","X-R2-Action":"list"},body:JSON.stringify({prefix:t,limit:r})});return o.ok?u({objects:(await o.json()).objects||[]}):p(l(await o.text(),`List failed: ${o.status}`))}class w{constructor(e,t,r={}){this.workerEndpoint=e,this.bucketName=t,this.config=r}async upload(e,t,r={}){if(!(t instanceof File||t instanceof Blob))return{success:!1,error:"File must be a File or Blob object"};const o={contentType:r.contentType||t.type,cacheControl:r.cacheControl||"",onProgress:r.onProgress||null},n=await async function(e,t,r,o={}){const n=r.size;return i("uploadFile called:",{key:t,fileSize:n,useMultipart:n>h,hasOnProgress:!!o.onProgress}),n>h?async function(e,t,r,o={}){const n=r.size,s=o.contentType||r.type||"application/octet-stream",a=o.cacheControl||"",c=await async function(e,t,r,o){const n=await fetch(e,{method:"POST",headers:{"Content-Type":"application/json","X-R2-Action":"initiate-multipart"},body:JSON.stringify({key:t,contentType:r,cacheControl:o})});return n.ok&&(await n.json()).uploadId||null}(e,t,s,a);if(!c)return p("Failed to initiate multipart upload");const d=[],l=Math.ceil(n/g),h=o.onProgress||null;for(let o=1;o<=l;o++){const s=(o-1)*g,a=Math.min(s+g,n),u=r.slice(s,a),y=await u.arrayBuffer(),w=await f(e,t,c,o,y);if(!w)return await m(e,t,c),p(`Failed to upload part ${o}`);if(d.push({partNumber:o,etag:w}),h){const e=o*g,t=Math.min(e,n);i("uploadMultipart progress:",{partNumber:o,numParts:l,uploadedBytes:e,progressBytes:t,fileSize:n,percent:Math.round(t/n*100)}),h(t,n,null)}}const y=await async function(e,t,r,o){return(await fetch(e,{method:"POST",headers:{"Content-Type":"application/json","X-R2-Action":"complete-multipart"},body:JSON.stringify({key:t,uploadId:r,parts:o})})).ok}(e,t,c,d);return y?u():(await m(e,t,c),p("Failed to complete multipart upload"))}(e,t,r,o):async function(e,t,r,o={}){const n=o.contentType||r.type||"application/octet-stream",s=o.cacheControl||"",a=o.onProgress||null;return new Promise((o,c)=>{const d=new XMLHttpRequest;d.timeout=3e5,a&&d.upload.addEventListener("progress",e=>{if(e.lengthComputable){const t=Math.round(e.loaded/e.total*100);i("[Aether] uploadSingleWithProgress progress:",{loaded:e.loaded,total:e.total,percent:t}),a(e.loaded,e.total,t)}}),d.addEventListener("timeout",()=>{c(new Error("Upload timed out after 300000ms"))}),d.addEventListener("load",()=>{if(d.status>=200&&d.status<300)return void o(u());let e=`Upload failed: ${d.status}`;e=l(d.responseText,e),o(p(e))}),d.addEventListener("error",()=>{c(new Error("Upload failed: network error"))}),d.addEventListener("abort",()=>{c(new Error("Upload aborted"))}),d.open("POST",e),d.setRequestHeader("Content-Type","application/octet-stream"),d.setRequestHeader("X-R2-Key",t),d.setRequestHeader("X-R2-Content-Type",n),s&&d.setRequestHeader("X-R2-Cache-Control",s),d.send(r)})}(e,t,r,o)}(this.workerEndpoint,e,t,o);return n.success?{success:!0,url:this.getUrl(e)}:n}async delete(e){return async function(e,t){const r=await fetch(e,{method:"POST",headers:{"Content-Type":"application/json","X-R2-Action":"delete"},body:JSON.stringify({key:t})});return r.ok?u():p(l(await r.text(),`Delete failed: ${r.status}`))}(this.workerEndpoint,e)}async copy(e,t){return async function(e,t,r){const o=await fetch(e,{method:"POST",headers:{"Content-Type":"application/json","X-R2-Action":"copy"},body:JSON.stringify({sourceKey:t,destKey:r})});return o.ok?u():p(l(await o.text(),`Copy failed: ${o.status}`))}(this.workerEndpoint,e,t)}async exists(e){const t=await y(this.workerEndpoint,e,1);return!!t.success&&(t.objects||[]).some(t=>t.key===e)}async listObjects(e="",t=1e3){return y(this.workerEndpoint,e,t)}getUrl(e){return this.config.public_url?`${this.config.public_url.replace(/\/$/,"")}/${e}`:function(e,t,r){return`${e.replace(/\/$/,"")}/${t}/${r}`}(this.workerEndpoint,this.bucketName,e)}async batchCopy(e){return async function(e,t){const r=await fetch(e,{method:"POST",headers:{"Content-Type":"application/json","X-R2-Action":"batch-copy"},body:JSON.stringify({operations:t})});if(!r.ok)return p(l(await r.text(),`Batch copy failed: ${r.status}`));const o=await r.json();return u({copied:o.copied||0,errors:o.errors||0,results:o.results||[]})}(this.workerEndpoint,e)}async batchDelete(e){return async function(e,t){const r=await fetch(e,{method:"POST",headers:{"Content-Type":"application/json","X-R2-Action":"batch-delete"},body:JSON.stringify({keys:t})});return r.ok?u():p(l(await r.text(),`Batch delete failed: ${r.status}`))}(this.workerEndpoint,e)}async downloadManifest(e){const t=`${e}/file-manifest.json`;try{return await async function(e,t){const r=await fetch(e,{method:"POST",headers:{"Content-Type":"application/json","X-R2-Action":"download"},body:JSON.stringify({key:t})});if(!r.ok){if(404===r.status)return null;const e=await r.text();throw new Error(`Download failed: ${r.status} - ${e}`)}return r.blob()}(this.workerEndpoint,t)}catch(e){return null}}async uploadManifest(e,t){const r=`${e}/file-manifest.json`;return await this.upload(r,t,{contentType:"application/json"})}async testConnection(){const e=await this.listObjects("",1);return e.success?{success:!0,message:"Successfully connected to Cloudflare R2."}:{success:!1,error:e.error||"Failed to list objects"}}}const b="static_site",v="blueprint_bundle",k="edge_functions",_={[b]:(0,n.__)("Static Site","aether-site-exporter"),[v]:(0,n.__)("Blueprint Bundle","aether-site-exporter"),[k]:(0,n.__)("Edge Functions","aether-site-exporter")},I={[b]:(0,n.__)("Deploy static HTML/CSS/JS files for web hosting","aether-site-exporter"),[v]:(0,n.__)("Deploy WordPress Playground blueprint bundle (ZIP file)","aether-site-exporter"),[k]:(0,n.__)("Deploy serverless functions to edge computing platforms","aether-site-exporter")};async function x(e,t,r){if(t.required&&!e)return(0,n.sprintf)(/* translators: %s: Field label */ /* translators: %s: Field label */
(0,n.__)("%s is required.","aether-site-exporter"),t.label);if(!e)return null;if(t.validation){const o=t.validation;if(o.pattern&&!new RegExp(o.pattern).test(e))return o.message?o.message:(0,n.sprintf)(/* translators: %s: Field label */ /* translators: %s: Field label */
(0,n.__)("%s format is invalid.","aether-site-exporter"),t.label);if(void 0!==o.minLength&&e.length<o.minLength)return(0,n.sprintf)(/* translators: 1: Field label, 2: Minimum length */ /* translators: 1: Field label, 2: Minimum length */
(0,n.__)("%1$s must be at least %2$d characters.","aether-site-exporter"),t.label,o.minLength);if(void 0!==o.maxLength&&e.length>o.maxLength)return(0,n.sprintf)(/* translators: 1: Field label, 2: Maximum length */ /* translators: 1: Field label, 2: Maximum length */
(0,n.__)("%1$s must be no more than %2$d characters.","aether-site-exporter"),t.label,o.maxLength);if(o.callback&&"function"==typeof o.callback){const t=await o.callback(e,r);if("string"==typeof t)return t}}return null}function S(e,t){switch(t.type||"text"){case"password":case"text":case"textarea":default:return String(e).trim();case"email":return String(e).trim().toLowerCase();case"url":return String(e).trim().replace(/\/$/,"");case"checkbox":return Boolean(e);case"number":return Number(e)||0;case"select":return e;case"checkbox-group":return Array.isArray(e)?e:[]}}function E(e,t){return(t||[]).map(e=>e.value).includes(e)}function T(e,t){if(!Array.isArray(e))return[];const r=(t||[]).map(e=>e.value);return 0===r.length?e:e.filter(e=>r.includes(e))}class C{config={};registeredId=null;configStorage=null;constructor(e={},t=null){this.config=e,this.registeredId=t,this.initialize()}initialize(){}getId(){throw new Error("AbstractProvider.getId() must be implemented by subclass")}getName(){throw new Error("AbstractProvider.getName() must be implemented by subclass")}getType(){throw new Error("AbstractProvider.getType() must be implemented by subclass")}getDescription(){throw new Error("AbstractProvider.getDescription() must be implemented by subclass")}getIcon(){return"ðŸ“¦"}getSupportedDeploymentTypes(){return[]}getDeploymentTypesWithFilter(){const e=this.getSupportedDeploymentTypes();return(0,o.applyFilters)("aether.provider.supported_deployment_types",e,this.getId(),this)}supportsDeploymentType(e){return this.getDeploymentTypesWithFilter().includes(e)}getEnabledDeploymentTypes(){const e=this.config||{};return e.deployment_types&&Array.isArray(e.deployment_types)&&e.deployment_types.length>0?e.deployment_types:this.getSupportedDeploymentTypes()}isDeploymentTypeEnabled(e){return this.getEnabledDeploymentTypes().includes(e)}async getConfig(){return 0===Object.keys(this.config).length&&(this.config=await this.loadConfig()),(0,o.applyFilters)("aether.provider.config.get",this.config,this.getId())}async saveConfig(e){e=(0,o.applyFilters)("aether.provider.config.before_save",e,this.getId());const t=await this.validateConfig(e);if(Object.keys(t).length>0)throw new Error((0,n.sprintf)(/* translators: %s: JSON string of validation errors */ /* translators: %s: JSON string of validation errors */
(0,n.__)("Configuration validation failed: %s","aether-site-exporter"),JSON.stringify(t)));const r=await this.sanitizeConfig(e),s=await this.getConfigStorage(),i=await s.save(r);return i&&(this.config=r,(0,o.doAction)("aether.provider.config.saved",r,this.getId())),i}async deleteConfig(){(0,o.doAction)("aether.provider.config.before_delete",this.getId());const e=await this.getConfigStorage(),t=await e.delete();return t&&(this.config={},(0,o.doAction)("aether.provider.config.deleted",this.getId())),t}async isConfigured(){const e=await this.getConfig();return 0!==Object.keys(e).length&&function(e,t){for(const r of t)if(r.required&&!e[r.id])return!1;return!0}(e,this.getConfigFields())}async validateConfig(e){const t=await async function(e,t){const r={};for(const o of t){const t=o.id,n=e[t],s=await x(n,o,e);s&&(r[t]=s)}return r}(e,this.getConfigFields());return(0,o.applyFilters)("aether.provider.config.validate",t,e,this.getId())}async sanitizeConfig(e){const t=function(e,t){const r={};for(const o of t){const t=o.id;if(!(t in e))continue;const n=e[t],s=o.type||"text";"select"!==s?r[t]="checkbox-group"!==s?S(n,o):T(n,o.options):E(n,o.options)&&(r[t]=n)}return r}(e,this.getConfigFields());return(0,o.applyFilters)("aether.provider.config.sanitize",t,e,this.getId())}getConfigFields(){const e=[],t=function(e){const t=e.getSupportedDeploymentTypes();return t&&0!==t.length?{id:"deployment_types",type:"checkbox-group",label:(0,n.__)("Deployment Types","aether-site-exporter"),help:(0,n.__)("Select which types of deployments to use this provider for","aether-site-exporter"),required:!1,options:t.map(e=>({value:e,label:_[e]||e,description:I[e]||""})),defaultValue:t}:null}(this);t&&e.push(t);const r=this.getProviderSpecificConfigFields?.()||[];return e.push(...r),(0,o.applyFilters)("aether.provider.config_fields",e,this.getId(),this)}getProviderSpecificConfigFields(){return[]}async deploy(){return{success:!0,message:"No deployment needed for this provider."}}async getStatus(){const e=await this.isConfigured();return{configured:e,healthy:e}}getSettingsUrl(){return`admin.php?page=aether#/settings/provider/${this.getId()}`}getDocumentationUrl(){return`https://docs.aether.dev/providers/${this.getId()}`}getMetadata(){const e={id:this.getId(),name:this.getName(),type:this.getType(),description:this.getDescription(),icon:this.getIcon(),supportedDeploymentTypes:this.getDeploymentTypesWithFilter(),configFields:this.getConfigFields(),settingsUrl:this.getSettingsUrl(),documentationUrl:this.getDocumentationUrl()};return(0,o.applyFilters)("aether.provider.metadata",e,this.getId())}async getDeploymentUrl(){const e=await this.getConfig();let t="";return e.pages_url?t=e.pages_url:e.worker_endpoint?t=e.worker_endpoint:e.public_url&&(t=e.public_url),(0,o.applyFilters)("aether.provider.deployment_url",t,e,this.getId())}getUploadStrategy(){return"storage"}async uploadFile(e,t,r={}){throw new Error("AbstractProvider.uploadFile() must be implemented by subclass")}async loadConfig(){return(await this.getConfigStorage()).load()}async getConfigStorage(){if(!this.configStorage){const{ConfigStorage:e}=await Promise.resolve().then(r.bind(r,231));this.configStorage=new e(this.getId())}return this.configStorage}async getConfigValue(e,t=null){const r=await this.getConfig();return void 0!==r[e]?r[e]:t}async hasConfigValue(e){const t=await this.getConfig();return Boolean(t[e])}getFieldsById(e){const t=this.getConfigFields(),r={};return t.forEach(e=>{const t=e.id||e.name||"";t&&(r[t]=e)}),e.filter(e=>r[e]).map(e=>r[e])}renderSettings(e,t){return null}hasCustomSettings(){return this.renderSettings!==C.prototype.renderSettings}}class A extends C{getSupportedDeploymentTypes(){return[v,b]}storageService=null;getType(){return"cloud-storage"}getProviderSpecificConfigFields(){return[]}async getStorageService(){if(this.storageService)return this.storageService;const e=await this.getStorageEndpoint(),t=await this.getStorageServiceConfig();return e&&t.bucket_name?(this.storageService=new w(e,t.bucket_name,t),this.storageService):null}async getStorageEndpoint(){throw new Error("AbstractAWSProvider.getStorageEndpoint() must be implemented by subclass")}async getStorageServiceConfig(){throw new Error("AbstractAWSProvider.getStorageServiceConfig() must be implemented by subclass")}async testConnection(){throw new Error("AbstractAWSProvider.testConnection() must be implemented by subclass")}getPublicUrl(e){throw new Error("AbstractAWSProvider.getPublicUrl() must be implemented by subclass")}}var D=r(455),P=r.n(D);const $=new Map;function N(e){return`${e.method||"GET"}:${e.path||""}:${e.data?JSON.stringify(e.data):""}`}const F=(e,t)=>{const r=N(e);if($.has(r))return $.get(r);const o=t(e);return $.set(r,o),o.finally(()=>{$.delete(r)}),o},R=new Map,j={"/assets":6e5,"/settings":6e4,"/config":18e5,"/check-wporg":36e5};const B=(e,t)=>{if("GET"!==(e.method||"GET"))return t(e);const r=N(e),o=R.get(r);if(function(e,t){if(!e)return!1;const r=function(e){for(const[t,r]of Object.entries(j))if(e&&e.includes(t))return r;return 3e5}(t);return 0!==r&&Date.now()-e.timestamp<r}(o,e.path))return Promise.resolve(o.response);const n=t(e);return n.then(e=>(R.set(r,{response:e,timestamp:Date.now()}),e)).catch(e=>{throw e}),n};!function(){const e=function(){const e=document.querySelector('meta[name="aether-rest-url"]');return e&&e.getAttribute("content")||"/wp-json/aether/site-exporter/"}(),t=function(){const e=document.querySelector('meta[name="aether-rest-nonce"]');return e&&e.getAttribute("content")||""}();P().use(P().createRootURLMiddleware(e)),t&&function(e){P().use(P().createNonceMiddleware(e))}(t),P().use(B),P().use(F)}();const W=P(),O=Object.prototype.toString,q=new Set(["network error","Failed to fetch","NetworkError when attempting to fetch resource.","The Internet connection appears to be offline.","Network request failed","fetch failed","terminated"," A network error occurred.","Network connection lost"]);function U(e,t,{min:r=0,allowInfinity:o=!1}={}){if(void 0!==t){if("number"!=typeof t||Number.isNaN(t))throw new TypeError(`Expected \`${e}\` to be a number${o?" or Infinity":""}.`);if(!o&&!Number.isFinite(t))throw new TypeError(`Expected \`${e}\` to be a finite number.`);if(t<r)throw new TypeError(`Expected \`${e}\` to be â‰¥ ${r}.`)}}class L extends Error{constructor(e){super(),e instanceof Error?(this.originalError=e,({message:e}=e)):(this.originalError=new Error(e),this.originalError.stack=this.stack),this.name="AbortError",this.message=e}}function M(e,t){return Number.isFinite(t)?t-(performance.now()-e):t}async function z({error:e,attemptNumber:t,retriesConsumed:r,startTime:o,options:n}){const s=e instanceof Error?e:new TypeError(`Non-error was thrown: "${e}". You should only throw errors.`);if(s instanceof L)throw s.originalError;const i=Number.isFinite(n.retries)?Math.max(0,n.retries-r):n.retries,a=n.maxRetryTime??Number.POSITIVE_INFINITY,c=Object.freeze({error:s,attemptNumber:t,retriesLeft:i,retriesConsumed:r});if(await n.onFailedAttempt(c),M(o,a)<=0)throw s;const d=await n.shouldConsumeRetry(c),l=M(o,a);if(l<=0||i<=0)throw s;if(s instanceof TypeError&&!function(e){var t;if(!e||(t=e,"[object Error]"!==O.call(t))||"TypeError"!==e.name||"string"!=typeof e.message)return!1;const{message:r,stack:o}=e;return"Load failed"===r?void 0===o||"__sentry_captured__"in e:!!r.startsWith("error sending request for url")||q.has(r)}(s)){if(d)throw s;return n.signal?.throwIfAborted(),!1}if(!await n.shouldRetry(c))throw s;if(!d)return n.signal?.throwIfAborted(),!1;const u=function(e,t){const r=Math.max(1,e+1),o=t.randomize?Math.random()+1:1;let n=Math.round(o*t.minTimeout*t.factor**(r-1));return n=Math.min(n,t.maxTimeout),n}(r,n),p=Math.min(u,l);return p>0&&await new Promise((e,t)=>{const r=()=>{clearTimeout(o),n.signal?.removeEventListener("abort",r),t(n.signal.reason)},o=setTimeout(()=>{n.signal?.removeEventListener("abort",r),e()},p);n.unref&&o.unref?.(),n.signal?.addEventListener("abort",r,{once:!0})}),n.signal?.throwIfAborted(),!0}class K{constructor(e,t,r={},o="cloudflare"){this.accountId=e,this.apiToken=t,this.config=r,this.providerId=o,this.cloudflareApiBase="https://api.cloudflare.com/client/v4"}async cloudflareApiRequest(e,t={}){const r=`${this.cloudflareApiBase}${e}`,o={...function(e,t="Bearer"){return{Authorization:`${t} ${e}`,"Content-Type":"application/json"}}(this.apiToken),...t.headers||{}};try{const n=await async function(e,t={}){if(function(e){if("number"==typeof e){if(e<0)throw new TypeError("Expected `retries` to be a non-negative number.");if(Number.isNaN(e))throw new TypeError("Expected `retries` to be a valid number or Infinity, got NaN.")}else if(void 0!==e)throw new TypeError("Expected `retries` to be a number or Infinity.")}((t={...t}).retries),Object.hasOwn(t,"forever"))throw new Error("The `forever` option is no longer supported. For many use-cases, you can set `retries: Infinity` instead.");t.retries??=10,t.factor??=2,t.minTimeout??=1e3,t.maxTimeout??=Number.POSITIVE_INFINITY,t.maxRetryTime??=Number.POSITIVE_INFINITY,t.randomize??=!1,t.onFailedAttempt??=()=>{},t.shouldRetry??=()=>!0,t.shouldConsumeRetry??=()=>!0,U("factor",t.factor,{min:0,allowInfinity:!1}),U("minTimeout",t.minTimeout,{min:0,allowInfinity:!1}),U("maxTimeout",t.maxTimeout,{min:0,allowInfinity:!0}),U("maxRetryTime",t.maxRetryTime,{min:0,allowInfinity:!0}),t.factor>0||(t.factor=1),t.signal?.throwIfAborted();let r=0,o=0;const n=performance.now();for(;!Number.isFinite(t.retries)||o<=t.retries;){r++;try{t.signal?.throwIfAborted();const o=await e(r);return t.signal?.throwIfAborted(),o}catch(e){await z({error:e,attemptNumber:r,retriesConsumed:o,startTime:n,options:t})&&o++}}throw new Error("Retry attempts exhausted without throwing an error.")}(async()=>await fetch(r,{...t,headers:o}),{retries:3,minTimeout:1e3,maxTimeout:3e4,onFailedAttempt:t=>{c(`Cloudflare API request failed (${e}), retrying... (attempt ${t.attemptNumber})`,t.message)},shouldRetry:e=>"TypeError"===e.name&&e.message.includes("fetch")}),s=await n.json();if(!n.ok||!s.success){const t=l(JSON.stringify(s),"Cloudflare API request failed");return a(`Cloudflare API error (${e}):`,t),p(t,s.errors||[])}return u({result:s.result})}catch(t){return a(`Cloudflare API request failed (${e}):`,t),p(t.message||"Network request failed")}}async deploy(e,t,r={},o=!1){if(o){const t=this.generateWorkerName(e);return u({workerName:t+"-dry-run",workerUrl:this.getWorkerUrlFromName(t+"-dry-run")},"Dry run successful")}const n=this.generateWorkerName(e);if("r2"===e)try{const e=await W({path:"/aether/v1/providers/cloudflare-r2/deploy-worker",method:"POST",data:{worker_name:n,script:t,bindings:r}});return e.success?u({workerName:e.worker_name,workerUrl:e.worker_url}):p(e.error||"Worker deployment failed")}catch(e){return p(e.message||"Worker deployment failed")}try{const e=new FormData,o=new Blob([t],{type:"application/javascript+module"});e.append("worker.js",o,"worker.js");const s={main_module:"worker.js",bindings:[]};for(const[e,t]of Object.entries(r))"r2_bucket"===t.type&&s.bindings.push({type:"r2_bucket",name:e,bucket_name:t.bucket_name});e.append("metadata",new Blob([JSON.stringify(s)],{type:"application/json"}),"metadata.json");const i=`/accounts/${this.accountId}/workers/scripts/${n}`,a=await this.cloudflareApiRequest(i,{method:"PUT",body:e});if(!a.success)return p(a.error||"Worker deployment failed");const c=this.getWorkerUrlFromName(n);return await this.enableWorkersDevSubdomain(n),u({workerName:n,workerUrl:c})}catch(e){return p(e.message||"Worker deployment failed")}}async enableWorkersDevSubdomain(e){try{const t=`/accounts/${this.accountId}/workers/subdomain`,r=await this.cloudflareApiRequest(t,{method:"GET"});if(!r.success)return c("Failed to get workers.dev subdomain:",r.error),p(r.error);const o=r.data?.result?.subdomain;if(!o)return c("No workers.dev subdomain configured"),p("No subdomain configured");const n=`/accounts/${this.accountId}/workers/scripts/${e}/subdomain`,s=await this.cloudflareApiRequest(n,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({enabled:!0})});return s.success?u():(c("Failed to enable workers.dev subdomain:",s.error),p(s.error))}catch(e){return c("Error enabling workers.dev subdomain:",e),p(e.message)}}async testDeployment(e,t=""){if(!t)return u({deployed:!1},"Worker not deployed");try{const e=await this.listWorkers();if(!e.success)return p(e.error||"Failed to verify API token permissions")}catch(e){return p(e.message||"Token permission test failed")}const r=this.extractWorkerNameFromUrl(t);if(r)try{if((await this.getWorker(r)).success)return u({deployed:!0,workerUrl:t},"Worker is deployed and accessible")}catch(e){}return u({deployed:!0,workerUrl:t},"Worker URL provided but verification failed")}async listWorkers(){const e=`/accounts/${this.accountId}/workers/scripts`,t=await this.cloudflareApiRequest(e,{method:"GET"});return t.success?u({workers:t.data?.result||[]}):p(t.error||"Failed to list workers")}async getWorker(e){const t=`/accounts/${this.accountId}/workers/scripts/${e}`,r=await this.cloudflareApiRequest(t,{method:"GET"});return r.success?u({worker:r.data?.result}):p(r.error||"Failed to get worker info")}async getZoneIdForHostname(e){const t=`/zones?name=${encodeURIComponent(e)}`,r=await this.cloudflareApiRequest(t,{method:"GET"});if(!r.success)return p(r.error||"Failed to get zone ID");const o=r.data?.result||[];return 0===o.length?p(`No zone found for hostname: ${e}`):u({zoneId:o[0].id,zoneName:o[0].name})}async attachWorkerToCustomDomain(e,t,r){const o=t.replace(/^https?:\/\//,"").replace(/\/.*$/,""),n=`/accounts/${this.accountId}/workers/domains`,s=await this.cloudflareApiRequest(n,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({environment:"production",hostname:o,service:e,zone_id:r,override_existing_dns_record:!0})});return s.success?u(null,`Worker attached to ${o}`):p(s.error||"Failed to attach worker to custom domain")}async testConnection(e=""){const t={success:!0,workersApi:!1,r2Access:!1,errors:[]};try{const e=await this.listWorkers();e.success?t.workersApi=!0:(t.errors.push(`Workers API: ${e.error}`),t.success=!1)}catch(e){t.errors.push(`Workers API: ${e.message}`),t.success=!1}if(e)try{const r="connection-test-"+Date.now(),o=`${e.replace(/\/+$/,"")}/${r}/test.html`,n=await fetch(o,{method:"GET"});404===n.status||n.ok?t.r2Access=!0:(t.errors.push(`R2 Worker: HTTP ${n.status}`),t.success=!1)}catch(e){t.errors.push(`R2 Worker: ${e.message}`),t.success=!1}return t}getWorkerUrl(){return this.config.worker_endpoint||""}isDeployed(e){return!!this.getWorkerUrl(e)}async getWorkerScript(e=null,t=""){if(!t&&e&&(t=e,e=null),!t)return c("Worker type is required to fetch script"),"";const r=e||this.providerId;try{const e=await W({path:`/aether/v1/providers/${r}/edge/worker-script/${t}`,method:"GET"});return"string"==typeof e?e:(c("Failed to fetch worker script: unexpected response format"),"")}catch(e){return a("Error fetching worker script:",e),""}}getWorkerBindings(e,t){if("r2"===e){const e=t.bucket_name||"";return e?{R2_BUCKET:{type:"r2_bucket",bucket_name:e}}:{}}return{}}generateWorkerName(e){return`aether-${e}-${Math.random().toString(36).substring(2,10)}`}getWorkerUrlFromName(e){return`https://${e}.workers.dev`}extractWorkerNameFromUrl(e){const t=e.match(/https?:\/\/([^.]+)\.workers\.dev/);return t?t[1]:null}}class J extends A{static ID="cloudflare-r2";getSupportedDeploymentTypes(){return[b,v]}requiresWorker=!0;workerType="r2";edgeService=null;storageService=null;getId(){return this.registeredId||J.ID}getName(){return(0,n.__)("Cloudflare R2","aether")}getType(){return"cloud-storage"}getDescription(){return(0,n.__)("Cloudflare R2 object storage with zero egress fees. Includes edge worker deployment for WordPress Playground compatibility.","aether")}getIcon(){return"â˜ï¸"}getProviderSpecificConfigFields(){return[{id:"cloudflare_account_id",label:(0,n.__)("Cloudflare Account ID","aether"),type:"text",required:!0,sensitive:!0,hidden:!0,validation:{pattern:"^[a-f0-9]{32}$",message:(0,n.__)("Account ID must be a 32-character hexadecimal string","aether")}},{id:"access_key_id",label:(0,n.__)("Access Key ID","aether"),type:"text",required:!0,sensitive:!0,validation:{minLength:16,maxLength:128,message:(0,n.__)("Access Key ID must be between 16 and 128 characters","aether")}},{id:"secret_access_key",label:(0,n.__)("Secret Access Key","aether"),type:"text",required:!0,sensitive:!0,validation:{minLength:32,maxLength:128,message:(0,n.__)("Secret Access Key must be between 32 and 128 characters","aether")}},{id:"bucket_name",label:(0,n.__)("Bucket Name","aether"),type:"text",required:!0,sensitive:!1,validation:{pattern:"^[a-z0-9][a-z0-9-]{1,61}[a-z0-9]$",minLength:3,maxLength:63,message:(0,n.__)("Bucket name must be 3-63 characters, start and end with alphanumeric, and contain only lowercase letters, numbers, and hyphens","aether")}},{id:"region",label:(0,n.__)("Region (Optional)","aether"),type:"text",required:!1,sensitive:!1,isAdvanced:!0},{id:"endpoint",label:(0,n.__)("Endpoint URL (Optional)","aether"),type:"url",required:!1,sensitive:!1,isAdvanced:!0},{id:"worker_endpoint",label:(0,n.__)("Worker Endpoint URL","aether"),type:"url",required:!1,sensitive:!1,isAdvanced:!0,help:(0,n.__)("URL of the deployed Cloudflare Worker that handles file uploads","aether")},{id:"custom_domain",label:(0,n.__)("Custom Domain (Optional)","aether"),type:"url",required:!1,sensitive:!1,isAdvanced:!0},{id:"public_access",label:(0,n.__)("Enable Public Access","aether"),type:"checkbox",required:!1,sensitive:!1,isAdvanced:!0,default:!1}]}getDependencies(){return["cloudflare"]}async getStatus(){const e=await super.getStatus(),t=await this.getConfig();return e.deployed=Boolean(t.worker_endpoint),e}async getEdgeService(){if(this.edgeService)return this.edgeService;const e=await this.getConfig(),t=(await W({path:"/aether/site-exporter/settings"})).settings||{},r=t.providers?.cloudflare||{},o=r.account_id||"",n=r.api_token||"";return o&&n?(this.edgeService=new K(o,n,e),this.edgeService):null}async getStorageEndpoint(){return(await this.getConfig()).worker_endpoint||""}async getStorageServiceConfig(){const e=await this.getConfig();return{worker_endpoint:e.worker_endpoint||"",bucket_name:e.bucket_name||"",custom_domain:e.custom_domain||"",public_access:e.public_access||!1,...e}}async testConnection(){const e=await this.getStorageService();return e?await e.testConnection():{success:!1,error:(0,n.__)("Storage service not available. Please configure worker_endpoint and bucket_name.","aether")}}async uploadFile(e,t,r={}){try{const o=await this.getStorageService();if(!o)return{success:!1,error:(0,n.__)("Storage service not available. Please configure worker_endpoint and bucket_name.","aether")};let s;if(!e.startsWith("http://")&&!e.startsWith("https://"))return{success:!1,error:(0,n.__)("Local file upload not yet implemented for R2","aether")};{const r=await fetch(e);if(!r.ok)return{success:!1,error:(0,n.__)("Failed to fetch file from URL","aether")};const o=await r.blob();s=new File([o],t,{type:o.type})}const i=await o.upload(t,s,{contentType:s.type,onProgress:r.onProgress||null});return i.success?{success:!0,url:this.getPublicUrl(t)||i.url||"",path:t,message:(0,n.__)("File uploaded successfully","aether")}:i}catch(e){return{success:!1,error:e.message||(0,n.__)("File upload failed","aether")}}}getPublicUrl(e){const t=this.config;return t.custom_domain?`${t.custom_domain}/${e}`:t.public_url?`${t.public_url}/${e}`:t.worker_endpoint?`${t.worker_endpoint}/${e}`:""}}const X=window.wp.element,G=window.wp.components,V=window.ReactJSXRuntime;function H({providerId:e,config:t,onChange:r}){const[o,s]=(0,X.useState)(!1),[i,a]=(0,X.useState)(null),[c,d]=(0,X.useState)(!1),[l,u]=(0,X.useState)(null);return(0,V.jsxs)("div",{style:{marginTop:"1rem",paddingTop:"1rem",borderTop:"1px solid #ddd"},children:[(0,V.jsx)(G.Button,{variant:"secondary",onClick:async()=>{s(!0),a(null),d(!1),u(null);try{if(!t?.access_key_id||!t?.secret_access_key||!t?.bucket_name)throw new Error((0,n.__)("Access Key ID, Secret Access Key, and Bucket Name are required","aether-site-exporter-providers"));const o=(await W({path:"/aether/site-exporter/settings"})).settings||{},s=o.providers?.cloudflare||{};if(!s.account_id||!s.api_token)throw new Error((0,n.__)("Cloudflare Workers provider must be configured first. Please configure the Cloudflare Workers (edge) provider with Account ID and API Token.","aether-site-exporter-providers"));const i=window.wpApiSettings?.root||"/wp-json",a=document.querySelector('meta[name="aether-rest-nonce"]')?.getAttribute("content")||window.wpApiSettings?.nonce||"",c=`aether-r2-${Math.random().toString(36).substring(2,10)}`,l={};t.bucket_name&&(l.R2_BUCKET={type:"r2_bucket",bucket_name:t.bucket_name});const p=`${i}/aether/site-exporter/providers/cloudflare/deploy-worker`,h=await fetch(p,{method:"POST",headers:{"X-WP-Nonce":a,"Content-Type":"application/json"},body:JSON.stringify({worker_type:"r2",worker_name:c,bindings:l,account_id:s.account_id,api_token:s.api_token})});if(!h.ok){const e=await h.json().catch(()=>({message:`HTTP ${h.status}: ${h.statusText}`}));throw new Error(e.message||e.error||(0,n.__)("Failed to deploy worker","aether-site-exporter-providers"))}const g=await h.json();if(!g.success)throw new Error(g.message||g.error||(0,n.__)("Failed to deploy worker","aether-site-exporter-providers"));if(g.worker_url){r&&"function"==typeof r&&r("worker_endpoint",g.worker_url);try{await W({path:`/aether/site-exporter/providers/${e}/config`,method:"PUT",data:{worker_endpoint:g.worker_url}})}catch(e){console.error("Failed to save worker endpoint:",e)}}d(!0),u(g.worker_url||null),setTimeout(()=>{d(!1)},1e4)}catch(e){a(e.message||(0,n.__)("Failed to deploy worker","aether-site-exporter-providers"))}finally{s(!1)}},isBusy:o,disabled:o||!t?.access_key_id||!t?.secret_access_key||!t?.bucket_name,children:o?(0,n.__)("Deployingâ€¦","aether-site-exporter-providers"):(0,n.__)("Deploy Worker","aether-site-exporter-providers")}),i&&(0,V.jsx)(G.Notice,{status:"error",isDismissible:!1,style:{marginTop:"0.5rem"},children:i}),c&&(0,V.jsxs)(G.Notice,{status:"success",isDismissible:!1,style:{marginTop:"0.5rem"},children:[(0,n.__)("Worker deployed successfully!","aether-site-exporter-providers"),l&&(0,V.jsxs)("div",{style:{marginTop:"0.5rem"},children:[(0,V.jsx)("strong",{children:(0,n.__)("Worker URL:","aether-site-exporter-providers")})," ",(0,V.jsx)("a",{href:l,target:"_blank",rel:"noopener noreferrer",children:l})]})]})]})}const Y=new Map,Z=new Map,Q=new Map,ee=new class{register(e,t){if(!e||"string"!=typeof e)throw new Error("ProviderRegistry.register() requires a valid provider ID string");if(!t||"object"!=typeof t)throw new Error("ProviderRegistry.register() requires a provider instance");if("function"!=typeof t.getId)throw new Error(`Provider ${e} must implement getId() method`);if("function"!=typeof t.getName)throw new Error(`Provider ${e} must implement getName() method`);Q.set(e,t),(0,o.doAction)("aether.providers.registered",e,t)}get(e){return Q.get(e)||null}getAll(){return Array.from(Q.values())}getAllIds(){return Array.from(Q.keys())}getByDeploymentType(e){return this.getAll().filter(t=>(t.getSupportedDeploymentTypes?.()||[]).includes(e))}getDefault(){const e=this.getByDeploymentType("static_site");if(e.length>0)return e[0];const t=this.getAll();return t.length>0?t[0]:null}getForDeploymentType(e){const t=this.getByDeploymentType(e);return t.length>0?t[0]:null}has(e){return Q.has(e)}count(){return Q.size}parseInstanceId(e){if(!e||"string"!=typeof e)return null;const t=e.split(":",2);return 2===t.length&&t[0]&&t[1]?{provider_type:t[0],uuid:t[1]}:null}getProviderForInstance(e){const t=this.parseInstanceId(e);return t?this.get(t.provider_type):null}createInstanceId(e){return`${e}:${"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{const t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)})}`}clear(){Q.clear()}};(0,o.addAction)("aether.providers.register","aether/provider-registry",e=>{if(!e||"object"!=typeof e)return;let t;if("function"==typeof e.getId)t=e.getId();else{if(!e.id)return;t=e.id}ee.register(t,e)});let te=ee;if("undefined"!=typeof window)if(window.aether=window.aether||{},window.aether.ProviderRegistry){const e=window.aether.ProviderRegistry;Array.from(Q.values()).forEach(t=>{const r=t.getId();e.get(r)||e.register(r,t)}),te=e,console.log("ProviderRegistry: Using global registry instance,",e.getAll().length,"providers registered")}else window.aether.ProviderRegistry=ee,console.log("ProviderRegistry: Created global registry instance");const re=te,oe=new J;console.log("CloudflareR2Provider: Registering provider...",oe.getId()),re.register(oe.getId(),oe),console.log("CloudflareR2Provider: Provider registered successfully"),(0,o.doAction)("aether.providers.register",oe),(0,o.addAction)("aether.file.upload","aether/cloudflare-r2",e=>{e._uploadPromises||(e._uploadPromises=[]),e._uploadPromises.push(async function(e){const{fileType:t,providerId:r,filePath:o,fileContent:n,contentType:s,storageKey:i}=e;if(r&&r.startsWith("cloudflare-r2"))try{const r=await oe.getStorageService();if(!r)throw new Error("Storage service not available. Please configure worker_endpoint and bucket_name.");if("blueprint-bundle"===t){if(!o)throw new Error("Blueprint bundle file path is required");if(!o.startsWith("http://")&&!o.startsWith("https://"))throw new Error("Blueprint bundle must be provided as a URL for R2 uploads");const t=await fetch(o,{method:"GET",credentials:"omit"});if(!t.ok)throw new Error(`Failed to fetch blueprint bundle: HTTP ${t.status}`);const n=i||"blueprint-bundle/bundle.zip",s=await r.upload(n,await t.blob(),{contentType:"application/zip"});if(!s.success)throw new Error(s.error||"Blueprint bundle upload failed");return void(e.result={success:!0,url:s.url})}let a=null;if(n)"string"==typeof n?a=new Blob([n],{type:s||"text/html"}):n instanceof Blob&&(a=n);else if(o?.startsWith("http://")||o?.startsWith("https://")){const e=await fetch(o,{method:"GET",credentials:"omit"});if(!e.ok)throw new Error(`Failed to fetch ${o}: HTTP ${e.status}`);a=await e.blob()}if(!a)throw new Error("File content or valid URL is required");let c=i;if(!c&&o)if(o.startsWith("http://")||o.startsWith("https://"))try{c=new URL(o).pathname}catch{c=o}else c=o;c=c?.replace(/^\/+/,"")||"index.html",c.endsWith("/")?c=c.replace(/\/+$/,"")+"/index.html":/\.[a-zA-Z0-9]+$/.test(c)||(c+="/index.html");const d=await r.upload(c,a,{contentType:s||"text/html"});if(!d.success)throw new Error(d.error||"Upload failed");e.result={success:!0,url:d.url}}catch(t){e.result={success:!1,error:t.message||"Unknown error"}}}(e))},10),(0,o.addFilter)("aether.provider.test","aether/cloudflare-r2",(e,t,r)=>t?.startsWith("cloudflare-r2")?async e=>oe.testConnection(e||r):e,10),(0,o.addFilter)("aether.provider.upload_strategy","aether/cloudflare-r2",(e,t)=>t?.startsWith("cloudflare-r2")?"worker":e,10),(0,o.addAction)("aether.provider.form.after_fields","aether-site-exporter-providers/cloudflare-r2/deploy-button",e=>{if("cloudflare-r2"!==e.providerId)return;const t=document.querySelector(`.aether-provider-form__after-fields[data-provider-id="${e.providerId}"]`);if(!t)return;const r=Y.get(e.providerId),o=Z.get(e.providerId);if(r){try{r.unmount()}catch(e){o&&o.parentNode&&o.parentNode.removeChild(o)}Y.delete(e.providerId),Z.delete(e.providerId)}const n=document.createElement("div");t.appendChild(n);const s=(0,X.createRoot)(n);Y.set(e.providerId,s),Z.set(e.providerId,n),s.render((0,V.jsx)(H,{providerId:e.providerId,config:e.values,onChange:e.onChange}))})})();